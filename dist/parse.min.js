define(["require","exports","nu/stream","seshat"],function(ba,c,j,E){var t,f,l,u,v,r,i,k,F,p,w,G,n,A,L,y,ca,M,da,H,N,O,P,Q,z,R,B,s,S,T,U,ea,e,I,J,V,C,W,X,Y,Z,$;s=j.end;var la=j.first,ma=j.isEmpty,na=j.rest,oa=Function.prototype.call.bind(Array.prototype.map),aa=Function.prototype.call.bind(Array.prototype.reduceRight),x=function(a){return function(){return a}},fa=Math.random,q=function(a,b){var d=[a,b];d._next=!0;return d};e=function(a,b){this.memoer=a;this.frames=b};e.empty=new e(E.create(function(a,
b){return a.compare(b)},function(a,b){return a.id===b.id&&(a.state===b.state||a.state&&a.state.eq(b.state))}),[]);e.pushWindow=function(a,b){return new e(a.memoer,[b].concat(a.frames))};e.popWindow=function(a){return new e(1===a.frames.length?E.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};e.lookup=function(a,b,d){return E.lookup(a.memoer,b,d)};e.update=function(a,b,d,c){return new e(E.update(a.memoer,b,d,c),a.frames)};k=function(a){this.index=a};k.initial=new k(0);k.prototype.toString=
function(){return""+this.index};k.prototype.increment=function(){return new k(this.index+1)};k.prototype.compare=function(a){return this.index-a.index};i=function(a,b,d){this.input=a;this.position=b;this.userState=d};i.prototype.eq=function(a){return a&&this.input===a.input&&this.userState===a.userState};i.prototype.isEmpty=function(){return ma(this.input)};i.prototype.first=function(){return la(this.input)};i.prototype.next=function(a){if(!this._next){var b=new i(na(this.input),this.position.increment(a),
this.userState);this._next=function(d,c,g){return g(a,b,c)}}return this._next};i.prototype.setInput=function(a){return new i(a,this.position,this.userState)};i.prototype.setPosition=function(a){return new i(this.input,a,this.userState)};i.prototype.setUserState=function(a){return new i(this.input,this.position,a)};t=function(a){this.message=a};t.prototype=Error();t.prototype.constructor=t;t.prototype.name="ParserError";f=function(a,b){this.position=a;this._msg=b};f.prototype=Error();f.prototype.constructor=
f;f.prototype.name="ParseError";f.prototype.toString=function(){return this.name+": "+this.message};Object.defineProperties(f.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});l=function(a,b){f.call(this,a);this.errors=b||[]};l.prototype=new f;l.prototype.constructor=l;l.prototype.name="MultipleError";Object.defineProperty(l.prototype,"errorMessage",{get:function(){return"["+
oa(this.errors,function(a){return a.message}).join(", ")+"]"}});var D=function(a,b,d){f.call(this,a);this._pErr=b;this._qErr=d};D.prototype=new l;D.prototype.constructor=l;D.prototype.name="ChoiceError";Object.defineProperty(D.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});u=function(a){f.call(this,a)};u.prototype=new f;u.prototype.constructor=u;u.prototype.name="UnknownError";Object.defineProperty(u.prototype,"errorMessage",{value:"unknown error"});v=function(a,
b){f.call(this,a);this.unexpected=b};v.prototype=new f;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});r=function(a,b,d){f.call(this,a);this.expected=b;this.found=d};r.prototype=new f;r.prototype.constructor=r;r.prototype.name="ExpectError";Object.defineProperty(r.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});F=function(a){var b=
a(function(){return b.apply(this,arguments)});return b};p=function(a,b){return b.hasOwnProperty("parserId")?p(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:fa(),writable:!1}})};w=function(a){return function(b,d,c,g,h){return h(a,b,d)}};G=function(a){return function(b,d,c,g,h,e){return e(a,b,d)}};n=function(a,b){return function(d,c,g,h,e,m){return q(a,[d,c,function(a,d,c){return q(b(a,d,c),[d,c,g,h,g,h])},h,function(a,d,c){return q(b(a,
d,c),[d,c,g,h,e,m])},m])}};y=function(a){return function(b,d,c,g,h){b=a(b);return h(b,b,d)}};L=p("Get Parser State",y(function(a){return a}));A=function(a){return function(b,d,c,g,h){return h(a(b),b,d)}};M=function(a){return y(function(b){return b.setUserState(a(b.userState))})};ca=p("Get State",A(function(a){return a.userState}));H=p("Get Position",A(function(a){return a.position}));da=p("Get Input",A(function(a){return a.input}));var ga=function(a){return n(H,function(b){return G(a(b))})};var qa=
w(s),ba=p("EOF",n(L,function(a){return a.isEmpty()?qa:ga(function(b){return new r(b,"end of input",a.first())})}));N=function(a,b){return n(a,x(b))};var ra=function(a,b){return N(b,a)};O=function(a){return aa(a,ra)};z=function(a){return function(b,d){return function(c,g,h,e,m,pa){var K=c.position;return q(b,[c,g,h,e,m,function(b,g,f){return q(d,[c,f,h,e,m,function(d,g,h){return pa(a(K,b,d),c,h)}])}])}}};P=z(function(a,b,d){return new l(a,[b,d])});var sa=z(function(a,b,d){return new D(a,b,d)}),ta=
function(a,b){return sa(b,a)},ua=n(H,function(a){return G(new l(a,[]))});Q=function(a){if(!a.length)throw new t("choice called no parsers");return aa(a,ta,ua)};z=function(a,b){return P(b,w(a))};var va=w(s),ha=z.bind(null,s);s=function(a){return function(b,d){return n(b,function(b){return n(d,function(d){return w(a(b,d))})})}};var wa=function(a){return w(j.toArray(a))};R=function(a){return n(a,wa)};B=s(j.cons);s=s(j.append);var xa=function(a,b){return B(b,a)};S=function(a){return aa(a,xa,va)};var ia,
ya=new t("Many parser applied to a parser that accepts an empty string");ia=function(){throw ya;};T=function(a){var b=function(b,c,g,h,e,m){return q(a,[b,c,g,h,ia,m])};return F(function(a){return ha(B(b,a))})};var za=function(a,b){return new v(a,null===b?"end of input":b)};U=function(a,b){var c=b||za;return function(b,g,h,e,m,f){var K=b.position;if(b.isEmpty())return f(c(K,null),b,g);var i=b.first();return a(i)?b.next(i)(b,g,h,e,m,f):f(c(K,i),b,g)}};ea=p("Any Token",U(x(!0)));I=function(a,b,c,e,g,
h,f){for(a=a(b,c,e,g,h,f);a&&a._next;)a=a[0].apply(void 0,a[1]);return a};J=function(a,b,c,f){return I(a,b,e.empty,c,f,c,f)};V=function(a,b,c,e,g){return J(a,new i(b,k.initial,c),e,g)};var Aa=function(a){return a},Ba=function(a){throw a;};C=function(a,b){return J(a,b,Aa,Ba)};W=function(a,b,c){return C(a,new i(b,k.initial,c))};X=function(a,b){var c;var e=ha(n(a,function(a,b,c){return w(j.memoStream(a,C.bind(null,e,b,c)))}));c=C(e,b);return c};Y=function(a,b,c){return X(a,new i(b,k.initial,c))};var ja=
x(x(!0)),ka=x(x(!1));Z=function(a,b){return I(a,b,e.empty,ja,ka,ja,ka)};$=function(a,b,c){return Z(a,new i(b,k.initial,c))};c.ParserError=t;c.ParseError=f;c.MultipleError=l;c.UnknownError=u;c.UnexpectError=v;c.ExpectError=r;c.ParserState=i;c.Position=k;c.rec=F;c.Parser=p;c.RecParser=function(a,b){return p(a,F(b))};c.always=w;c.never=G;c.bind=n;c.eof=ba;c.extract=A;c.getParserState=L;c.setParserState=function(a){return y(x(a))};c.modifyParserState=y;c.getState=ca;c.setState=function(a){return M(x(a))};
c.modifyState=M;c.getInput=da;c.setInput=function(a){return y(function(b){return b.setInput(a)})};c.getPosition=H;c.setPosition=function(a){return y(function(b){return b.setPosition(a)})};c.fail=function(a){var b;var c=a?f:u;b=ga(function(b){return new c(b,a)});return b};c.attempt=function(a){return function(b,c,f,g,h,i){g=function(a,b,c){return i(a,b,e.popWindow(c))};return q(a,[b,e.pushWindow(c,b.position),function(a,b,c){return f(a,b,e.popWindow(c))},g,function(a,b,c){return h(a,b,e.popWindow(c))},
g])}};c.lookahead=function(a){return function(b,c,e,g,h,f){return q(a,[b,c,function(a,c,d){return h(a,b,d)},g,h,f])}};c.next=N;c.sequencea=O;c.sequence=function(){return O(arguments)};c.either=P;c.choicea=Q;c.choice=function(){return Q(arguments)};c.optional=z;c.expected=function(a,b){return function(c,e,g,f,i,m){return b(c,e,g,f,i,function(b,c,d){return m(new r(c.position,a),c,d)})}};c.eager=R;c.binds=function(a,b){return n(R(a),function(a){return b.apply(void 0,a)})};c.cons=B;c.append=s;c.enumerationa=
S;c.enumeration=function(){return S(arguments)};c.many=T;c.many1=function(a){return B(a,T(a))};c.token=U;c.anyToken=ea;c.memo=function(a){var b=a.parserId||fa();return function(c,f,g,h,i,m){var j=c.position,k={id:b,state:c},l=e.lookup(f,j,k);return l?q(l,[c,f,g,h,i,m]):q(a,[c,f,function(a,b,c){return g(a,b,e.update(c,j,k,function(c,d,e){return e(a,b,d)}))},function(a,b,c){return h(a,b,e.update(c,j,k,function(c,d,e,f){return f(a,b,d)}))},function(a,b,c){return i(a,b,e.update(c,j,k,function(c,d,e,f,
g){return g(a,b,d)}))},function(a,b,c){return m(a,b,e.update(c,j,k,function(c,d,e,f,g,h){return h(a,b,d)}))}])}};c.Memoer=e;c.exec=I;c.parseState=J;c.parseStream=V;c.parse=function(a,b,c,e,f){return V(a,j.from(b),c,e,f)};c.runState=C;c.runStream=W;c.run=function(a,b,c){return W(a,j.from(b),c)};c.runManyState=X;c.runManyStream=Y;c.runMany=function(a,b,c){return Y(a,j.from(b),c)};c.testState=Z;c.testStream=$;c.test=function(a,b,c){return $(a,j.from(b),c)}});
