define(["nu/stream"],function(i){var Q=Function.prototype.call.bind(Array.prototype.map),R=Function.prototype.call.bind(Array.prototype.reduceRight),A=function(a){return a.bind.apply(a,arguments)},k=function(a){return function(){return a}},J=function(a){return function(){throw a;}},S=function(a,b){return a===b},m=function(a,b){var c=[a,b];c._next=!0;return c},r=function(a,b,c,d){this.id=a;this.state=b;this.val=c;this.delegate=d};r.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;
return null};r.update=function(a,b,c,d){return new r(b,c,d,a)};var p=function(a){this.index=a};p.initial=new p(0);p.prototype.increment=function(){return new p(this.index+1)};p.prototype.toString=function(){return""+this.index};p.prototype.compare=function(a){return this.index-a.index};var l=function(a,b,c){this.input=a;this.position=b;this.userState=c};l.prototype.next=function(a){this._next||(this._next=new l(i.rest(this.input),this.position.increment(a),this.userState));return this._next};l.prototype.eq=
function(a){return 0===this.position.compare(a.position)};l.prototype.setInput=function(a){return new l(a,this.position,this.userState)};l.prototype.setPosition=function(a){return new l(this.input,a,this.userState)};l.prototype.setUserState=function(a){return new l(this.input,this.position,a)};var u=function(a){this.message=a};u.prototype=Error();u.prototype.constructor=u;u.prototype.name="ParserError";var h=function(a,b){this.position=a;this._msg=b};h.prototype=Error();h.prototype.constructor=h;
h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var q=function(a,b){h.call(this,a);this.errors=b||[]};q.prototype=new h;q.prototype.constructor=q;q.prototype.name="MultipleError";Object.defineProperty(q.prototype,"errorMessage",{get:function(){return"["+Q(this.errors,function(a){return a.message}).join(", ")+
"]"}});var x=function(a,b,c){h.call(this,a);this._pErr=b;this._qErr=c};x.prototype=new q;x.prototype.constructor=q;x.prototype.name="ChoiceError";Object.defineProperty(x.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var v=function(a){h.call(this,a)};v.prototype=new h;v.prototype.constructor=v;v.prototype.name="UnknownError";Object.defineProperty(v.prototype,"errorMessage",{value:"unknown error"});var w=function(a,b){h.call(this,a);this.unexpected=b};w.prototype=
new h;w.prototype.constructor=w;w.prototype.name="UnexpectError";Object.defineProperty(w.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var s=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};s.prototype=new h;s.prototype.constructor=s;s.prototype.name="ExpectError";Object.defineProperty(s.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var K=function(a){var b=a(function(){return b.apply(this,
arguments)});return b},B=function(a,b){return b.hasOwnProperty("parserId")?B(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},t=function(a){return function(b,c,d,f,e){return e(a,b,c)}},C=function(a){return function(b,c,d,f,e,g){return g(a,b,c)}},n=function(a,b){return function(c,d,f,e,g,j){return m(a,[c,d,function(a,c,d){return m(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return m(b(a,c,d),[c,d,
f,e,g,j])},j])}},y=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},fa=k(y(function(a){return a})),L=function(a){return function(b,c,d,f,e){b=a(b);return e(b,b,c)}},ga=k(y(function(a){return a.userState})),M=function(a){return function(b,c,d,f,e){b=b.setUserState(a(b.userState));return e(b,b,c)}},D=k(y(function(a){return a.position})),T=k(y(function(a){return a.input})),U=function(a,b){return n(a,k(b))},z=function(a){return function(b,c){return function(d,f,e,g,j,da){var ea=d.position;
return m(b,[d,f,e,g,j,function(b,f,h){return m(c,[d,h,e,g,j,function(c,e,f){return da(a(ea,b,c),d,f)}])}])}}},V=z(function(a,b,c){return new q(a,[b,c])}),ha=z(function(a,b,c){return new x(a,b,c)}),ia=function(a,b){return ha(b,a)},ja=n(D(),function(a){return C(new q(a,[]))}),z=function(a,b){return V(b,t(a))},ka=t(i.end),W=A(z,i.end),E=function(a){return function(b,c){return n(b,function(b){return n(c,function(c){return t(a(b,c))})})}},N,la=function(a){return t(i.toArray(a))};N=function(a){return n(a,
la)};var F=E(i.cons),E=E(i.append),ma=function(a,b){return F(b,a)},O,na=J(new u("Many parser applied to a parser that accepts an empty string"));O=function(a){var b=function(b,d,f,e,g,j){return m(a,[b,d,f,e,na,j])};return K(function(a){return W(F(b,a))})};var G,oa=function(a,b){return new w(a,null===b?"end of input":b)};G=function(a,b){var c=b||oa;return function(b,f,e,g,j,h){g=b.position;return(j=b.input)?(j=i.first(j),a(j)?e(j,b.next(j),f):h(c(g,j),b,f)):h(c(g,null),b,f)}};var pa=B("Any Token",
G(k(!0))),X=function(a,b){return G(A(a,b))},qa=function(a,b){return U(b,a)},H=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},I=function(a,b){return H(a,b,null,k,J,k,J)},Y=function(a,b,c){return I(a,new l(b,p.initial,c))},Z=function(a,b){var c=W(n(a,function(a,b,e){return t(i.memoStream(a,A(I,c,b,e)))}));return I(c,b)},$=function(a,b,c){return Z(a,new l(b,p.initial,c))},P,aa=k(k(!0)),ba=k(k(!1));P=function(a,b){return H(a,b,null,aa,ba,aa,ba)};var ca=
function(a,b,c){return P(a,new l(b,p.initial,c))};return{ParserError:u,ParseError:h,MultipleError:q,UnknownError:v,UnexpectError:w,ExpectError:s,ParserState:l,Position:p,rec:K,Parser:B,RecParser:function(a,b){return B(a,K(b))},always:t,never:C,bind:n,eof:function(){return n(T(),function(a){return i.isEmpty(a)?t(i.end):n(D(),function(b){return C(new s(b,"end of input",i.first(a)))})})},extract:y,getParserState:fa,setParserState:function(a){return L(k(a))},modifyParserState:L,getState:ga,setState:function(a){return M(k(a))},
modifyState:M,getInput:T,setInput:function(a){return M(function(b){return b.setInput(a)})},getPosition:D,setPosition:function(a){return L(function(b){return b.setPosition(a)})},fail:function(a){var b=a?h:v;return n(D(),function(c){return C(new b(c,a))})},attempt:function(a){return function(b,c,d,f,e,g){return m(a,[b,c,d,g,e,g])}},lookahead:function(a){return function(b,c,d,f,e,g){return m(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:U,either:V,choice:function(){if(!arguments.length)throw new u("choice called with no arguments");
return R(arguments,ia,ja)},optional:z,expected:function(a,b){return function(c,d,f,e,g,j){return b(c,d,f,e,g,function(b,c,d){return j(new s(c.position,a),c,d)})}},eager:N,binds:function(a,b){return n(N(a),function(a){return b.apply(void 0,a)})},cons:F,append:E,sequence:function(){return R(arguments,ma,ka)},many:O,many1:function(a){return F(a,O(a))},token:G,anyToken:pa,character:function(a,b){return X(b||S,a)},string:function(a,b){return Q(a,A(X,b||S)).reduceRight(qa,t(a))},backtrack:function(a){return function(b,
c,d,f,e,g){return m(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,h){var i=r.lookup(d,b,c);return i?m(i,[c,d,f,e,g,h]):m(a,[c,d,function(a,d,e){return f(a,d,r.update(e,b,c,function(b,c,e){return e(a,d,c)}))},function(a,d,f){return e(a,d,r.update(f,b,c,function(b,c,e,f){return f(a,d,c)}))},function(a,d,e){return g(a,d,r.update(e,b,c,function(b,
c,e,f,g){return g(a,d,c)}))},function(a,e,f){return h(a,e,r.update(d,b,c,function(b,c,d,g,h,i){return i(a,e,f)}))}])}},exec:H,perform:function(a,b,c,d){var f=function(a){return function(){return c(a)}},e=function(a){return function(){return d(a)}};return H(a,b,null,f,e,f,e)},runState:I,runStream:Y,run:function(a,b,c){return Y(a,i.from(b),c)},runManyState:Z,runManyStream:$,runMany:function(a,b,c){return $(a,i.from(b),c)},testState:P,testStream:ca,test:function(a,b,c){return ca(a,i.from(b),c)}}});
