define(["require","exports","nu/stream","seshat"],function(fa,c,k,F){var t,e,l,u,v,r,i,j,G,p,w,H,m,A,O,y,ga,P,ha,I,Q,R,S,T,z,U,B,s,V,W,X,ia,f,Y,J,K,L,C,Z,$,aa,ba,ca;s=k.end;var oa=k.first,pa=k.isEmpty,qa=k.rest,ra=Function.prototype.call.bind(Array.prototype.map),da=Function.prototype.call.bind(Array.prototype.reduceRight),x=function(a){return function(){return a}},ja=Math.random,q=function(a,b){var d=[a,b];d._next=!0;return d},ka=function(a){for(;a&&a._next;)a=a[0].apply(void 0,a[1]);return a};f=
function(a,b){this.memoer=a;this.frames=b};f.empty=new f(F.create(function(a,b){return a.compare(b)},function(a,b){return a.id===b.id&&(a.state===b.state||a.state&&a.state.eq(b.state))}),[]);f.pushWindow=function(a,b){return new f(a.memoer,[b].concat(a.frames))};f.popWindow=function(a){return new f(1===a.frames.length?F.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};f.lookup=function(a,b,d){return F.lookup(a.memoer,b,d)};f.update=function(a,b,d,c){return new f(F.update(a.memoer,b,d,c),a.frames)};
j=function(a){this.index=a};j.initial=new j(0);j.prototype.toString=function(){return""+this.index};j.prototype.increment=function(){return new j(this.index+1)};j.prototype.compare=function(a){return this.index-a.index};i=function(a,b,d){this.input=a;this.position=b;this.userState=d};i.prototype.eq=function(a){return a&&this.input===a.input&&this.userState===a.userState};i.prototype.isEmpty=function(){return pa(this.input)};i.prototype.first=function(){return oa(this.input)};i.prototype.next=function(a){if(!this._next){var b=
new i(qa(this.input),this.position.increment(a),this.userState);this._next=function(d,c,g){return g(a,b,c)}}return this._next};i.prototype.setInput=function(a){return new i(a,this.position,this.userState)};i.prototype.setPosition=function(a){return new i(this.input,a,this.userState)};i.prototype.setUserState=function(a){return new i(this.input,this.position,a)};t=function(a){this.message=a};t.prototype=Error();t.prototype.constructor=t;t.prototype.name="ParserError";e=function(a,b){this.position=
a;this._msg=b};e.prototype=Error();e.prototype.constructor=e;e.prototype.name="ParseError";e.prototype.toString=function(){return this.name+": "+this.message};Object.defineProperties(e.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});l=function(a,b){e.call(this,a);this.errors=b||[]};l.prototype=new e;l.prototype.constructor=l;l.prototype.name="MultipleError";
Object.defineProperty(l.prototype,"errorMessage",{get:function(){return"["+ra(this.errors,function(a){return a.message}).join(", ")+"]"}});var D=function(a,b,d){e.call(this,a);this._pErr=b;this._qErr=d};D.prototype=new l;D.prototype.constructor=l;D.prototype.name="ChoiceError";Object.defineProperty(D.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});u=function(a){e.call(this,a)};u.prototype=new e;u.prototype.constructor=u;u.prototype.name="UnknownError";Object.defineProperty(u.prototype,
"errorMessage",{value:"unknown error"});v=function(a,b){e.call(this,a);this.unexpected=b};v.prototype=new e;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});r=function(a,b,d){e.call(this,a);this.expected=b;this.found=d};r.prototype=new e;r.prototype.constructor=r;r.prototype.name="ExpectError";Object.defineProperty(r.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+
(this.found?" Found:"+this.found:"")}});G=function(a){var b=a(function(){return b.apply(this,arguments)});return b};p=function(a,b){return b.hasOwnProperty("parserId")?p(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:ja(),writable:!1}})};w=function(a){return function(b,d,c,g,h){return h(a,b,d)}};H=function(a){return function(b,d,c,g,h,n){return n(a,b,d)}};m=function(a,b){return function(d,c,g,h,n,E){return q(a,[d,c,function(a,
d,c){return q(b(a,d,c),[d,c,g,h,g,h])},h,function(a,d,c){return q(b(a,d,c),[d,c,g,h,n,E])},E])}};y=function(a){return function(b,d,c,g,h){b=a(b);return h(b,b,d)}};O=p("Get Parser State",y(function(a){return a}));A=function(a){return function(b,d,c,g,h){return h(a(b),b,d)}};P=function(a){return y(function(b){return b.setUserState(a(b.userState))})};ga=p("Get State",A(function(a){return a.userState}));I=p("Get Position",A(function(a){return a.position}));ha=p("Get Input",A(function(a){return a.input}));
var la=function(a){return m(I,function(b){return H(a(b))})};var sa=w(s),fa=p("EOF",m(O,function(a){return a.isEmpty()?sa:la(function(b){return new r(b,"end of input",a.first())})}));Q=function(a,b){return m(a,x(b))};var ta=function(a,b){return Q(b,a)};R=function(a){return da(a,ta)};z=function(a){return function(b,d){return function(c,g,h,n,E,f){var M=c.position;return q(b,[c,g,h,n,E,function(b,g,e){return q(d,[c,e,h,n,E,function(d,g,h){return f(a(M,b,d),c,h)}])}])}}};S=z(function(a,b,d){return new l(a,
[b,d])});var ua=z(function(a,b,d){return new D(a,b,d)}),va=function(a,b){return ua(b,a)},wa=m(I,function(a){return H(new l(a,[]))});T=function(a){if(!a.length)throw new t("choice called no parsers");return da(a,va,wa)};z=function(a,b){return S(b,w(a))};var xa=w(s),ma=z.bind(null,s);s=function(a){return function(b,d){return m(b,function(b){return m(d,function(d){return w(a(b,d))})})}};var ya=function(a){return w(k.toArray(a))};U=function(a){return m(a,ya)};B=s(k.cons);s=s(k.append);var za=function(a,
b){return B(b,a)};V=function(a){return da(a,za,xa)};var na,Aa=new t("Many parser applied to a parser that accepts an empty string");na=function(){throw Aa;};W=function(a){var b=function(b,c,g,h,n,f){return q(a,[b,c,g,h,na,f])};return G(function(a){return ma(B(b,a))})};var Ba=function(a,b){return new v(a,null===b?"end of input":b)};X=function(a,b){var c=b||Ba;return function(b,g,h,n,f,e){var M=b.position;if(b.isEmpty())return e(c(M,null),b,g);var i=b.first();return a(i)?b.next(i)(b,g,h,n,f,e):e(c(M,
i),b,g)}};ia=p("Any Token",X(x(!0)));Y=function(a,b,c,f,g,h,n){return ka(a(b,c,f,g,h,n))};var ea=function(a,b,c,e){return Y(a,b,f.empty,c,e,c,e)},N=function(a,b,c){this.done=a;this.state=b;this.k=c};L=function(a,b){return a.done?a:new N(!1,a.state.setInput(k.append(a.state.input,b)),a.k)};K=function(a){return!a.done?K(a.k(a.state)):ka(a.k(a.state))};J=function(a,b){return new N(!1,b,function(){return ea(a,b,function(a,b){return new N(!0,b,function(){return a})},function(a,b){return new N(!0,b,function(){throw a;
})})})};C=function(a,b){return K(L(J(a,b),b))};Z=function(a,b,c){return C(a,new i(b,j.initial,c))};$=function(a,b){var c;var f=ma(m(a,function(a,b,c){return w(k.memoStream(a,C.bind(null,f,b,c)))}));c=C(f,b);return c};aa=function(a,b,c){return $(a,new i(b,j.initial,c))};var Ca=x(x(!0)),Da=x(x(!1));ba=function(a,b){return ea(a,b,Ca,Da)};ca=function(a,b,c){return ba(a,new i(b,j.initial,c))};c.ParserError=t;c.ParseError=e;c.MultipleError=l;c.UnknownError=u;c.UnexpectError=v;c.ExpectError=r;c.ParserState=
i;c.Position=j;c.rec=G;c.Parser=p;c.RecParser=function(a,b){return p(a,G(b))};c.always=w;c.never=H;c.bind=m;c.eof=fa;c.extract=A;c.getParserState=O;c.setParserState=function(a){return y(x(a))};c.modifyParserState=y;c.getState=ga;c.setState=function(a){return P(x(a))};c.modifyState=P;c.getInput=ha;c.setInput=function(a){return y(function(b){return b.setInput(a)})};c.getPosition=I;c.setPosition=function(a){return y(function(b){return b.setPosition(a)})};c.fail=function(a){var b;var c=a?e:u;b=la(function(b){return new c(b,
a)});return b};c.attempt=function(a){return function(b,c,e,g,h,n){g=function(a,b,c){return n(a,b,f.popWindow(c))};return q(a,[b,f.pushWindow(c,b.position),function(a,b,c){return e(a,b,f.popWindow(c))},g,function(a,b,c){return h(a,b,f.popWindow(c))},g])}};c.lookahead=function(a){return function(b,c,f,g,h,e){return q(a,[b,c,function(a,c,d){return h(a,b,d)},g,h,e])}};c.next=Q;c.sequencea=R;c.sequence=function(){return R(arguments)};c.either=S;c.choicea=T;c.choice=function(){return T(arguments)};c.optional=
z;c.expected=function(a,b){return function(c,f,g,h,e,i){return b(c,f,g,h,e,function(b,c,d){return i(new r(c.position,a),c,d)})}};c.eager=U;c.binds=function(a,b){return m(U(a),function(a){return b.apply(void 0,a)})};c.cons=B;c.append=s;c.enumerationa=V;c.enumeration=function(){return V(arguments)};c.many=W;c.many1=function(a){return B(a,W(a))};c.token=X;c.anyToken=ia;c.memo=function(a){var b=a.parserId||ja();return function(c,e,g,h,i,k){var j=c.position,l={id:b,state:c},m=f.lookup(e,j,l);return m?
q(m,[c,e,g,h,i,k]):q(a,[c,e,function(a,b,c){return g(a,b,f.update(c,j,l,function(c,d,e){return e(a,b,d)}))},function(a,b,c){return h(a,b,f.update(c,j,l,function(c,d,e,g){return g(a,b,d)}))},function(a,b,c){return i(a,b,f.update(c,j,l,function(c,d,e,g,h){return h(a,b,d)}))},function(a,b,c){return k(a,b,f.update(c,j,l,function(c,d,e,g,h,f){return f(a,b,d)}))}])}};c.Memoer=f;c.exec=Y;c.perform=function(a,b,c,e){return ea(a,b,function(a,b,e){return function(){return c(a,b,e)}},function(a,b,c){return function(){return e(a,
b,c)}})};c.parse=function(a,b){return J(a,new i(k.end,j.initial,b))};c.parseState=J;c.finish=K;c.provide=L;c.provideString=function(a,b){return L(a,k.from(b))};c.runState=C;c.runStream=Z;c.run=function(a,b,c){return Z(a,k.from(b),c)};c.runManyState=$;c.runManyStream=aa;c.runMany=function(a,b,c){return aa(a,k.from(b),c)};c.testState=ba;c.testStream=ca;c.test=function(a,b,c){return ca(a,k.from(b),c)}});
