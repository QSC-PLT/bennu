define(["nu/stream"],function(h){var ea=Function.prototype.call.bind(Array.prototype.map),F=Function.prototype.call.bind(Array.prototype.reduceRight),P=function(a){return a.bind.apply(a,arguments)},q=function(a){return function(){return a}},Q=function(a){return function(){throw a;}},R=Math.random,l=function(a,b){var c=[a,b];c._next=!0;return c},r={create:function(a,b,c,d,f){return{cell:{id:a,state:b,val:c,delegate:d},window:f||[]}},lookup:function(a,b,c){for(a=a.cell;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;
return null},prune:function(a){for(var b=a.cell,c=0;b&&(!a.window[0]||0>a.window[0].compare(b.state.position));)b=b.delegate,c+=1;console.log("pruned:"+c);return{cell:b,window:a.window}},update:function(a,b,c,d){for(var f=a.cell,e=0;f&&(!a.window[0]||0>a.window[0].compare(f.state.position));)f=f.delegate,e+=1;console.log("pruned:"+e);return r.create(b,c,d,f,a.window)},setWindow:function(a,b){return!a.cell?{window:b}:r.create(a.cell.id,a.cell.state,a.cell.val,a.cell.delegate,b)}},m=function(a){this.index=
a};m.initial=new m(0);m.prototype.toString=function(){return""+this.index};m.prototype.increment=function(){return new m(this.index+1)};m.prototype.compare=function(a){return this.index-a.index};var k=function(a,b,c){this.input=a;this.position=b;this.userState=c};k.prototype.next=function(a){this._next||(this._next=new k(h.rest(this.input),this.position.increment(a),this.userState));return this._next};k.prototype.eq=function(a){return 0===this.position.compare(a.position)};k.prototype.setInput=function(a){return new k(a,
this.position,this.userState)};k.prototype.setPosition=function(a){return new k(this.input,a,this.userState)};k.prototype.setUserState=function(a){return new k(this.input,this.position,a)};var t=function(a){this.message=a};t.prototype=Error();t.prototype.constructor=t;t.prototype.name="ParserError";var g=function(a,b){this.position=a;this._msg=b};g.prototype=Error();g.prototype.constructor=g;g.prototype.name="ParseError";Object.defineProperties(g.prototype,{message:{configurable:!0,get:function(){return"At position:"+
this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var n=function(a,b){g.call(this,a);this.errors=b||[]};n.prototype=new g;n.prototype.constructor=n;n.prototype.name="MultipleError";Object.defineProperty(n.prototype,"errorMessage",{get:function(){return"["+ea(this.errors,function(a){return a.message}).join(", ")+"]"}});var x=function(a,b,c){g.call(this,a);this._pErr=b;this._qErr=c};x.prototype=new n;x.prototype.constructor=
n;x.prototype.name="ChoiceError";Object.defineProperty(x.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var u=function(a){g.call(this,a)};u.prototype=new g;u.prototype.constructor=u;u.prototype.name="UnknownError";Object.defineProperty(u.prototype,"errorMessage",{value:"unknown error"});var v=function(a,b){g.call(this,a);this.unexpected=b};v.prototype=new g;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",
{get:function(){return"Unexpected:"+this.unexpected}});var s=function(a,b,c){g.call(this,a);this.expected=b;this.found=c};s.prototype=new g;s.prototype.constructor=s;s.prototype.name="ExpectError";Object.defineProperty(s.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var G=function(a){var b=a(function(){return b.apply(this,arguments)});return b},A=function(a,b){return b.hasOwnProperty("parserId")?A(a,function(){return b.apply(this,
arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:R(),writable:!1}})},w=function(a){return function(b,c,d,f,e){return e(a,b,c)}},H=function(a){return function(b,c,d,f,e,i){return i(a,b,c)}},p=function(a,b){return function(c,d,f,e,i,j){return l(a,[c,d,function(a,c,d){return l(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return l(b(a,c,d),[c,d,f,e,i,j])},j])}},y=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},ga=y(function(a){return a}),B=function(a){return function(b,
c,d,f,e){b=a(b);return e(b,b,c)}},ha=y(function(a){return a.userState}),I=function(a){return B(function(b){return b.setUserState(a(b.userState))})},J=y(function(a){return a.position}),S=y(function(a){return a.input}),T=function(a){return p(J,function(b){return H(a(b))})},U,ia=w(h.end);U=p(S,function(a){return h.isEmpty(a)?ia:T(function(b){return new s(b,"end of input",h.first(a))})});var V=function(a,b){return p(a,q(b))},W,ja=function(a,b){return V(b,a)};W=function(a){return F(a,ja)};var z=function(a){return function(b,
c){return function(d,f,e,i,j,g){var fa=d.position;return l(b,[d,f,e,i,j,function(b,f,h){return l(c,[d,h,e,i,j,function(c,f,e){return g(a(fa,b,c),d,e)}])}])}}},X=z(function(a,b,c){return new n(a,[b,c])}),ka=z(function(a,b,c){return new x(a,b,c)}),la=function(a,b){return ka(b,a)},ma=p(J,function(a){return H(new n(a,[]))}),z=function(a,b){return X(b,w(a))},na=w(h.end),Y=P(z,h.end),C=function(a){return function(b,c){return p(b,function(b){return p(c,function(c){return w(a(b,c))})})}},K,oa=function(a){return w(h.toArray(a))};
K=function(a){return p(a,oa)};var D=C(h.cons),C=C(h.append),Z,pa=function(a,b){return D(b,a)};Z=function(a){return F(a,pa,na)};var L,qa=Q(new t("Many parser applied to a parser that accepts an empty string"));L=function(a){var b=function(b,d,f,e,i,j){return l(a,[b,d,f,e,qa,j])};return G(function(a){return Y(D(b,a))})};var M,ra=function(a,b){return new v(a,null===b?"end of input":b)};M=function(a,b){var c=b||ra;return function(b,f,e,i,j,g){i=b.position;return(j=b.input)?(j=h.first(j),a(j)?e(j,b.next(j),
f):g(c(i,j),b,f)):g(c(i,null),b,f)}};var sa=A("Any Token",M(q(!0))),$=function(a,b,c,d,f,e,i){for(a=a(b,c,d,f,e,i);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},N=function(a,b,c,d){return $(a,b,{window:[]},c,d,c,d)},E=function(a,b){return N(a,b,q,Q)},aa=function(a,b,c){return E(a,new k(b,m.initial,c))},ba=function(a,b){var c=Y(p(a,function(a,b,e){return w(h.memoStream(a,P(E,c,b,e)))}));return E(c,b)},ca=function(a,b,c){return ba(a,new k(b,m.initial,c))},O,ta=q(q(!0)),ua=q(q(!1));O=function(a,
b){return N(a,b,ta,ua)};var da=function(a,b,c){return O(a,new k(b,m.initial,c))};return{ParserError:t,ParseError:g,MultipleError:n,UnknownError:u,UnexpectError:v,ExpectError:s,ParserState:k,Position:m,rec:G,Parser:A,RecParser:function(a,b){return A(a,G(b))},always:w,never:H,bind:p,eof:U,extract:y,getParserState:ga,setParserState:function(a){return B(q(a))},modifyParserState:B,getState:ha,setState:function(a){return I(q(a))},modifyState:I,getInput:S,setInput:function(a){return I(function(b){return b.setInput(a)})},
getPosition:J,setPosition:function(a){return B(function(b){return b.setPosition(a)})},fail:function(a){var b=a?g:u;return T(function(c){return new b(c,a)})},attempt:function(a){return function(b,c,d,f,e,i){return l(a,[b,r.setWindow(c,[b.position]),d,i,e,i])}},lookahead:function(a){return function(b,c,d,f,e,i){return l(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,i])}},next:V,sequence:function(){return W(arguments)},either:X,choice:function(){if(!arguments.length)throw new t("choice called with no arguments");
return F(arguments,la,ma)},optional:z,expected:function(a,b){return function(c,d,f,e,i,g){return b(c,d,f,e,i,function(b,c,d){return g(new s(c.position,a),c,d)})}},eager:K,binds:function(a,b){return p(K(a),function(a){return b.apply(void 0,a)})},cons:D,append:C,enumeration:function(){return Z(arguments)},many:L,many1:function(a){return D(a,L(a))},token:M,anyToken:sa,memo:function(a){var b=a.parserId||R();return function(c,d,f,e,g,j){var h=r.lookup(d,b,c);return h?l(h,[c,d,f,e,g,j]):l(a,[c,d,function(a,
d,e){return f(a,d,r.update(e,b,c,function(b,c,e){return e(a,d,c)}))},function(a,d,f){return e(a,d,r.update(f,b,c,function(b,c,e,f){return f(a,d,c)}))},function(a,d,f){return g(a,d,r.update(f,b,c,function(b,c,f,e,g){return g(a,d,c)}))},function(a,f,e){return j(a,f,r.update(d,b,c,function(b,c,d,g,i,h){return h(a,f,e)}))}])}},exec:$,perform:function(a,b,c,d){return N(a,b,function(a){return function(){return c(a)}},function(a){return function(){return d(a)}})},runState:E,runStream:aa,run:function(a,b,
c){return aa(a,h.from(b),c)},runManyState:ba,runManyStream:ca,runMany:function(a,b,c){return ca(a,h.from(b),c)},testState:O,testStream:da,test:function(a,b,c){return da(a,h.from(b),c)}}});
