define(["nu/stream","seshat"],function(i,B){var ga=Function.prototype.call.bind(Array.prototype.map),G=Function.prototype.call.bind(Array.prototype.reduceRight),S=function(a){return a.bind.apply(a,arguments)},r=function(a){return function(){return a}},T=function(a){return function(){throw a;}},U=Math.random,m=function(a,b){var c=[a,b];c._next=!0;return c},f=function(a,b){this.memoer=a;this.frames=b};f.create=function(a){return new f(B.create(a),[])};f.pushWindow=function(a,b){return new f(a.memoer,
[b].concat(a.frames))};f.popWindow=function(a){return new f(1===a.frames.length?B.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};f.lookup=function(a,b,c){return B.lookup(a.memoer,b,c)};f.update=function(a,b,c,d){return new f(B.update(a.memoer,b,c,d),a.frames)};var n=function(a){this.index=a};n.initial=new n(0);n.prototype.toString=function(){return""+this.index};n.prototype.increment=function(){return new n(this.index+1)};n.prototype.compare=function(a){return this.index-a.index};var k=
function(a,b,c){this.input=a;this.position=b;this.userState=c};k.prototype.next=function(a){this._next||(this._next=new k(i.rest(this.input),this.position.increment(a),this.userState));return this._next};k.prototype.setInput=function(a){return new k(a,this.position,this.userState)};k.prototype.setPosition=function(a){return new k(this.input,a,this.userState)};k.prototype.setUserState=function(a){return new k(this.input,this.position,a)};var u=function(a){this.message=a};u.prototype=Error();u.prototype.constructor=
u;u.prototype.name="ParserError";var h=function(a,b){this.position=a;this._msg=b};h.prototype=Error();h.prototype.constructor=h;h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var p=function(a,b){h.call(this,a);this.errors=b||[]};p.prototype=new h;p.prototype.constructor=p;p.prototype.name="MultipleError";
Object.defineProperty(p.prototype,"errorMessage",{get:function(){return"["+ga(this.errors,function(a){return a.message}).join(", ")+"]"}});var z=function(a,b,c){h.call(this,a);this._pErr=b;this._qErr=c};z.prototype=new p;z.prototype.constructor=p;z.prototype.name="ChoiceError";Object.defineProperty(z.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var v=function(a){h.call(this,a)};v.prototype=new h;v.prototype.constructor=v;v.prototype.name="UnknownError";Object.defineProperty(v.prototype,
"errorMessage",{value:"unknown error"});var w=function(a,b){h.call(this,a);this.unexpected=b};w.prototype=new h;w.prototype.constructor=w;w.prototype.name="UnexpectError";Object.defineProperty(w.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var t=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};t.prototype=new h;t.prototype.constructor=t;t.prototype.name="ExpectError";Object.defineProperty(t.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+
(this.found?" Found:"+this.found:"")}});var H=function(a){var b=a(function(){return b.apply(this,arguments)});return b},s=function(a,b){return b.hasOwnProperty("parserId")?s(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:U(),writable:!1}})},x=function(a){return function(b,c,d,g,e){return e(a,b,c)}},I=function(a){return function(b,c,d,g,e,l){return l(a,b,c)}},q=function(a,b){return function(c,d,g,e,l,j){return m(a,[c,d,function(a,
c,d){return m(b(a,c,d),[c,d,g,e,g,e])},e,function(a,c,d){return m(b(a,c,d),[c,d,g,e,l,j])},j])}},y=function(a){return function(b,c,d,g,e){b=a(b);return e(b,b,c)}},ia=s("Get Parser State",y(function(a){return a})),C=function(a){return function(b,c,d,g,e){return e(a(b),b,c)}},V=function(a){return y(function(b){return b.setUserState(a(b.userState))})},ja=s("Get State",C(function(a){return a.userState})),J=s("Get Position",C(function(a){return a.position})),W=s("Get Input",C(function(a){return a.input})),
X=function(a){return q(J,function(b){return I(a(b))})},Y,ka=x(i.end);Y=s("EOF",q(W,function(a){return i.isEmpty(a)?ka:X(function(b){return new t(b,"end of input",i.first(a))})}));var Z=function(a,b){return q(a,r(b))},K,la=function(a,b){return Z(b,a)};K=function(a){return G(a,la)};var A=function(a){return function(b,c){return function(d,g,e,l,j,f){var ha=d.position;return m(b,[d,g,e,l,j,function(b,g,h){return m(c,[d,h,e,l,j,function(c,g,e){return f(a(ha,b,c),d,e)}])}])}}},$=A(function(a,b,c){return new p(a,
[b,c])}),L,ma=A(function(a,b,c){return new z(a,b,c)}),na=function(a,b){return ma(b,a)},oa=q(J,function(a){return I(new p(a,[]))});L=function(a){if(!a.length)throw new u("choice called no parsers");return G(a,na,oa)};var A=function(a,b){return $(b,x(a))},pa=x(i.end),aa=S(A,i.end),D=function(a){return function(b,c){return q(b,function(b){return q(c,function(c){return x(a(b,c))})})}},M,qa=function(a){return x(i.toArray(a))};M=function(a){return q(a,qa)};var E=D(i.cons),D=D(i.append),N,ra=function(a,
b){return E(b,a)};N=function(a){return G(a,ra,pa)};var O,sa=T(new u("Many parser applied to a parser that accepts an empty string"));O=function(a){var b=function(b,d,g,e,l,j){return m(a,[b,d,g,e,sa,j])};return H(function(a){return aa(E(b,a))})};var P,ta=function(a,b){return new w(a,null===b?"end of input":b)};P=function(a,b){var c=b||ta;return function(b,g,e,l,j,f){l=b.position;return(j=b.input)?(j=i.first(j),a(j)?e(j,b.next(j),g):f(c(l,j),b,g)):f(c(l,null),b,g)}};var ua=s("Any Token",P(r(!0))),ba=
function(a,b,c,d,g,e,f){for(a=a(b,c,d,g,e,f);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},Q=function(a,b,c,d){return ba(a,b,f.create(function(a,b){return a.compare(b)}),c,d,c,d)},F=function(a,b){return Q(a,b,r,T)},ca=function(a,b,c){return F(a,new k(b,n.initial,c))},da=function(a,b){var c=aa(q(a,function(a,b,e){return x(i.memoStream(a,S(F,c,b,e)))}));return F(c,b)},ea=function(a,b,c){return da(a,new k(b,n.initial,c))},R,va=r(r(!0)),wa=r(r(!1));R=function(a,b){return Q(a,b,va,wa)};var fa=function(a,
b,c){return R(a,new k(b,n.initial,c))};return{ParserError:u,ParseError:h,MultipleError:p,UnknownError:v,UnexpectError:w,ExpectError:t,ParserState:k,Position:n,rec:H,Parser:s,RecParser:function(a,b){return s(a,H(b))},always:x,never:I,bind:q,eof:Y,extract:C,getParserState:ia,setParserState:function(a){return y(r(a))},modifyParserState:y,getState:ja,setState:function(a){return V(r(a))},modifyState:V,getInput:W,setInput:function(a){return y(function(b){return b.setInput(a)})},getPosition:J,setPosition:function(a){return y(function(b){return b.setPosition(a)})},
fail:function(a){var b=a?h:v;return X(function(c){return new b(c,a)})},attempt:function(a){return function(b,c,d,g,e,l){return m(a,[b,f.pushWindow(c,b.position),function(a,b,c){return d(a,b,f.popWindow(c))},function(a,b,c){return l(a,b,f.popWindow(c))},function(a,b,c){return e(a,b,f.popWindow(c))},function(a,b,c){return l(a,b,f.popWindow(c))}])}},lookahead:function(a){return function(b,c,d,g,e,f){return m(a,[b,c,function(a,c,d){return e(a,b,d)},g,e,f])}},next:Z,sequencea:K,sequence:function(){return K(arguments)},
either:$,choicea:L,choice:function(){return L(arguments)},optional:A,expected:function(a,b){return function(c,d,g,e,f,j){return b(c,d,g,e,f,function(b,c,d){return j(new t(c.position,a),c,d)})}},eager:M,binds:function(a,b){return q(M(a),function(a){return b.apply(void 0,a)})},cons:E,append:D,enumerationa:N,enumeration:function(){return N(arguments)},many:O,many1:function(a){return E(a,O(a))},token:P,anyToken:ua,memo:function(a){var b=a.parserId||U();return function(c,d,g,e,h,j){var i=c.position,k=
f.lookup(d,i,b);return k?m(k,[c,d,g,e,h,j]):m(a,[c,d,function(a,c,d){return g(a,c,f.update(d,i,b,function(b,d,e){return e(a,c,d)}))},function(a,c,d){return e(a,c,f.update(d,i,b,function(b,d,e,f){return f(a,c,d)}))},function(a,c,d){return h(a,c,f.update(d,i,b,function(b,d,e,f,g){return g(a,c,d)}))},function(a,c,d){return j(a,c,f.update(d,i,b,function(b,d,e,f,g,h){return h(a,c,d)}))}])}},exec:ba,perform:function(a,b,c,d){return Q(a,b,function(a){return function(){return c(a)}},function(a){return function(){return d(a)}})},
runState:F,runStream:ca,run:function(a,b,c){return ca(a,i.from(b),c)},runManyState:da,runManyStream:ea,runMany:function(a,b,c){return ea(a,i.from(b),c)},testState:R,testStream:fa,test:function(a,b,c){return fa(a,i.from(b),c)}}});
