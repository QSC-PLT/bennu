define(["nu/stream"],function(i){var M=Array.prototype.map,N=Array.prototype.reduceRight,y=function(a){return a.bind.apply(a,arguments)},q=function(a){return function(){return a}},O=function(a,b){return a===b},k=function(a,b){var c=[a,b];c._next=!0;return c},m=function(a,b,c,d){this.id=a;this.val=b;this.state=c;this.delegate=d};m.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;return null};m.update=function(a,b,c,d){return new m(b,c,d,a)};var n=function(a){this.index=
a};n.prototype.increment=function(){return new n(this.index+1)};n.prototype.toString=function(){return""+this.index};n.prototype.compare=function(a){return this.index-a.index};var r=function(a,b){this.input=a;this.pos=b};r.prototype.next=function(a){return this._next||(this._next=new r(i.rest(this.input),this.pos.increment(a)))};r.prototype.eq=function(a){return 0===this.pos.compare(a.pos)};var z=function(a){this.message=a};z.prototype=Error();z.prototype.constructor=z;z.prototype.name="ParserError";
var h=function(a,b){this.pos=a;this._msg=b};h.prototype=Error();h.prototype.constructor=h;h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.pos+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var l=function(a,b){h.call(this,a);this.errors=b||[]};l.prototype=new h;l.prototype.constructor=l;l.prototype.name="MultipleError";Object.defineProperty(l.prototype,
"errorMessage",{get:function(){return"["+M.call(this.errors,function(a){return a.message}).join(", ")+"]"}});var A=function(a,b,c){h.call(this,a);this._pErr=b;this._qErr=c};A.prototype=new l;A.prototype.constructor=l;A.prototype.name="ChoiceError";Object.defineProperty(A.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var s=function(a){h.call(this,a)};s.prototype=new h;s.prototype.constructor=s;s.prototype.name="UnknownError";Object.defineProperty(s.prototype,"errorMessage",
{value:"unknown error"});var p=function(a,b){h.call(this,a);this.unexpected=b};p.prototype=new h;p.prototype.constructor=p;p.prototype.name="UnexpectError";Object.defineProperty(p.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var t=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};t.prototype=new h;t.prototype.constructor=t;t.prototype.name="ExpectError";Object.defineProperty(t.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?
" Found:"+this.found:"")}});var C=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},H=function(a,b){return b.hasOwnProperty("parserId")?H(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},u=function(a){return function(b,c,d,f,e){return e(a,b,c)}},I=function(a){var b=void 0===a?s:h;return function(c,d,f,e,g,j){return j(new b(c.pos,a),c,d)}},v=function(a,b){return function(c,
d,f,e,g,j){return k(a,[c,d,function(a,c,d){return k(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return k(b(a,c,d),[c,d,f,e,g,j])},j])}},P=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},da=y(P,function(a){return a}),Q=function(a){return function(b,c,d,f,e,g){return k(a,[b,c,d,g,e,g])}},B=function(a,b){return v(a,q(b))},w=function(a){return function(b,c){return function(d,f,e,g,j,h){var ca=d.pos;return k(b,[d,f,e,g,j,function(b,f,i){return k(c,[d,i,e,g,j,function(c,e,f){return h(a(ca,b,
c),d,f)}])}])}}},J=w(function(a,b,c){return new l(a,[b,c])}),ea=w(function(a,b,c){return new A(a,b,c)}),fa=function(a,b){return ea(b,a)},ga=function(a,b,c,d,f,e){return e(new l(a.pos,[]),a,b)},R=function(a,b){return J(a,u(b))},D=u(i.end),w=function(a,b,c){return v(b,function(b){return v(c,function(c){return u(a(b,c))})})},E=function(a){return R(a,i.end)},x=y(w,i.cons),S=y(w,i.append),ha=function(a,b){return x(b,a)},K,ia=function(){throw new z("Many parser applied to a parser that accepts an empty string");
};K=function(a){var b=function(b,d,f,e,g,j){return k(a,[b,d,f,e,ia,j])};return C(function(a){return E(x(b,a))})};var L=function(a,b){return 0>=a?D:x(b,L(a-1,b))},T=function(a,b){return 0>=a?D:E(x(b,T(a-1,b)))},U=function(a,b){return C(function(c){return x(b,J(Q(B(a,c)),D))})},F,ja=function(a,b){return new p(a,b)};F=function(a,b){b=b||ja;return function(c,d,f,e,g,j){e=c.pos;return(g=c.input)?(g=i.first(g),a(g)?f(g,c.next(g),d):j(b(e,g),c,d)):j(new p(e,"end of input"),c,d)}};var w=F(q(!0)),V=function(a,
b){return F(y(a,b))},ka=function(a,b){return B(b,a)},W=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},X=function(a,b){return function(c,d,f){return W(c,d,f||null,a,b,a,b)}},G=X(q,function(a){return function(){throw a;}}),Y=function(a,b){return G(a,new r(b,new n(0)))},Z=function(a,b){var c=E(v(a,function(a,b,e){return u(i.memoStream(a,y(G,c,b,e)))}));return G(c,b)},$=function(a,b){return Z(a,new r(b,new n(0)))},aa=X(q(q(!0)),q(q(!1))),ba=function(a,b){return aa(a,
new r(b,new n(0)))};return{ParserError:z,ParseError:h,MultipleError:l,UnknownError:s,UnexpectError:p,ExpectError:t,InputState:r,Position:n,rec:C,Parser:H,RecParser:function(a,b){return H(a,C(b))},always:u,never:I,bind:v,binda:function(a,b){return v(a,function(a){return b.apply(void 0,i.toArray(a))})},eof:function(){return function(a,b,c,d,f,e){return i.isEmpty(a.input)?f(i.end,a,b):e(new t(a.pos,"end of input, found:"+i.first(a.input)),a,b)}},extract:P,examine:da,attempt:Q,lookahead:function(a){return function(b,
c,d,f,e,g){return k(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:B,either:J,choice:function(){return 0===arguments.length?I():N.call(arguments,fa,ga)},optional:R,cons:x,append:S,sequence:function(){return N.call(arguments,ha,D)},many:K,many1:function(a){return x(a,K(a))},times:L,betweenTimes:function(a,b,c){return b<a?I:S(L(a,c),T(b-a,c))},between:function(a,b,c){return B(a,v(c,function(a){return B(b,u(a))}))},sepBy1:U,sepBy:function(a,b){return E(U(a,b))},token:F,anyToken:w,character:function(a,
b){return V(b||O,a)},string:function(a,b){return M.call(a,y(V,b||O)).reduceRight(ka,u(a))},backtrack:function(a){return function(b,c,d,f,e,g){return k(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,h){var i=m.lookup(d,b,c);return i?k(i,[c,d,f,e,g,h]):k(a,[c,d,function(a,d,e){return f(a,d,m.update(e,b,function(b,c,e){return e(a,d,c)},c))},
function(a,d,f){return e(a,d,m.update(f,b,function(b,c,e,f){return f(a,d,c)},c))},function(a,d,e){return g(a,d,m.update(e,b,function(b,c,e,f,g){return g(a,d,c)},c))},function(a,e,f){return h(a,e,m.update(d,b,function(b,c,d,g,h,i){return i(a,e,f)},c))}])}},exec:W,runState:G,runStream:Y,run:function(a,b){return Y(a,i.from(b))},runManyState:Z,runManyStream:$,runMany:function(a,b){return $(a,i.from(b))},testState:aa,testStream:ba,test:function(a,b){return ba(a,i.from(b))}}});
