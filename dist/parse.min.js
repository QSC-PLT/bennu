define(["stream/stream"],function(h){var $=Array.prototype.join,aa=Array.prototype.map,J=Array.prototype.reduceRight,u=function(a){return 1===arguments.length?a:a.bind.apply(a,arguments)},n=function(a){return function(){return a}},K=function(a,b){return a===b},j=function(a,b){var c=[a,b];c._next=!0;return c},l=function(a,b,c,d){this.id=a;this.val=b;this.state=c;this.delegate=d};l.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;return null};l.update=function(a,b,
c,d){return new l(b,c,d,a)};var m=function(a){this.index=a};m.prototype.increment=function(){return new m(this.index+1)};m.prototype.toString=function(){return""+this.index};m.prototype.compare=function(a){return this.index-a.index};var p=function(a,b){this.input=a;this.pos=b};p.prototype.next=function(a){return this._next||(this._next=new p(h.rest(this.input),this.pos.increment(a)))};p.prototype.eq=function(a){return 0===this.pos.compare(a.pos)};var i=function(a,b){this._messages=b;this.pos=a};i.prototype=
Error();i.prototype.constructor=i;i.prototype.name="ParseError";Object.defineProperties(i.prototype,{message:{get:function(){var a=this.messages;return"At position:"+this.pos+" ["+(a?$.call(a,", "):"")+"]"}},messages:{get:function(){return this._messages}}});var v=function(a,b){this.e1=a;this.e2=b;i.call(this,a.pos)};v.prototype=new i;v.prototype.constructor=v;v.prototype.name="MultipleError";Object.defineProperty(v.prototype,"messages",{get:function(){var a=this.e1.message;return a?[a,this.e2.message]:
[this.e2.message]}});var w=function(a){i.call(this,a,["Error"])};w.prototype=new i;w.prototype.constructor=w;w.prototype.name="UnknownError";var q=function(a,b){i.call(this,a,b?["Unexpected "+b]:b)};q.prototype=new i;q.prototype.constructor=q;q.prototype.name="UnexpectError";var x=function(a,b){i.call(this,a,["Expected "+(b||"")])};x.prototype=new i;x.prototype.constructor=x;x.prototype.name="ExpectError";var z=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},L=function(a,
b){return Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},r=function(a){return function(b,c,d,f,e){return e(a,b,c)}},G=function(){return function(a,b,c,d,f,e){return e(new w(a.pos),a,b)}},s=function(a,b){return function(c,d,f,e,g,k){return j(a,[c,d,function(a,c,d){return j(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return j(b(a,c,d),[c,d,f,e,g,k])},k])}},M=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},ba=u(M,function(a){return a}),
N=function(a){return function(b,c,d,f,e,g){return j(a,[b,c,d,g,e,g])}},y=function(a,b){return s(a,n(b))},A=function(a,b){return function(c,d,f,e,g,k){return j(a,[c,d,f,e,g,function(a,d,h){return j(b,[c,h,f,e,g,function(b,d,e){return k(new v(a,b),c,e)}])}])}},ca=function(a,b){return A(b,a)},O=function(a,b){return A(a,r(b))},B=r(h.end),C=function(a,b,c){return s(b,function(b){return s(c,function(c){return r(a(b,c))})})},D=function(a){return O(a,h.end)},t=u(C,h.cons),P=u(C,h.concat),da=function(a,b){return t(b,
a)},H,ea=function(){throw Error("Many parser applied to a parser that accepts an empty string");};H=function(a){var b=function(b,d,f,e,g,k){return j(a,[b,d,f,e,ea,k])};return z(function(a){return D(t(b,a))})};var I=function(a,b){return 0>=a?B:t(b,I(a-1,b))},Q=function(a,b){return 0>=a?B:D(t(b,Q(a-1,b)))},R=function(a,b){return z(function(c){return t(b,A(N(y(a,c)),B))})},E,fa=function(a,b){return new q(a,b)};E=function(a,b){b=b||fa;return function(c,d,f,e,g,k){e=c.pos;return(g=c.input)?(g=h.first(g),
a(g)?f(g,c.next(g),d):k(b(e,g),c,d)):k(new q(e,"end of input"),c,d)}};var C=E(n(!0)),S=function(a,b){return E(u(a,b))},ga=function(a,b){return y(b,a)},T=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},U=function(a,b){return function(c,d,f){return T(c,d,f||null,a,b,a,b)}},F=U(n,function(a){return function(){throw a;}}),V=function(a,b){return F(a,new p(b,new m(0)))},W=function(a,b){var c=D(s(a,function(a,b,e){return r(h.memoStream(a,u(F,c,b,e)))}));return F(c,
b)},X=function(a,b){return W(a,new p(b,new m(0)))},Y=U(n(n(!0)),n(n(!1))),Z=function(a,b){return Y(a,new p(b,new m(0)))};return{ParseError:i,UnknownError:w,UnexpectError:q,ExpectError:x,InputState:p,Position:m,rec:z,Parser:L,RecParser:function(a,b){return L(a,z(b))},always:r,never:G,bind:s,binda:function(a,b){return s(a,function(a){return b.apply(void 0,h.toArray(a))})},eof:function(){return function(a,b,c,d,f,e){return h.isEmpty(a.input)?f(h.end,a,b):e(new x(a.pos,"end of input, found:"+h.first(a.input)),
a,b)}},extract:M,examine:ba,attempt:N,lookahead:function(a){return function(b,c,d,f,e,g){return j(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:y,either:A,choice:function(){return 0===arguments.length?G:J.call(arguments,ca)},optional:O,consParser:t,concatParser:P,sequence:function(){return J.call(arguments,da,B)},many:H,many1:function(a){return t(a,H(a))},times:I,betweenTimes:function(a,b,c){return b<a?G:P(I(a,c),Q(b-a,c))},between:function(a,b,c){return y(a,s(c,function(a){return y(b,r(a))}))},
sepBy1:R,sepBy:function(a,b){return D(R(a,b))},token:E,anyToken:C,character:function(a,b){return S(b||K,a)},string:function(a,b){return aa.call(a,u(S,b||K)).reduceRight(ga,r(a))},backtrack:function(a){return function(b,c,d,f,e,g){return j(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,h){var i=l.lookup(d,b,c);return i?j(i,[c,d,f,e,g,h]):
j(a,[c,d,function(a,d,e){return f(a,d,l.update(e,b,function(b,c,e){return e(a,d,c)},c))},function(a,d,f){return e(a,d,l.update(f,b,function(b,c,e,f){return f(a,d,c)},c))},function(a,d,e){return g(a,d,l.update(e,b,function(b,c,e,f,g){return g(a,d,c)},c))},function(a,e,f){return h(a,e,l.update(d,b,function(b,c,d,g,h,i){return i(a,e,f)},c))}])}},exec:T,runState:F,runStream:V,run:function(a,b){return V(a,h.from(b))},runManyState:W,runManyStream:X,runMany:function(a,b){return X(a,h.from(b))},testState:Y,
testStream:Z,test:function(a,b){return Z(a,h.from(b))}}});
