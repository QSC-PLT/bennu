define(["nu/stream","seshat"],function(i,B){var ia=Function.prototype.call.bind(Array.prototype.map),I=Function.prototype.call.bind(Array.prototype.reduceRight),U=function(a){return a.bind.apply(a,arguments)},m=function(a){return function(){return a}},J=function(a){return function(){throw a;}},V=Math.random,n=function(a,b){var c=[a,b];c._next=!0;return c},g=function(a,b){this.memoer=a;this.frames=b},C;C=new g(B.create(function(a,b){return a.compare(b)},function(a,b){return a.id===b.id&&a.input===
b.input}),[]);g.empty=C;g.pushWindow=function(a,b){return new g(a.memoer,[b].concat(a.frames))};g.popWindow=function(a){return new g(1===a.frames.length?B.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};g.lookup=function(a,b,c){return B.lookup(a.memoer,b,c)};g.update=function(a,b,c,e){return new g(B.update(a.memoer,b,c,e),a.frames)};var p=function(a){this.index=a};p.initial=new p(0);p.prototype.toString=function(){return""+this.index};p.prototype.increment=function(){return new p(this.index+
1)};p.prototype.compare=function(a){return this.index-a.index};var l=function(a,b,c){this.input=a;this.position=b;this.userState=c};l.prototype.next=function(a){this._next||(this._next=new l(i.rest(this.input),this.position.increment(a),this.userState));return this._next};l.prototype.setInput=function(a){return new l(a,this.position,this.userState)};l.prototype.setPosition=function(a){return new l(this.input,a,this.userState)};l.prototype.setUserState=function(a){return new l(this.input,this.position,
a)};var u=function(a){this.message=a};u.prototype=Error();u.prototype.constructor=u;u.prototype.name="ParserError";var h=function(a,b){this.position=a;this._msg=b};h.prototype=Error();h.prototype.constructor=h;h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var q=function(a,b){h.call(this,a);this.errors=
b||[]};q.prototype=new h;q.prototype.constructor=q;q.prototype.name="MultipleError";Object.defineProperty(q.prototype,"errorMessage",{get:function(){return"["+ia(this.errors,function(a){return a.message}).join(", ")+"]"}});var z=function(a,b,c){h.call(this,a);this._pErr=b;this._qErr=c};z.prototype=new q;z.prototype.constructor=q;z.prototype.name="ChoiceError";Object.defineProperty(z.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var v=function(a){h.call(this,a)};
v.prototype=new h;v.prototype.constructor=v;v.prototype.name="UnknownError";Object.defineProperty(v.prototype,"errorMessage",{value:"unknown error"});var w=function(a,b){h.call(this,a);this.unexpected=b};w.prototype=new h;w.prototype.constructor=w;w.prototype.name="UnexpectError";Object.defineProperty(w.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var t=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};t.prototype=new h;t.prototype.constructor=t;t.prototype.name=
"ExpectError";Object.defineProperty(t.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var K=function(a){var b=a(function(){return b.apply(this,arguments)});return b},s=function(a,b){return b.hasOwnProperty("parserId")?s(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:V(),writable:!1}})},x=function(a){return function(b,c,e,f,d){return d(a,b,c)}},L=function(a){return function(b,
c,e,f,d,k){return k(a,b,c)}},r=function(a,b){return function(c,e,f,d,k,j){return n(a,[c,e,function(a,c,e){return n(b(a,c,e),[c,e,f,d,f,d])},d,function(a,c,e){return n(b(a,c,e),[c,e,f,d,k,j])},j])}},y=function(a){return function(b,c,e,f,d){b=a(b);return d(b,b,c)}};C=s("Get Parser State",y(function(a){return a}));var D=function(a){return function(b,c,e,f,d){return d(a(b),b,c)}},W=function(a){return y(function(b){return b.setUserState(a(b.userState))})},ka=s("Get State",D(function(a){return a.userState})),
M=s("Get Position",D(function(a){return a.position})),X=s("Get Input",D(function(a){return a.input})),Y=function(a){return r(M,function(b){return L(a(b))})},Z,la=x(i.end);Z=s("EOF",r(X,function(a){return i.isEmpty(a)?la:Y(function(b){return new t(b,"end of input",i.first(a))})}));var $=function(a,b){return r(a,m(b))},N,ma=function(a,b){return $(b,a)};N=function(a){return I(a,ma)};var A=function(a){return function(b,c){return function(e,f,d,k,j,g){var ja=e.position;return n(b,[e,f,d,k,j,function(b,
f,h){return n(c,[e,h,d,k,j,function(c,f,d){return g(a(ja,b,c),e,d)}])}])}}},aa=A(function(a,b,c){return new q(a,[b,c])}),O,na=A(function(a,b,c){return new z(a,b,c)}),oa=function(a,b){return na(b,a)},pa=r(M,function(a){return L(new q(a,[]))});O=function(a){if(!a.length)throw new u("choice called no parsers");return I(a,oa,pa)};var A=function(a,b){return aa(b,x(a))},qa=x(i.end),ba=U(A,i.end),E=function(a){return function(b,c){return r(b,function(b){return r(c,function(c){return x(a(b,c))})})}},P,ra=
function(a){return x(i.toArray(a))};P=function(a){return r(a,ra)};var F=E(i.cons),E=E(i.append),Q,sa=function(a,b){return F(b,a)};Q=function(a){return I(a,sa,qa)};var R,ta=J(new u("Many parser applied to a parser that accepts an empty string"));R=function(a){var b=function(b,e,f,d,k,j){return n(a,[b,e,f,d,ta,j])};return K(function(a){return ba(F(b,a))})};var S,ua=function(a,b){return new w(a,null===b?"end of input":b)};S=function(a,b){var c=b||ua;return function(b,f,d,k,j,g){k=b.position;return(j=
b.input)?(j=i.first(j),a(j)?d(j,b.next(j),f):g(c(k,j),b,f)):g(c(k,null),b,f)}};var va=s("Any Token",S(m(!0))),G=function(a,b,c,e,f,d,g){for(a=a(b,c,e,f,d,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},H=function(a,b){return G(a,b,g.empty,m,J,m,J)},ca=function(a,b,c){return H(a,new l(b,p.initial,c))},da=function(a,b){var c=ba(r(a,function(a,b,d){return x(i.memoStream(a,U(H,c,b,d)))}));return H(c,b)},ea=function(a,b,c){return da(a,new l(b,p.initial,c))},T,fa=m(m(!0)),ga=m(m(!1));T=function(a,
b){return G(a,b,g.empty,fa,ga,fa,ga)};var ha=function(a,b,c){return T(a,new l(b,p.initial,c))};return{ParserError:u,ParseError:h,MultipleError:q,UnknownError:v,UnexpectError:w,ExpectError:t,ParserState:l,Position:p,rec:K,Parser:s,RecParser:function(a,b){return s(a,K(b))},always:x,never:L,bind:r,eof:Z,extract:D,getParserState:C,setParserState:function(a){return y(m(a))},modifyParserState:y,getState:ka,setState:function(a){return W(m(a))},modifyState:W,getInput:X,setInput:function(a){return y(function(b){return b.setInput(a)})},
getPosition:M,setPosition:function(a){return y(function(b){return b.setPosition(a)})},fail:function(a){var b=a?h:v;return Y(function(c){return new b(c,a)})},attempt:function(a){return function(b,c,e,f,d,k){f=function(a,b,c){return k(a,b,g.popWindow(c))};return n(a,[b,g.pushWindow(c,b.position),function(a,b,c){return e(a,b,g.popWindow(c))},f,function(a,b,c){return d(a,b,g.popWindow(c))},f])}},lookahead:function(a){return function(b,c,e,f,d,g){return n(a,[b,c,function(a,c,e){return d(a,b,e)},f,d,g])}},
next:$,sequencea:N,sequence:function(){return N(arguments)},either:aa,choicea:O,choice:function(){return O(arguments)},optional:A,expected:function(a,b){return function(c,e,f,d,g,j){return b(c,e,f,d,g,function(b,c,d){return j(new t(c.position,a),c,d)})}},eager:P,binds:function(a,b){return r(P(a),function(a){return b.apply(void 0,a)})},cons:F,append:E,enumerationa:Q,enumeration:function(){return Q(arguments)},many:R,many1:function(a){return F(a,R(a))},token:S,anyToken:va,memo:function(a){var b=a.parserId||
V();return function(c,e,f,d,k,j){var h=c.position,i={id:b,input:c.input},l=g.lookup(e,h,i);return l?n(l,[c,e,f,d,k,j]):n(a,[c,e,function(a,b,c){return f(a,b,g.update(c,h,i,function(c,d,e){return e(a,b,d)}))},function(a,b,c){return d(a,b,g.update(c,h,i,function(c,d,e,f){return f(a,b,d)}))},function(a,b,c){return k(a,b,g.update(c,h,i,function(c,d,e,f,g){return g(a,b,d)}))},function(a,b,c){return j(a,b,g.update(c,h,i,function(c,d,e,f,g,h){return h(a,b,d)}))}])}},exec:G,perform:function(a,b,c,e){var f=
function(a){return function(){return c(a)}},d=function(a){return function(){return e(a)}};return G(a,b,g.empty,f,d,f,d)},runState:H,runStream:ca,run:function(a,b,c){return ca(a,i.from(b),c)},runManyState:da,runManyStream:ea,runMany:function(a,b,c){return ea(a,i.from(b),c)},testState:T,testStream:ha,test:function(a,b,c){return ha(a,i.from(b),c)}}});
