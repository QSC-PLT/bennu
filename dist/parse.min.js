define(["nu/stream"],function(i){var J=Array.prototype.map,K=Array.prototype.reduceRight,w=function(a){return 1===arguments.length?a:a.bind.apply(a,arguments)},p=function(a){return function(){return a}},L=function(a,b){return a===b},j=function(a,b){var c=[a,b];c._next=!0;return c},l=function(a,b,c,d){this.id=a;this.val=b;this.state=c;this.delegate=d};l.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;return null};l.update=function(a,b,c,d){return new l(b,c,d,a)};
var m=function(a){this.index=a};m.prototype.increment=function(){return new m(this.index+1)};m.prototype.toString=function(){return""+this.index};m.prototype.compare=function(a){return this.index-a.index};var q=function(a,b){this.input=a;this.pos=b};q.prototype.next=function(a){return this._next||(this._next=new q(i.rest(this.input),this.pos.increment(a)))};q.prototype.eq=function(a){return 0===this.pos.compare(a.pos)};var h=function(a,b){this.pos=a;this._msg=b};h.prototype=Error();h.prototype.constructor=
h;h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.pos+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var x=function(a){h.call(this,a.pos);this.errors=arguments};x.prototype=new h;x.prototype.constructor=x;x.prototype.name="MultipleError";Object.defineProperty(x.prototype,"errorMessage",{get:function(){return"["+J.call(this.errors,function(a){return a.message}).join(", ")+
"]"}});var r=function(a){h.call(this,a)};r.prototype=new h;r.prototype.constructor=r;r.prototype.name="UnknownError";Object.defineProperty(r.prototype,"errorMessage",{value:"unknown error"});var n=function(a,b){h.call(this,a);this.unexpected=b};n.prototype=new h;n.prototype.constructor=n;n.prototype.name="UnexpectError";Object.defineProperty(n.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var s=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};s.prototype=
new h;s.prototype.constructor=s;s.prototype.name="ExpectError";Object.defineProperty(s.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var z=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},M=function(a,b){return Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},t=function(a){return function(b,c,d,f,e){return e(a,b,c)}},G=function(a){var b=void 0===a?r:
h;return function(c,d,f,e,g,k){return k(new b(c.pos,a),c,d)}},u=function(a,b){return function(c,d,f,e,g,k){return j(a,[c,d,function(a,c,d){return j(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return j(b(a,c,d),[c,d,f,e,g,k])},k])}},N=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},aa=w(N,function(a){return a}),O=function(a){return function(b,c,d,f,e,g){return j(a,[b,c,d,g,e,g])}},y=function(a,b){return u(a,p(b))},A=function(a,b){return function(c,d,f,e,g,k){return j(a,[c,d,f,e,g,function(a,
d,h){return j(b,[c,h,f,e,g,function(b,d,e){return k(new x(a,b),c,e)}])}])}},ba=function(a,b){return A(b,a)},P=function(a,b){return A(a,t(b))},B=t(i.end),C=function(a,b,c){return u(b,function(b){return u(c,function(c){return t(a(b,c))})})},D=function(a){return P(a,i.end)},v=w(C,i.cons),Q=w(C,i.concat),ca=function(a,b){return v(b,a)},H,da=function(){throw Error("Many parser applied to a parser that accepts an empty string");};H=function(a){var b=function(b,d,f,e,g,k){return j(a,[b,d,f,e,da,k])};return z(function(a){return D(v(b,
a))})};var I=function(a,b){return 0>=a?B:v(b,I(a-1,b))},R=function(a,b){return 0>=a?B:D(v(b,R(a-1,b)))},S=function(a,b){return z(function(c){return v(b,A(O(y(a,c)),B))})},E,ea=function(a,b){return new n(a,b)};E=function(a,b){b=b||ea;return function(c,d,f,e,g,k){e=c.pos;return(g=c.input)?(g=i.first(g),a(g)?f(g,c.next(g),d):k(b(e,g),c,d)):k(new n(e,"end of input"),c,d)}};var C=E(p(!0)),T=function(a,b){return E(w(a,b))},fa=function(a,b){return y(b,a)},U=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&
a._next;)a=a[0].apply(void 0,a[1]);return a()},V=function(a,b){return function(c,d,f){return U(c,d,f||null,a,b,a,b)}},F=V(p,function(a){return function(){throw a;}}),W=function(a,b){return F(a,new q(b,new m(0)))},X=function(a,b){var c=D(u(a,function(a,b,e){return t(i.memoStream(a,w(F,c,b,e)))}));return F(c,b)},Y=function(a,b){return X(a,new q(b,new m(0)))},Z=V(p(p(!0)),p(p(!1))),$=function(a,b){return Z(a,new q(b,new m(0)))};return{ParseError:h,UnknownError:r,UnexpectError:n,ExpectError:s,InputState:q,
Position:m,rec:z,Parser:M,RecParser:function(a,b){return M(a,z(b))},always:t,never:G,bind:u,binda:function(a,b){return u(a,function(a){return b.apply(void 0,i.toArray(a))})},eof:function(){return function(a,b,c,d,f,e){return i.isEmpty(a.input)?f(i.end,a,b):e(new s(a.pos,"end of input, found:"+i.first(a.input)),a,b)}},extract:N,examine:aa,attempt:O,lookahead:function(a){return function(b,c,d,f,e,g){return j(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:y,either:A,choice:function(){return 0===
arguments.length?G:K.call(arguments,ba)},optional:P,consParser:v,concatParser:Q,sequence:function(){return K.call(arguments,ca,B)},many:H,many1:function(a){return v(a,H(a))},times:I,betweenTimes:function(a,b,c){return b<a?G:Q(I(a,c),R(b-a,c))},between:function(a,b,c){return y(a,u(c,function(a){return y(b,t(a))}))},sepBy1:S,sepBy:function(a,b){return D(S(a,b))},token:E,anyToken:C,character:function(a,b){return T(b||L,a)},string:function(a,b){return J.call(a,w(T,b||L)).reduceRight(fa,t(a))},backtrack:function(a){return function(b,
c,d,f,e,g){return j(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,h){var i=l.lookup(d,b,c);return i?j(i,[c,d,f,e,g,h]):j(a,[c,d,function(a,d,e){return f(a,d,l.update(e,b,function(b,c,e){return e(a,d,c)},c))},function(a,d,f){return e(a,d,l.update(f,b,function(b,c,e,f){return f(a,d,c)},c))},function(a,d,e){return g(a,d,l.update(e,b,function(b,
c,e,f,g){return g(a,d,c)},c))},function(a,e,f){return h(a,e,l.update(d,b,function(b,c,d,g,h,i){return i(a,e,f)},c))}])}},exec:U,runState:F,runStream:W,run:function(a,b){return W(a,i.from(b))},runManyState:X,runManyStream:Y,runMany:function(a,b){return Y(a,i.from(b))},testState:Z,testStream:$,test:function(a,b){return $(a,i.from(b))}}});
