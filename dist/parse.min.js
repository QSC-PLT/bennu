define(["require","exports","nu/stream","seshat"],function(ca,c,k,F){var p,M,t,e,l,u,v,r,h,j,G,n,x,H,q,A,N,y,da,O,ea,I,P,Q,R,S,z,T,B,s,U,V,W,fa,d,J,K,X,Y,Z,$,aa;s=k.end;var la=k.first,ma=k.isEmpty,na=k.rest,oa=Function.prototype.call.bind(Array.prototype.map),ba=Function.prototype.call.bind(Array.prototype.reduceRight),w=function(a){return function(){return a}},ga=Math.random;p=function(a,b){var g=[a,b];g._next=!0;return g};M=function(a){for(;a&&a._next;)a=a[0].apply(void 0,a[1]);return a};d=function(a,
b){this.memoer=a;this.frames=b};d.empty=new d(F.create(function(a,b){return a.compare(b)},function(a,b){return a.id===b.id&&(a.state===b.state||a.state&&a.state.eq(b.state))}),[]);d.pushWindow=function(a,b){return new d(a.memoer,[b].concat(a.frames))};d.popWindow=function(a){return new d(1===a.frames.length?F.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};d.lookup=function(a,b,g){return F.lookup(a.memoer,b,g)};d.update=function(a,b,g,c){return new d(F.update(a.memoer,b,g,c),a.frames)};j=
function(a){this.index=a};j.initial=new j(0);j.prototype.toString=function(){return""+this.index};j.prototype.increment=function(){return new j(this.index+1)};j.prototype.compare=function(a){return this.index-a.index};h=function(a,b,g){this.input=a;this.position=b;this.userState=g};h.prototype.eq=function(a){return a&&this.input===a.input&&this.userState===a.userState};h.prototype.isEmpty=function(){return ma(this.input)};h.prototype.first=function(){return la(this.input)};h.prototype.next=function(a){if(!this._next){var b=
new h(na(this.input),this.position.increment(a),this.userState);this._next=function(g,c,f){return f(a,b,c)}}return this._next};h.prototype.setInput=function(a){return new h(a,this.position,this.userState)};h.prototype.setPosition=function(a){return new h(this.input,a,this.userState)};h.prototype.setUserState=function(a){return new h(this.input,this.position,a)};t=function(a){this.message=a};t.prototype=Error();t.prototype.constructor=t;t.prototype.name="ParserError";e=function(a,b){this.position=
a;this._msg=b};e.prototype=Error();e.prototype.constructor=e;e.prototype.name="ParseError";e.prototype.toString=function(){return this.name+": "+this.message};Object.defineProperties(e.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});l=function(a,b){e.call(this,a);this.errors=b||[]};l.prototype=new e;l.prototype.constructor=l;l.prototype.name="MultipleError";
Object.defineProperty(l.prototype,"errorMessage",{get:function(){return"["+oa(this.errors,function(a){return a.message}).join(", ")+"]"}});var D=function(a,b,g){e.call(this,a);this._pErr=b;this._qErr=g};D.prototype=new l;D.prototype.constructor=l;D.prototype.name="ChoiceError";Object.defineProperty(D.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});u=function(a){e.call(this,a)};u.prototype=new e;u.prototype.constructor=u;u.prototype.name="UnknownError";Object.defineProperty(u.prototype,
"errorMessage",{value:"unknown error"});v=function(a,b){e.call(this,a);this.unexpected=b};v.prototype=new e;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});r=function(a,b,g){e.call(this,a);this.expected=b;this.found=g};r.prototype=new e;r.prototype.constructor=r;r.prototype.name="ExpectError";Object.defineProperty(r.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+
(this.found?" Found:"+this.found:"")}});G=function(a){var b=a(function(){return b.apply(this,arguments)});return b};n=function(a,b){return b.hasOwnProperty("parserId")?n(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:ga(),writable:!1}})};x=function(a){return function(b,g,c,f,i){return i(a,b,g)}};H=function(a){return function(b,g,c,f,i,d){return d(a,b,g)}};q=function(a,b){return function(g,c,f,i,d,m){return p(a,[g,c,function(a,
g,c){return p(b(a,g,c),[g,c,f,i,f,i])},i,function(a,g,c){return p(b(a,g,c),[g,c,f,i,d,m])},m])}};y=function(a){return function(b,g,c,f,i){b=a(b);return i(b,b,g)}};N=n("Get Parser State",y(function(a){return a}));A=function(a){return function(b,c,C,f,i){return i(a(b),b,c)}};O=function(a){return y(function(b){return b.setUserState(a(b.userState))})};da=n("Get State",A(function(a){return a.userState}));I=n("Get Position",A(function(a){return a.position}));ea=n("Get Input",A(function(a){return a.input}));
var ha=function(a){return q(I,function(b){return H(a(b))})};var pa=x(s),ca=n("EOF",q(N,function(a){return a.isEmpty()?pa:ha(function(b){return new r(b,"end of input",a.first())})}));P=function(a,b){return q(a,w(b))};var qa=function(a,b){return P(b,a)};Q=function(a){return ba(a,qa)};z=function(a){return function(b,c){return function(C,f,i,d,m,E){var L=C.position;return p(b,[C,f,i,d,m,function(b,f,e){return p(c,[C,e,i,d,m,function(c,g,f){return E(a(L,b,c),C,f)}])}])}}};R=z(function(a,b,c){return new l(a,
[b,c])});var ra=z(function(a,b,c){return new D(a,b,c)}),sa=function(a,b){return ra(b,a)},ta=q(I,function(a){return H(new l(a,[]))});S=function(a){if(!a.length)throw new t("choice called no parsers");return ba(a,sa,ta)};z=function(a,b){return R(b,x(a))};var ua=x(s),va=z.bind(null,s);s=function(a){return function(b,c){return q(b,function(b){return q(c,function(c){return x(a(b,c))})})}};var wa=function(a){return x(k.toArray(a))};T=function(a){return q(a,wa)};B=s(k.cons);s=s(k.append);var xa=function(a,
b){return B(b,a)};U=function(a){return ba(a,xa,ua)};var ia,ya=new t("Many parser applied to a parser that accepts an empty string");ia=function(){throw ya;};V=function(a){var b=function(b,c,f,i,d,m){return p(a,[b,c,f,i,ia,m])};return G(function(a){return va(B(b,a))})};var za=function(a,b){return new v(a,null===b?"end of input":b)};W=function(a,b){var c=b||za;return function(b,f,d,e,m,E){var L=b.position;if(b.isEmpty())return E(c(L,null),b,f);var h=b.first();return a(h)?b.next(h)(b,f,d,e,m,E):E(c(L,
h),b,f)}};fa=n("Any Token",W(w(!0)));J=function(a,b,c,d,f,i,e){return M(a(b,c,d,f,i,e))};K=function(a,b,c,e){return J(a,b,d.empty,c,e,c,e)};X=function(a,b,c,d,f){return K(a,new h(b,j.initial,c),d,f)};var Aa=function(a){return a},Ba=function(a){throw a;};Y=function(a,b){return K(a,b,Aa,Ba)};Z=function(a,b,c){return Y(a,new h(b,j.initial,c))};var ja=w(w(!0)),ka=w(w(!1));$=function(a,b){return J(a,b,d.empty,ja,ka,ja,ka)};aa=function(a,b,c){return $(a,new h(b,j.initial,c))};c.tail=p;c.trampoline=M;c.ParserError=
t;c.ParseError=e;c.MultipleError=l;c.UnknownError=u;c.UnexpectError=v;c.ExpectError=r;c.ParserState=h;c.Position=j;c.rec=G;c.Parser=n;c.RecParser=function(a,b){return n(a,G(b))};c.always=x;c.never=H;c.bind=q;c.eof=ca;c.extract=A;c.getParserState=N;c.setParserState=function(a){return y(w(a))};c.modifyParserState=y;c.getState=da;c.setState=function(a){return O(w(a))};c.modifyState=O;c.getInput=ea;c.setInput=function(a){return y(function(b){return b.setInput(a)})};c.getPosition=I;c.setPosition=function(a){return y(function(b){return b.setPosition(a)})};
c.fail=function(a){var b;var c=a?e:u;b=ha(function(b){return new c(b,a)});return b};c.attempt=function(a){return function(b,c,e,f,i,h){f=function(a,b,c){return h(a,b,d.popWindow(c))};return p(a,[b,d.pushWindow(c,b.position),function(a,b,c){return e(a,b,d.popWindow(c))},f,function(a,b,c){return i(a,b,d.popWindow(c))},f])}};c.lookahead=function(a){return function(b,c,d,f,e,h){return p(a,[b,c,function(a,c,g){return e(a,b,g)},f,e,h])}};c.next=P;c.sequencea=Q;c.sequence=function(){return Q(arguments)};
c.either=R;c.choicea=S;c.choice=function(){return S(arguments)};c.optional=z;c.expected=function(a,b){return function(c,d,f,e,h,m){return b(c,d,f,e,h,function(b,c,g){return m(new r(c.position,a),c,g)})}};c.eager=T;c.binds=function(a,b){return q(T(a),function(a){return b.apply(void 0,a)})};c.cons=B;c.append=s;c.enumerationa=U;c.enumeration=function(){return U(arguments)};c.many=V;c.many1=function(a){return B(a,V(a))};c.token=W;c.anyToken=fa;c.memo=function(a){var b=a.parserId||ga();return function(c,
e,f,h,l,m){var j=c.position,k={id:b,state:c},n=d.lookup(e,j,k);return n?p(n,[c,e,f,h,l,m]):p(a,[c,e,function(a,b,c){return f(a,b,d.update(c,j,k,function(c,d,e){return e(a,b,d)}))},function(a,b,c){return h(a,b,d.update(c,j,k,function(c,d,e,g){return g(a,b,d)}))},function(a,b,c){return l(a,b,d.update(c,j,k,function(c,d,e,g,f){return f(a,b,d)}))},function(a,b,c){return m(a,b,d.update(c,j,k,function(c,d,e,g,f,h){return h(a,b,d)}))}])}};c.Memoer=d;c.exec=J;c.parseState=K;c.parseStream=X;c.parse=function(a,
b,c,d,e){return X(a,k.from(b),c,d,e)};c.runState=Y;c.runStream=Z;c.run=function(a,b,c){return Z(a,k.from(b),c)};c.testState=$;c.testStream=aa;c.test=function(a,b,c){return aa(a,k.from(b),c)}});
