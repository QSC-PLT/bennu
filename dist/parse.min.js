define(["nu/stream"],function(i){var P=Array.prototype.map,Q=Array.prototype.reduceRight,H=function(a){return a.bind.apply(a,arguments)},j=function(a){return function(){return a}},R=function(a,b){return a===b},m=function(a,b){var c=[a,b];c._next=!0;return c},p=function(a,b,c,d){this.id=a;this.state=b;this.val=c;this.delegate=d};p.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;return null};p.update=function(a,b,c,d){return new p(b,c,d,a)};var q=function(a){this.index=
a};q.prototype.increment=function(){return new q(this.index+1)};q.prototype.toString=function(){return""+this.index};q.prototype.compare=function(a){return this.index-a.index};var l=function(a,b,c){this.input=a;this.position=b;this.userState=c};l.prototype.next=function(a){return this._next||(this._next=new l(i.rest(this.input),this.position.increment(a),this.userState))};l.prototype.eq=function(a){return 0===this.position.compare(a.position)};l.prototype.setInput=function(a){return new l(a,this.position,
this.userState)};l.prototype.setPosition=function(a){return new l(this.input,a,this.userState)};l.prototype.setUserState=function(a){return new l(this.input,this.position,a)};var y=function(a){this.message=a};y.prototype=Error();y.prototype.constructor=y;y.prototype.name="ParserError";var h=function(a,b){this.position=a;this._msg=b};h.prototype=Error();h.prototype.constructor=h;h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+
this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var n=function(a,b){h.call(this,a);this.errors=b||[]};n.prototype=new h;n.prototype.constructor=n;n.prototype.name="MultipleError";Object.defineProperty(n.prototype,"errorMessage",{get:function(){return"["+P.call(this.errors,function(a){return a.message}).join(", ")+"]"}});var z=function(a,b,c){h.call(this,a);this._pErr=b;this._qErr=c};z.prototype=new n;z.prototype.constructor=
n;z.prototype.name="ChoiceError";Object.defineProperty(z.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var s=function(a){h.call(this,a)};s.prototype=new h;s.prototype.constructor=s;s.prototype.name="UnknownError";Object.defineProperty(s.prototype,"errorMessage",{value:"unknown error"});var t=function(a,b){h.call(this,a);this.unexpected=b};t.prototype=new h;t.prototype.constructor=t;t.prototype.name="UnexpectError";Object.defineProperty(t.prototype,"errorMessage",
{get:function(){return"Unexpected:"+this.unexpected}});var r=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};r.prototype=new h;r.prototype.constructor=r;r.prototype.name="ExpectError";Object.defineProperty(r.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var C=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},I=function(a,b){return b.hasOwnProperty("parserId")?I(a,function(){return b.apply(this,
arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},u=function(a){return function(b,c,d,f,e){return e(a,b,c)}},J=function(a){var b=void 0===a?s:h;return function(c,d,f,e,g,k){return k(new b(c.position,a),c,d)}},v=function(a,b){return function(c,d,f,e,g,k){return m(a,[c,d,function(a,c,d){return m(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return m(b(a,c,d),[c,d,f,e,g,k])},k])}},A=function(a){return function(b,c,d,f,e){return e(a(b),
b,c)}},ga=j(A(function(a){return a})),K=function(a){return function(b,c,d,f,e){b=a(b);return e(b,b,c)}},ha=j(A(function(a){return a.userState})),L=function(a){return function(b,c,d,f,e){b=b.setUserState(a(b.userState));return e(b,b,c)}},ia=j(A(function(a){return a.position})),ja=j(A(function(a){return a.input})),S=function(a){return function(b,c,d,f,e,g){return m(a,[b,c,d,g,e,g])}},B=function(a,b){return v(a,j(b))},w=function(a){return function(b,c){return function(d,f,e,g,k,h){var fa=d.position;
return m(b,[d,f,e,g,k,function(b,f,i){return m(c,[d,i,e,g,k,function(c,e,f){return h(a(fa,b,c),d,f)}])}])}}},M=w(function(a,b,c){return new n(a,[b,c])}),ka=w(function(a,b,c){return new z(a,b,c)}),la=function(a,b){return ka(b,a)},ma=function(a,b,c,d,f,e){return e(new n(a.position,[]),a,b)},T=function(a,b){return M(a,u(b))},D=u(i.end),w=function(a){return function(b,c){return v(b,function(b){return v(c,function(c){return u(a(b,c))})})}},E=function(a){return T(a,i.end)},x=w(i.cons),U=w(i.append),na=
function(a,b){return x(b,a)},N,oa=function(){throw new y("Many parser applied to a parser that accepts an empty string");};N=function(a){var b=function(b,d,f,e,g,k){return m(a,[b,d,f,e,oa,k])};return C(function(a){return E(x(b,a))})};var O=function(a,b){return 0>=a?D:x(b,O(a-1,b))},V=function(a,b){return 0>=a?D:E(x(b,V(a-1,b)))},W=function(a,b){return v(a,function(a){return B(b,u(a))})},X=function(a,b){return C(function(c){return x(b,M(S(B(a,c)),D))})},F,pa=function(a,b){return new t(a,null===b?"end of input":
b)};F=function(a,b){b=b||pa;return function(c,d,f,e,g,k){e=c.position;return(g=c.input)?(g=i.first(g),a(g)?f(g,c.next(g),d):k(b(e,g),c,d)):k(b(e,null),c,d)}};var w=j(F(j(!0))),Y=function(a,b){return F(H(a,b))},qa=function(a,b){return B(b,a)},Z=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},$=function(a,b){return function(c,d,f){return Z(c,d,f||null,a,b,a,b)}},G=$(j,function(a){return function(){throw a;}}),aa=function(a,b,c){return G(a,new l(b,new q(0),
c||null))},ba=function(a,b){var c=E(v(a,function(a,b,e){return u(i.memoStream(a,H(G,c,b,e)))}));return G(c,b)},ca=function(a,b,c){return ba(a,new l(b,new q(0),c))},da=$(j(j(!0)),j(j(!1))),ea=function(a,b,c){return da(a,new l(b,new q(0),c))};return{ParserError:y,ParseError:h,MultipleError:n,UnknownError:s,UnexpectError:t,ExpectError:r,ParserState:l,Position:q,rec:C,Parser:I,RecParser:function(a,b){return I(a,C(b))},always:u,never:J,bind:v,binda:function(a,b){return v(a,function(a){return b.apply(void 0,
i.toArray(a))})},eof:function(){return function(a,b,c,d,f,e){return i.isEmpty(a.input)?f(i.end,a,b):e(new r(a.position,"end of input",i.first(a.input)),a,b)}},extract:A,getParserState:ga,setParserState:function(a){return K(j(a))},modifyParserState:K,getState:ha,setState:function(a){return L(j(a))},modifyState:L,getInput:ja,setInput:function(a){return L(function(b){return b.setInput(a)})},getPosition:ia,setPosition:function(a){return K(function(b){return b.setPosition(a)})},attempt:S,lookahead:function(a){return function(b,
c,d,f,e,g){return m(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:B,either:M,choice:function(){return 0===arguments.length?J():Q.call(arguments,la,ma)},optional:T,expected:function(a,b){return function(c,d,f,e,g,k){return b(c,d,f,e,g,function(b,c,d){return k(new r(c.position,a),c,d)})}},cons:x,append:U,sequence:function(){return Q.call(arguments,na,D)},many:N,many1:function(a){return x(a,N(a))},times:O,betweenTimes:function(a,b,c){return b<a?J:U(O(a,c),V(b-a,c))},then:W,between:function(a,
b,c){return B(a,W(c,b))},sepBy1:X,sepBy:function(a,b){return E(X(a,b))},token:F,anyToken:w,character:function(a,b){return Y(b||R,a)},string:function(a,b){return P.call(a,H(Y,b||R)).reduceRight(qa,u(a))},backtrack:function(a){return function(b,c,d,f,e,g){return m(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,h){var i=p.lookup(d,b,c);return i?
m(i,[c,d,f,e,g,h]):m(a,[c,d,function(a,d,e){return f(a,d,p.update(e,b,c,function(b,c,e){return e(a,d,c)}))},function(a,d,f){return e(a,d,p.update(f,b,c,function(b,c,e,f){return f(a,d,c)}))},function(a,d,e){return g(a,d,p.update(e,b,c,function(b,c,e,f,g){return g(a,d,c)}))},function(a,e,f){return h(a,e,p.update(d,b,c,function(b,c,d,g,h,i){return i(a,e,f)}))}])}},exec:Z,runState:G,runStream:aa,run:function(a,b,c){return aa(a,i.from(b),c)},runManyState:ba,runManyStream:ca,runMany:function(a,b,c){return ca(a,
i.from(b),c)},testState:da,testStream:ea,test:function(a,b,c){return ea(a,i.from(b),c)}}});
