define(["nu/stream","seshat"],function(h,A){var fa=Function.prototype.call.bind(Array.prototype.map),G=Function.prototype.call.bind(Array.prototype.reduceRight),Q=function(a){return a.bind.apply(a,arguments)},r=function(a){return function(){return a}},R=function(a){return function(){throw a;}},S=Math.random,m=function(a,b){var c=[a,b];c._next=!0;return c},g=function(a,b){this.memoer=a;this.frames=b};g.create=function(a){return new g(A.create(a),[])};g.pushWindow=function(a,b,c){return new g(a.memoer,
a.frames.concat([[b,c]]))};g.popWindow=function(a){return new g(a.memoer,a.frames.slice(a.frames.length-1))};g.lookup=function(a,b,c){return A.lookup(a.memoer,b,c)};g.update=function(a,b,c,d){b=A.update(a.memoer,b,c,d);return new g(a.frames[0]?A.prune(b,a.frames[0][0],a.frames[0][1]):b,a.frames)};var n=function(a){this.index=a};n.initial=new n(0);n.prototype.toString=function(){return""+this.index};n.prototype.increment=function(){return new n(this.index+1)};n.prototype.compare=function(a){return this.index-
a.index};var k=function(a,b,c){this.input=a;this.position=b;this.userState=c};k.prototype.next=function(a){this._next||(this._next=new k(h.rest(this.input),this.position.increment(a),this.userState));return this._next};k.prototype.setInput=function(a){return new k(a,this.position,this.userState)};k.prototype.setPosition=function(a){return new k(this.input,a,this.userState)};k.prototype.setUserState=function(a){return new k(this.input,this.position,a)};var t=function(a){this.message=a};t.prototype=
Error();t.prototype.constructor=t;t.prototype.name="ParserError";var j=function(a,b){this.position=a;this._msg=b};j.prototype=Error();j.prototype.constructor=j;j.prototype.name="ParseError";Object.defineProperties(j.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var p=function(a,b){j.call(this,a);this.errors=b||[]};p.prototype=new j;p.prototype.constructor=
p;p.prototype.name="MultipleError";Object.defineProperty(p.prototype,"errorMessage",{get:function(){return"["+fa(this.errors,function(a){return a.message}).join(", ")+"]"}});var x=function(a,b,c){j.call(this,a);this._pErr=b;this._qErr=c};x.prototype=new p;x.prototype.constructor=p;x.prototype.name="ChoiceError";Object.defineProperty(x.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var u=function(a){j.call(this,a)};u.prototype=new j;u.prototype.constructor=u;u.prototype.name=
"UnknownError";Object.defineProperty(u.prototype,"errorMessage",{value:"unknown error"});var v=function(a,b){j.call(this,a);this.unexpected=b};v.prototype=new j;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var s=function(a,b,c){j.call(this,a);this.expected=b;this.found=c};s.prototype=new j;s.prototype.constructor=s;s.prototype.name="ExpectError";Object.defineProperty(s.prototype,"errorMessage",
{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var H=function(a){var b=a(function(){return b.apply(this,arguments)});return b},B=function(a,b){return b.hasOwnProperty("parserId")?B(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:S(),writable:!1}})},w=function(a){return function(b,c,d,f,e){return e(a,b,c)}},I=function(a){return function(b,c,d,f,e,i){return i(a,b,c)}},q=function(a,b){return function(c,
d,f,e,i,l){return m(a,[c,d,function(a,c,d){return m(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return m(b(a,c,d),[c,d,f,e,i,l])},l])}},y=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},ga=y(function(a){return a}),C=function(a){return function(b,c,d,f,e){b=a(b);return e(b,b,c)}},ha=y(function(a){return a.userState}),J=function(a){return C(function(b){return b.setUserState(a(b.userState))})},K=y(function(a){return a.position}),T=y(function(a){return a.input}),U=function(a){return q(K,function(b){return I(a(b))})},
V,ia=w(h.end);V=q(T,function(a){return h.isEmpty(a)?ia:U(function(b){return new s(b,"end of input",h.first(a))})});var W=function(a,b){return q(a,r(b))},X,ja=function(a,b){return W(b,a)};X=function(a){return G(a,ja)};var z=function(a){return function(b,c){return function(d,f,e,i,l,g){var j=d.position;return m(b,[d,f,e,i,l,function(b,f,h){return m(c,[d,h,e,i,l,function(c,f,e){return g(a(j,b,c),d,e)}])}])}}},Y=z(function(a,b,c){return new p(a,[b,c])}),ka=z(function(a,b,c){return new x(a,b,c)}),la=function(a,
b){return ka(b,a)},ma=q(K,function(a){return I(new p(a,[]))}),z=function(a,b){return Y(b,w(a))},na=w(h.end),Z=Q(z,h.end),D=function(a){return function(b,c){return q(b,function(b){return q(c,function(c){return w(a(b,c))})})}},L,oa=function(a){return w(h.toArray(a))};L=function(a){return q(a,oa)};var E=D(h.cons),D=D(h.append),$,pa=function(a,b){return E(b,a)};$=function(a){return G(a,pa,na)};var M,qa=R(new t("Many parser applied to a parser that accepts an empty string"));M=function(a){var b=function(b,
d,f,e,i,l){return m(a,[b,d,f,e,qa,l])};return H(function(a){return Z(E(b,a))})};var N,ra=function(a,b){return new v(a,null===b?"end of input":b)};N=function(a,b){var c=b||ra;return function(b,f,e,i,l,g){i=b.position;return(l=b.input)?(l=h.first(l),a(l)?e(l,b.next(l),f):g(c(i,l),b,f)):g(c(i,null),b,f)}};var sa=B("Any Token",N(r(!0))),aa=function(a,b,c,d,f,e,i){for(a=a(b,c,d,f,e,i);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},O=function(a,b,c,d){return aa(a,b,g.create(function(a,b){return a.compare(b)}),
c,d,c,d)},F=function(a,b){return O(a,b,r,R)},ba=function(a,b,c){return F(a,new k(b,n.initial,c))},ca=function(a,b){var c=Z(q(a,function(a,b,e){return w(h.memoStream(a,Q(F,c,b,e)))}));return F(c,b)},da=function(a,b,c){return ca(a,new k(b,n.initial,c))},P,ta=r(r(!0)),ua=r(r(!1));P=function(a,b){return O(a,b,ta,ua)};var ea=function(a,b,c){return P(a,new k(b,n.initial,c))};return{ParserError:t,ParseError:j,MultipleError:p,UnknownError:u,UnexpectError:v,ExpectError:s,ParserState:k,Position:n,rec:H,Parser:B,
RecParser:function(a,b){return B(a,H(b))},always:w,never:I,bind:q,eof:V,extract:y,getParserState:ga,setParserState:function(a){return C(r(a))},modifyParserState:C,getState:ha,setState:function(a){return J(r(a))},modifyState:J,getInput:T,setInput:function(a){return J(function(b){return b.setInput(a)})},getPosition:K,setPosition:function(a){return C(function(b){return b.setPosition(a)})},fail:function(a){var b=a?j:u;return U(function(c){return new b(c,a)})},attempt:function(a){return function(b,c,d,
f,e,i){return m(a,[b,g.pushWindow(c,b.position),d,i,e,i])}},lookahead:function(a){return function(b,c,d,f,e,i){return m(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,i])}},next:W,sequence:function(){return X(arguments)},either:Y,choice:function(){if(!arguments.length)throw new t("choice called with no arguments");return G(arguments,la,ma)},optional:z,expected:function(a,b){return function(c,d,f,e,i,g){return b(c,d,f,e,i,function(b,c,d){return g(new s(c.position,a),c,d)})}},eager:L,binds:function(a,
b){return q(L(a),function(a){return b.apply(void 0,a)})},cons:E,append:D,enumeration:function(){return $(arguments)},many:M,many1:function(a){return E(a,M(a))},token:N,anyToken:sa,memo:function(a){var b=a.parserId||S();return function(c,d,f,e,i,j){var h=c.position,k=g.lookup(d,h,b);return k?m(k,[c,d,f,e,i,j]):m(a,[c,d,function(a,c,d){return f(a,c,g.update(d,h,b,function(b,d,e){return e(a,c,d)}))},function(a,c,d){return e(a,c,g.update(d,h,b,function(b,d,e,f){return f(a,c,d)}))},function(a,c,d){return i(a,
c,g.update(d,h,b,function(b,d,e,f,g){return g(a,c,d)}))},function(a,c,e){return j(a,c,g.update(d,h,b,function(b,d,f,g,i,h){return h(a,c,e)}))}])}},exec:aa,perform:function(a,b,c,d){return O(a,b,function(a){return function(){return c(a)}},function(a){return function(){return d(a)}})},runState:F,runStream:ba,run:function(a,b,c){return ba(a,h.from(b),c)},runManyState:ca,runManyStream:da,runMany:function(a,b,c){return da(a,h.from(b),c)},testState:P,testStream:ea,test:function(a,b,c){return ea(a,h.from(b),
c)}}});
