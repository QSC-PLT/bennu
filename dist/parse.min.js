define(["stream"],function(i){var da=Array.prototype.join,ea=Array.prototype.map,M=Array.prototype.reduceRight,m=function(a){return 1===arguments.length?a:a.bind.apply(a,arguments)},z=function(a){return a},j=m(m,z),N=function(a,b){return a===b},k=function(a,b){var c=[a,b];c._next=!0;return c},O=function(a){for(;a&&a._next;)a=a[0].apply(void 0,a[1]);return a},x=function(a,b,c,d){this.id=a;this.val=b;this.state=c;this.delegate=d};x.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;
return null};x.update=function(a,b,c,d){return new x(b,c,d,a)};var l=function(a,b){this.line=a;this.column=b};l.prototype.increment=function(a){return"\n"===a?new l(this.line+1,1):new l(this.line,this.column+1)};l.prototype.toString=function(){return"{line: "+this.line+" col: "+this.column+"}"};l.prototype.eq=function(a){return this.line===a.line&&this.column===a.column};var p=function(a,b){this.input=a;this.pos=b};p.prototype.next=function(a){return this._next||(this._next=new p(i.rest(this.input),
this.pos.increment(a)))};p.prototype.eq=function(a){return this.pos.eq(a.pos)};var h=function(a,b){this._messages=b;this.pos=a};h.prototype=Error();h.prototype.constructor=h;h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{get:function(){var a=this.messages;return"At position:"+this.pos+" ["+(a?da.call(a,", "):"")+"]"}},messages:{get:function(){return this._messages}}});var t=function(a,b){this.e1=a;this.e2=b;h.call(this,a.pos)};t.prototype=new h;t.prototype.constructor=
t;t.prototype.name="MultipleError";Object.defineProperty(t.prototype,"messages",{get:function(){return[this.e1.messsage,this.e2.message]}});var u=function(a){h.call(this,a,["Error"])};u.prototype=new h;u.prototype.constructor=u;u.prototype.name="UnknownError";var q=function(a,b){h.call(this,a,b?["Unexpected "+b]:b)};q.prototype=new h;q.prototype.constructor=q;q.prototype.name="UnexpectError";var v=function(a,b){h.call(this,a,["Expected "+(b||"")])};v.prototype=new h;v.prototype.constructor=v;v.prototype.name=
"ExpectError";var F=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},P=function(a,b){return Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},r=function(a){return function(b,c,d,f,e){return e(a,b,c)}},G=j(function(a,b,c,d,f,e){return e(new u(a.pos),a,b)}),w=function(a,b){return function(c,d,f,e,g,n){return k(a,[c,d,function(a,c,d){return k(b(a,c),[c,d,f,e,f,e])},e,function(a,c,d){return k(b(a,c),[c,d,f,e,g,n])},n])}},
Q=function(a,b){return w(a,function(a){return b.apply(void 0,i.toArray(a))})},fa=j(function(a,b,c,d,f,e){return!a.input?f(null,a,b):e(new v(a.pos,"end of input"),a,b)}),R=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},z=m(R,z),H=function(a,b){return w(a,j(b))},I=function(a,b){return function(c,d,f,e,g,n){return k(a,[c,d,f,e,g,function(a,d,h){return k(b,[c,h,f,e,g,function(b,d,e){return n(new t(a,b),c,e)}])}])}},ga=function(a,b){return I(b,a)},S=function(a,b){return I(a,r(b))},J=r(i.end),
A=function(a,b,c){return w(b,function(b){return w(c,function(c){return r(a(b,c))})})},B=function(a){return S(a,i.end)},s=m(A,i.cons),T=m(A,i.concat),K,ha=function(a,b){return s(b,a)};K=function(){return M.call(arguments,ha,J)};var C,ia=function(){throw Error("Many parser applied to a parser that accepts an empty string");};C=function(a){var b=function(b,d,f,e,g,n){return k(a,[b,d,f,e,ia,n])};return F(function(a){return B(s(b,a))})};var L=function(a,b){return 0>=a?J:s(b,L(a-1,b))},U=function(a,b){return 0>=
a?J:B(s(b,U(a-1,b)))},ja=function(a,b){return r(b)},V=function(a,b){return s(b,C(H(a,b)))},D,y=function(a,b){h.call(this,a);this.tok=b};y.prototype=new q;y.prototype.constructor=y;Object.defineProperty(y.prototype,"message",{get:function(){return"Unexpected "+this.tok}});D=function(a){return function(b,c,d,f,e,g){f=b.pos;return(e=b.input)?(e=i.first(e),a(e)?d(e,b.next(e),c):g(new y(f,e),b,c)):g(new q(f,"end of input"),b,c)}};var A=D(j(!0)),W=function(a,b){return D(m(a,b))},ka=function(a,b){return H(b,
a)},la=function(a,b){return function(c,d,f){return f(a,b,d)}},ma=function(a,b){return function(c,d,f,e){return e(a,b,d)}},na=function(a,b){return function(c,d,f,e,g){return g(a,b,d)}},oa=function(a,b){return function(c,d,f,e,g,n){return n(a,b,d)}},X=function(a,b,c,d,f,e){return O(a(b,null,c,d,f,e))()},Y=function(a,b){return function(c,d){return X(c,d,a,b,a,b)}},E=Y(j,function(a){return function(){throw a;}}),Z=function(a,b){return E(a,new p(b,new l(1,0)))},$=function(a,b){var c=B(w(a,function(a,b){return r(i.stream(a,
m(E,c,b)))}));return E(c,b)},aa=function(a,b){return $(a,new p(b,new l(1,0)))},ba=Y(j(j(!0)),j(j(!1))),ca=function(a,b){return ba(a,new p(b,new l(1,0)))};return{ParseError:h,UnknownError:u,UnexpectError:q,ExpectError:v,InputState:p,Position:l,rec:F,Parser:P,RecParser:function(a,b){return P(a,F(b))},always:r,never:G,bind:w,binda:Q,eof:fa,extract:R,examine:z,attempt:function(a){return function(b,c,d,f,e,g){return k(a,[b,c,d,g,e,g])}},lookahead:function(a){return function(b,c,d,f,e,g){return k(a,[b,
c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:H,either:I,choice:function(){return 0===arguments.length?G:M.call(arguments,ga)},optional:S,consParser:s,concatParser:T,sequence:K,many:C,many1:function(a){return s(a,C(a))},times:L,betweenTimes:function(a,b,c){return b<a?G:T(L(a,c),U(b-a,c))},between:function(a,b,c){return Q(K(a,c,b),ja)},sepBy1:V,sepBy:function(a,b){return B(V(a,b))},token:D,anyToken:A,character:function(a,b){return W(b||N,a)},string:function(a,b){return ea.call(a,m(W,b||N)).reduceRight(ka,
r(a))},backtrack:function(a){return function(b,c,d,f,e,g){return k(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,h){var i=x.lookup(d,b,c);i||(i=O(a(c,d,la,ma,na,oa)),d=x.update(d,b,i,c));return i(c,d,f,e,g,h)}},exec:X,runState:E,runStream:Z,run:function(a,b){return Z(a,i.from(b))},runManyState:$,runManyStream:aa,runMany:function(a,b){return aa(a,
i.from(b))},testState:ba,testStream:ca,test:function(a,b){return ca(a,i.from(b))}}});
