define(["nu/stream"],function(j){var Q=Function.prototype.call.bind(Array.prototype.map),R=Function.prototype.call.bind(Array.prototype.reduceRight),B=function(a){return a.bind.apply(a,arguments)},h=function(a){return function(){return a}},G=function(a){return function(){throw a;}},S=function(a,b){return a===b},m=function(a,b){var c=[a,b];c._next=!0;return c},q=function(a,b,c,d){this.id=a;this.state=b;this.val=c;this.delegate=d};q.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;
return null};q.update=function(a,b,c,d){return new q(b,c,d,a)};var n=function(a){this.index=a};n.initial=new n(0);n.prototype.increment=function(){return new n(this.index+1)};n.prototype.toString=function(){return""+this.index};n.prototype.compare=function(a){return this.index-a.index};var k=function(a,b,c){this.input=a;this.position=b;this.userState=c};k.prototype.next=function(a){return this._next||(this._next=new k(j.rest(this.input),this.position.increment(a),this.userState))};k.prototype.eq=
function(a){return 0===this.position.compare(a.position)};k.prototype.setInput=function(a){return new k(a,this.position,this.userState)};k.prototype.setPosition=function(a){return new k(this.input,a,this.userState)};k.prototype.setUserState=function(a){return new k(this.input,this.position,a)};var r=function(a){this.message=a};r.prototype=Error();r.prototype.constructor=r;r.prototype.name="ParserError";var i=function(a,b){this.position=a;this._msg=b};i.prototype=Error();i.prototype.constructor=i;
i.prototype.name="ParseError";Object.defineProperties(i.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var p=function(a,b){i.call(this,a);this.errors=b||[]};p.prototype=new i;p.prototype.constructor=p;p.prototype.name="MultipleError";Object.defineProperty(p.prototype,"errorMessage",{get:function(){return"["+Q(this.errors,function(a){return a.message}).join(", ")+
"]"}});var y=function(a,b,c){i.call(this,a);this._pErr=b;this._qErr=c};y.prototype=new p;y.prototype.constructor=p;y.prototype.name="ChoiceError";Object.defineProperty(y.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var u=function(a){i.call(this,a)};u.prototype=new i;u.prototype.constructor=u;u.prototype.name="UnknownError";Object.defineProperty(u.prototype,"errorMessage",{value:"unknown error"});var v=function(a,b){i.call(this,a);this.unexpected=b};v.prototype=
new i;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var s=function(a,b,c){i.call(this,a);this.expected=b;this.found=c};s.prototype=new i;s.prototype.constructor=s;s.prototype.name="ExpectError";Object.defineProperty(s.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var H=function(a){var b;return b=a(function(){return b.apply(this,
arguments)})},I=function(a,b){return b.hasOwnProperty("parserId")?I(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},w=function(a){return function(b,c,d,f,e){return e(a,b,c)}},T=function(a){return function(b,c,d,f,e,g){return g(a,b,c)}},t=function(a,b){return function(c,d,f,e,g,l){return m(a,[c,d,function(a,c,d){return m(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return m(b(a,c,d),[c,d,f,e,g,l])},
l])}},z=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},fa=h(z(function(a){return a})),J=function(a){return function(b,c,d,f,e){b=a(b);return e(b,b,c)}},ga=h(z(function(a){return a.userState})),K=function(a){return function(b,c,d,f,e){b=b.setUserState(a(b.userState));return e(b,b,c)}},U=h(z(function(a){return a.position})),ha=h(z(function(a){return a.input})),V=function(a,b){return t(a,h(b))},A=function(a){return function(b,c){return function(d,f,e,g,l,i){var ea=d.position;return m(b,
[d,f,e,g,l,function(b,f,h){return m(c,[d,h,e,g,l,function(c,e,f){return i(a(ea,b,c),d,f)}])}])}}},W=A(function(a,b,c){return new p(a,[b,c])}),ia=A(function(a,b,c){return new y(a,b,c)}),ja=function(a,b){return ia(b,a)},ka=function(a,b,c,d,f,e){return e(new p(a.position,[]),a,b)},A=function(a,b){return W(b,w(a))},L=w(j.end),C=function(a){return function(b,c){return t(b,function(b){return t(c,function(c){return w(a(b,c))})})}},M=B(A,j.end),N,la=function(a){return w(j.toArray(a))};N=function(a){return t(a,
la)};var x=C(j.cons),X=C(j.append),ma=function(a,b){return x(b,a)},O,na=G(new r("Many parser applied to a parser that accepts an empty string"));O=function(a){var b=function(b,d,f,e,g,l){return m(a,[b,d,f,e,na,l])};return H(function(a){return M(x(b,a))})};var P=function(a,b){return 0>=a?L:x(b,P(a-1,b))},Y=function(a,b){return 0>=a?L:M(x(b,Y(a-1,b)))},D,oa=function(a,b){return new v(a,null===b?"end of input":b)};D=function(a,b){b=b||oa;return function(c,d,f,e,g,l){e=c.position;return(g=c.input)?(g=
j.first(g),a(g)?f(g,c.next(g),d):l(b(e,g),c,d)):l(b(e,null),c,d)}};var C=h(D(h(!0))),Z=function(a,b){return D(B(a,b))},pa=function(a,b){return V(b,a)},E=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},F=function(a,b){return E(a,b,null,h,G,h,G)},$=function(a,b,c){return F(a,new k(b,n.initial,c))},aa=function(a,b){var c=M(t(a,function(a,b,e){return w(j.memoStream(a,B(F,c,b,e)))}));return F(c,b)},ba=function(a,b,c){return aa(a,new k(b,n.initial,c))},ca=
function(a,b){var c=h(h(!0)),d=h(h(!1));return E(a,b,null,c,d,c,d)},da=function(a,b,c){return ca(a,new k(b,n.initial,c))};return{ParserError:r,ParseError:i,MultipleError:p,UnknownError:u,UnexpectError:v,ExpectError:s,ParserState:k,Position:n,rec:H,Parser:I,RecParser:function(a,b){return I(a,H(b))},always:w,never:T,bind:t,eof:function(){return function(a,b,c,d,f,e){return j.isEmpty(a.input)?f(j.end,a,b):e(new s(a.position,"end of input",j.first(a.input)),a,b)}},extract:z,getParserState:fa,setParserState:function(a){return J(h(a))},
modifyParserState:J,getState:ga,setState:function(a){return K(h(a))},modifyState:K,getInput:ha,setInput:function(a){return K(function(b){return b.setInput(a)})},getPosition:U,setPosition:function(a){return J(function(b){return b.setPosition(a)})},fail:function(a){var b=a?i:u;return t(U(),function(c){return T(new b(c,a))})},attempt:function(a){return function(b,c,d,f,e,g){return m(a,[b,c,d,g,e,g])}},lookahead:function(a){return function(b,c,d,f,e,g){return m(a,[b,c,function(a,c,d){return e(a,b,d)},
f,e,g])}},next:V,either:W,choice:function(){if(!arguments.length)throw new r("choice called with no arguments");return R(arguments,ja,ka)},optional:A,expected:function(a,b){return function(c,d,f,e,g,l){return b(c,d,f,e,g,function(b,c,d){return l(new s(c.position,a),c,d)})}},eager:N,binds:function(a,b){return t(N(a),function(a){return b.apply(void 0,a)})},cons:x,append:X,sequence:function(){return R(arguments,ma,L)},many:O,many1:function(a){return x(a,O(a))},times:P,betweenTimes:function(a,b,c){if(b<
a)throw new r("between max < min");return X(P(a,c),Y(b-a,c))},token:D,anyToken:C,character:function(a,b){return Z(b||S,a)},string:function(a,b){return Q(a,B(Z,b||S)).reduceRight(pa,w(a))},backtrack:function(a){return function(b,c,d,f,e,g){return m(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,i){var h=q.lookup(d,b,c);return h?m(h,[c,d,
f,e,g,i]):m(a,[c,d,function(a,d,e){return f(a,d,q.update(e,b,c,function(b,c,e){return e(a,d,c)}))},function(a,d,f){return e(a,d,q.update(f,b,c,function(b,c,e,f){return f(a,d,c)}))},function(a,d,e){return g(a,d,q.update(e,b,c,function(b,c,e,f,g){return g(a,d,c)}))},function(a,e,f){return i(a,e,q.update(d,b,c,function(b,c,d,g,i,h){return h(a,e,f)}))}])}},exec:E,perform:function(a,b,c,d){var f=function(a){return function(){return c(a)}},e=function(a){return function(){return d(a)}};return E(a,b,null,
f,e,f,e)},runState:F,runStream:$,run:function(a,b,c){return $(a,j.from(b),c)},runManyState:aa,runManyStream:ba,runMany:function(a,b,c){return ba(a,j.from(b),c)},testState:ca,testStream:da,test:function(a,b,c){return da(a,j.from(b),c)}}});
