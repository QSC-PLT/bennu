define(["stream/stream"],function(i){var aa=Array.prototype.join,ba=Array.prototype.map,K=Array.prototype.reduceRight,t=function(a){return 1===arguments.length?a:a.bind.apply(a,arguments)},m=function(a){return function(){return a}},L=function(a,b){return a===b},j=function(a,b){var c=[a,b];c._next=!0;return c},k=function(a,b,c,e){this.id=a;this.val=b;this.state=c;this.delegate=e};k.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;return null};k.update=function(a,b,
c,e){return new k(b,c,e,a)};var l=function(a){this.index=a};l.prototype.increment=function(){return new l(this.index+1)};l.prototype.toString=function(){return""+this.index};l.prototype.compare=function(a){return this.index-a.index};var n=function(a,b){this.input=a;this.pos=b};n.prototype.next=function(a){return this._next||(this._next=new n(i.rest(this.input),this.pos.increment(a)))};n.prototype.eq=function(a){return 0===this.pos.compare(a.pos)};var g=function(a,b){this._messages=b;this.pos=a};g.prototype=
Error();g.prototype.constructor=g;g.prototype.name="ParseError";Object.defineProperties(g.prototype,{message:{get:function(){var a=this.messages;return"At position:"+this.pos+" ["+(a?aa.call(a,", "):"")+"]"}},messages:{get:function(){return this._messages}}});var u=function(a,b){this.e1=a;this.e2=b;g.call(this,a.pos)};u.prototype=new g;u.prototype.constructor=u;u.prototype.name="MultipleError";Object.defineProperty(u.prototype,"messages",{get:function(){var a=this.e1.messsage;return a?[a,this.e2.message]:
[this.e2.message]}});var v=function(a){g.call(this,a,["Error"])};v.prototype=new g;v.prototype.constructor=v;v.prototype.name="UnknownError";var p=function(a,b){g.call(this,a,b?["Unexpected "+b]:b)};p.prototype=new g;p.prototype.constructor=p;p.prototype.name="UnexpectError";var w=function(a,b){g.call(this,a,["Expected "+(b||"")])};w.prototype=new g;w.prototype.constructor=w;w.prototype.name="ExpectError";var A=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},M=function(a,
b){return Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},q=function(a){return function(b,c,e,f,d){return d(a,b,c)}},H=function(){return function(a,b,c,e,f,d){return d(new v(a.pos),a,b)}},r=function(a,b){return function(c,e,f,d,h,x){return j(a,[c,e,function(a,c,e){return j(b(a,c,e),[c,e,f,d,f,d])},d,function(a,c,e){return j(b(a,c,e),[c,e,f,d,h,x])},x])}},N=function(a){return function(b,c,e,f,d){return d(a(b),b,c)}},ca=t(N,function(a){return a}),
O=function(a){return function(b,c,e,f,d,h){return j(a,[b,c,e,h,d,h])}},y=function(a,b){return r(a,m(b))},B=function(a,b){return function(c,e,f,d,h,x){return j(a,[c,e,f,d,h,function(a,e,g){return j(b,[c,g,f,d,h,function(b,e,d){return x(new u(a,b),c,d)}])}])}},da=function(a,b){return B(b,a)},P=function(a,b){return B(a,q(b))},C=q(i.end),D=function(a,b,c){return r(b,function(b){return r(c,function(c){return q(a(b,c))})})},E=function(a){return P(a,i.end)},s=t(D,i.cons),Q=t(D,i.concat),ea=function(a,b){return s(b,
a)},I,fa=function(){throw Error("Many parser applied to a parser that accepts an empty string");};I=function(a){var b=function(b,e,f,d,h,x){return j(a,[b,e,f,d,fa,x])};return A(function(a){return E(s(b,a))})};var J=function(a,b){return 0>=a?C:s(b,J(a-1,b))},R=function(a,b){return 0>=a?C:E(s(b,R(a-1,b)))},S=function(a,b){return A(function(c){return s(b,B(O(y(a,c)),C))})},F,z=function(a,b){g.call(this,a);this.tok=b};z.prototype=new p;z.prototype.constructor=z;Object.defineProperty(z.prototype,"message",
{get:function(){return"Unexpected "+this.tok}});F=function(a){return function(b,c,e,f,d,h){f=b.pos;return(d=b.input)?(d=i.first(d),a(d)?e(d,b.next(d),c):h(new z(f,d),b,c)):h(new p(f,"end of input"),b,c)}};var D=F(m(!0)),T=function(a,b){return F(t(a,b))},ga=function(a,b){return y(b,a)},U=function(a,b,c,e,f,d,h){for(a=a(b,c,e,f,d,h);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},V=function(a,b){return function(c,e,f){return U(c,e,f||null,a,b,a,b)}},G=V(m,function(a){return function(){throw a;}}),
W=function(a,b){return G(a,new n(b,new l(0)))},X=function(a,b){var c=E(r(a,function(a,b,d){return q(i.memoStream(a,t(G,c,b,d)))}));return G(c,b)},Y=function(a,b){return X(a,new n(b,new l(0)))},Z=V(m(m(!0)),m(m(!1))),$=function(a,b){return Z(a,new n(b,new l(0)))};return{ParseError:g,UnknownError:v,UnexpectError:p,ExpectError:w,InputState:n,Position:l,rec:A,Parser:M,RecParser:function(a,b){return M(a,A(b))},always:q,never:H,bind:r,binda:function(a,b){return r(a,function(a){return b.apply(void 0,i.toArray(a))})},
eof:function(){return function(a,b,c,e,f,d){return i.isEmpty(a.input)?f(i.end,a,b):d(new w(a.pos,"end of input, found:"+i.first(a.input)),a,b)}},extract:N,examine:ca,attempt:O,lookahead:function(a){return function(b,c,e,f,d,h){return j(a,[b,c,function(a,c,e){return d(a,b,e)},f,d,h])}},next:y,either:B,choice:function(){return 0===arguments.length?H:K.call(arguments,da)},optional:P,consParser:s,concatParser:Q,sequence:function(){return K.call(arguments,ea,C)},many:I,many1:function(a){return s(a,I(a))},
times:J,betweenTimes:function(a,b,c){return b<a?H:Q(J(a,c),R(b-a,c))},between:function(a,b,c){return y(a,r(c,function(a){return y(b,q(a))}))},sepBy1:S,sepBy:function(a,b){return E(S(a,b))},token:F,anyToken:D,character:function(a,b){return T(b||L,a)},string:function(a,b){return ba.call(a,t(T,b||L)).reduceRight(ga,q(a))},backtrack:function(a){return function(b,c,e,f,d,h){return j(a,[b,c,function(a,b){return e(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return d(a,b,c)},function(a,b){return h(a,
b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,e,f,d,h,g){var i=k.lookup(e,b,c);return i?j(i,[c,e,f,d,h,g]):j(a,[c,e,function(a,d,e){return f(a,d,k.update(e,b,function(b,c,e){return e(a,d,c)},c))},function(a,e,f){return d(a,e,k.update(f,b,function(b,c,d,f){return f(a,e,c)},c))},function(a,e,d){return h(a,e,k.update(d,b,function(b,c,d,f,g){return g(a,e,c)},c))},function(a,d,f){return g(a,d,k.update(e,b,function(b,c,e,g,h,i){return i(a,d,f)},c))}])}},exec:U,runState:G,
runStream:W,run:function(a,b){return W(a,i.from(b))},runManyState:X,runManyStream:Y,runMany:function(a,b){return Y(a,i.from(b))},testState:Z,testStream:$,test:function(a,b){return $(a,i.from(b))}}});
