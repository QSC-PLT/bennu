define(["stream"],function(f){var Z=Array.prototype.join,$=Array.prototype.map,I=Array.prototype.reduceRight,j=function(a){return 1===arguments.length?a:a.bind.apply(a,arguments)},v=function(a){return a},h=j(j,v),J=function(a,b){return a===b},k=function(a,b){var c=[a,b];c._next=!0;return c},i,aa=function(){return"{line: "+this.line+" col: "+this.column+"}"};i=function(a,b){return Object.freeze({line:a,column:b,toString:aa})};i.increment=function(a,b){return"\n"===b?i(a.line+1,1):i(a.line,a.column+
1)};var p=function(a,b){this.input=a;this.pos=b};p.prototype.next=function(a){return this._next||(this._next=new p(f.rest(this.input),i.increment(this.pos,a)))};var e=function(a,b){this._messages=b;this.pos=a};e.prototype=Error();e.prototype.constructor=e;e.prototype.name="ParseError";Object.defineProperties(e.prototype,{message:{get:function(){var a=this.messages;return"At position:"+this.pos+" ["+(a?Z.call(a,", "):"")+"]"}},messages:{get:function(){return this._messages}}});var q=function(a,b){this.e1=
a;this.e2=b;e.call(this,a.pos)};q.prototype=new e;q.prototype.constructor=q;q.prototype.name="MultipleError";Object.defineProperty(q.prototype,"messages",{get:function(){return[this.e1.messsage,this.e2.message]}});var r=function(a){e.call(this,a,["Error"])};r.prototype=new e;r.prototype.constructor=r;r.prototype.name="UnknownError";var l=function(a,b){e.call(this,a,b?["Unexpected "+b]:b)};l.prototype=new e;l.prototype.constructor=l;l.prototype.name="UnexpectError";var s=function(a,b){e.call(this,
a,["Expected "+(b||"")])};s.prototype=new e;s.prototype.constructor=s;s.prototype.name="ExpectError";var K=function(a,b){return Object.defineProperty(b,"displayName",{value:a,writable:!1})},B=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},m=function(a){return function(b,c,g,d){return d(a,b)}},C=h(function(a,b,c,g,d){return d(new r(a.pos))}),t=function(a,b){return function(c,g,d,e,f){return k(a,[c,function(a,c){return k(b(a,c),[c,g,d,g,d])},d,function(a,c){return k(b(a,c),
[c,g,d,e,f])},f])}},L=function(a,b){return t(a,function(a){return b.apply(void 0,f.toArray(a))})},ba=h(function(a,b,c,g,d){return!a.input?g(null,a):d(new s(a.pos,"end of input"))}),M=function(a){return function(b,c,g,d){return d(a(b),b)}},v=j(M,v),D=function(a,b){return t(a,h(b))},E=function(a,b){return function(c,g,d,e,f){return k(a,[c,g,d,e,function(a){return k(b,[c,g,d,e,function(b){return f(new q(a,b))}])}])}},ca=function(a,b){return E(b,a)},N=function(a,b){return E(a,m(b))},F=m(f.end),w=function(a,
b,c){return t(b,function(b){return t(c,function(c){return m(a(b,c))})})},x=function(a){return N(a,f.end)},n=j(w,f.cons),O=j(w,f.concat),G,da=function(a,b){return n(b,a)};G=function(){return I.call(arguments,da,F)};var y,ea=function(){throw Error("Many parser applied to a parser that accepts an empty string");};y=function(a){var b=function(b,g,d,e,f){return k(a,[b,g,d,ea,f])};return B(function(a){return x(n(b,a))})};var H=function(a,b){return 0>=a?F:n(b,H(a-1,b))},P=function(a,b){return 0>=a?F:x(n(b,
P(a-1,b)))},fa=function(a,b){return m(b)},Q=function(a,b){return n(b,y(D(a,b)))},z,u=function(a,b){e.call(this,a);this.tok=b};u.prototype=new l;u.prototype.constructor=u;Object.defineProperty(u.prototype,"message",{get:function(){return"Unexpected "+tok}});z=function(a){return function(b,c,g,d,e){g=b.pos;return(d=b.input)?(d=f.first(d),a(d)?c(d,b.next(d)):e(new u(g,d))):e(new l(g,"end of input"))}};var w=z(h(!0)),R=function(a,b){return z(j(a,b))},ga=function(a,b){return D(b,a)},S=function(a,b,c,g,
d,e){for(a=a(b,c,g,d,e);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},T=function(a,b){return function(c,e){return S(c,e,a,b,a,b)}},A=T(h,function(a){return function(){throw a;}}),U=function(a,b){return A(a,new p(b,i(1,0)))},V=function(a,b){var c=x(t(a,function(a,b){return m(f.stream(a,j(A,c,b)))}));return A(c,b)},W=function(a,b){return V(a,new p(b,i(1,0)))},X=T(h(h(!0)),h(h(!1))),Y=function(a,b){return X(a,new p(b,i(1,0)))};return{ParseError:e,UnknownError:r,UnexpectError:l,ExpectError:s,InputState:p,
Position:i,Parser:K,RecParser:B,NamedRecParser:function(a,b){return K(a,B(b))},always:m,never:C,bind:t,binda:L,eof:ba,extract:M,examine:v,attempt:function(a){return function(b,c,e,d,f){return k(a,[b,c,f,d,f])}},lookahead:function(a){return function(b,c,e,d,f){return k(a,[b,function(a){return d(a,b)},e,d,f])}},next:D,either:E,choice:function(){return 0===arguments.length?C:I.call(arguments,ca)},optional:N,consParser:n,concatParser:O,sequence:G,many:y,many1:function(a){return n(a,y(a))},times:H,betweenTimes:function(a,
b,c){return b<a?C:O(H(a,c),P(b-a,c))},between:function(a,b,c){return L(G(a,c,b),fa)},sepBy1:Q,sepBy:function(a,b){return x(Q(a,b))},token:z,anyToken:w,character:function(a,b){return R(b||J,a)},string:function(a,b){return $.call(a,j(R,b||J)).reduceRight(ga,m(a))},exec:S,runState:A,runStream:U,run:function(a,b){return U(a,f.from(b))},runManyState:V,runManyStream:W,runMany:function(a,b){return W(a,f.from(b))},testState:X,testStream:Y,test:function(a,b){return Y(a,f.from(b))}}});
