define(["stream"],function(j){var ca=Array.prototype.join,da=Array.prototype.map,M=Array.prototype.reduceRight,m=function(a){return 1===arguments.length?a:a.bind.apply(a,arguments)},B=function(a){return a},l=m(m,B),N=function(a,b){return a===b},k=function(a,b){var c=[a,b];c._next=!0;return c},n=function(a,b,c,e){this.id=a;this.val=b;this.state=c;this.delegate=e};n.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;return null};n.update=function(a,b,c,e){return new n(b,
c,e,a)};var p=function(a){this.index=a};p.prototype.increment=function(){return new p(this.index+1)};p.prototype.toString=function(){return""+i};p.prototype.eq=function(a){return this.index===a.index};var q=function(a,b){this.input=a;this.pos=b};q.prototype.next=function(a){return this._next||(this._next=new q(j.rest(this.input),this.pos.increment(a)))};q.prototype.eq=function(a){return this.pos.eq(a.pos)};var g=function(a,b){this._messages=b;this.pos=a};g.prototype=Error();g.prototype.constructor=
g;g.prototype.name="ParseError";Object.defineProperties(g.prototype,{message:{get:function(){var a=this.messages;return"At position:"+this.pos+" ["+(a?ca.call(a,", "):"")+"]"}},messages:{get:function(){return this._messages}}});var v=function(a,b){this.e1=a;this.e2=b;g.call(this,a.pos)};v.prototype=new g;v.prototype.constructor=v;v.prototype.name="MultipleError";Object.defineProperty(v.prototype,"messages",{get:function(){var a=this.e1.messsage;return a?[a,this.e2.message]:[this.e2.message]}});var w=
function(a){g.call(this,a,["Error"])};w.prototype=new g;w.prototype.constructor=w;w.prototype.name="UnknownError";var r=function(a,b){g.call(this,a,b?["Unexpected "+b]:b)};r.prototype=new g;r.prototype.constructor=r;r.prototype.name="UnexpectError";var x=function(a,b){g.call(this,a,["Expected "+(b||"")])};x.prototype=new g;x.prototype.constructor=x;x.prototype.name="ExpectError";var C=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},O=function(a,b){return Object.defineProperties(b,
{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},s=function(a){return function(b,c,e,f,d){return d(a,b,c)}},J=l(function(a,b,c,e,f,d){return d(new w(a.pos),a,b)}),t=function(a,b){return function(c,e,f,d,h,y){return k(a,[c,e,function(a,c,e){return k(b(a,c,e),[c,e,f,d,f,d])},d,function(a,c,e){return k(b(a,c,e),[c,e,f,d,h,y])},y])}},ea=l(function(a,b,c,e,f,d){return!a.input?f(null,a,b):d(new x(a.pos,"end of input"),a,b)}),P=function(a){return function(b,c,e,f,d){return d(a(b),
b,c)}},B=m(P,B),Q=function(a){return function(b,c,e,f,d,h){return k(a,[b,c,e,h,d,h])}},z=function(a,b){return t(a,l(b))},D=function(a,b){return function(c,e,f,d,h,y){return k(a,[c,e,f,d,h,function(a,e,g){return k(b,[c,g,f,d,h,function(b,e,d){return y(new v(a,b),c,d)}])}])}},fa=function(a,b){return D(b,a)},R=function(a,b){return D(a,s(b))},E=s(j.end),F=function(a,b,c){return t(b,function(b){return t(c,function(c){return s(a(b,c))})})},G=function(a){return R(a,j.end)},u=m(F,j.cons),S=m(F,j.concat),
ga=function(a,b){return u(b,a)},K,ha=function(){throw Error("Many parser applied to a parser that accepts an empty string");};K=function(a){var b=function(b,e,f,d,h,y){return k(a,[b,e,f,d,ha,y])};return C(function(a){return G(u(b,a))})};var L=function(a,b){return 0>=a?E:u(b,L(a-1,b))},T=function(a,b){return 0>=a?E:G(u(b,T(a-1,b)))},U=function(a,b){return C(function(c){return u(b,D(Q(z(a,c)),E))})},H,A=function(a,b){g.call(this,a);this.tok=b};A.prototype=new r;A.prototype.constructor=A;Object.defineProperty(A.prototype,
"message",{get:function(){return"Unexpected "+this.tok}});H=function(a){return function(b,c,e,f,d,h){f=b.pos;return(d=b.input)?(d=j.first(d),a(d)?e(d,b.next(d),c):h(new A(f,d),b,c)):h(new r(f,"end of input"),b,c)}};var F=H(l(!0)),V=function(a,b){return H(m(a,b))},ia=function(a,b){return z(b,a)},W=function(a,b,c,e,f,d,h){for(a=a(b,c,e,f,d,h);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},X=function(a,b){return function(c,e,f){return W(c,e,f||null,a,b,a,b)}},I=X(l,function(a){return function(){throw a;
}}),Y=function(a,b){return I(a,new q(b,new p(1,0)))},Z=function(a,b){var c=G(t(a,function(a,b,d){return s(j.memoStream(a,m(I,c,b,d)))}));return I(c,b)},$=function(a,b){return Z(a,new q(b,new p(1,0)))},aa=X(l(l(!0)),l(l(!1))),ba=function(a,b){return aa(a,new q(b,new p(1,0)))};return{ParseError:g,UnknownError:w,UnexpectError:r,ExpectError:x,InputState:q,Position:p,rec:C,Parser:O,RecParser:function(a,b){return O(a,C(b))},always:s,never:J,bind:t,binda:function(a,b){return t(a,function(a,e){return b.apply(void 0,
j.toArray(a).concat([e]))})},eof:ea,extract:P,examine:B,attempt:Q,lookahead:function(a){return function(b,c,e,f,d,h){return k(a,[b,c,function(a,c,e){return d(a,b,e)},f,d,h])}},next:z,either:D,choice:function(){return 0===arguments.length?J:M.call(arguments,fa)},optional:R,consParser:u,concatParser:S,sequence:function(){return M.call(arguments,ga,E)},many:K,many1:function(a){return u(a,K(a))},times:L,betweenTimes:function(a,b,c){return b<a?J:S(L(a,c),T(b-a,c))},between:function(a,b,c){return z(a,t(c,
function(a){return z(b,s(a))}))},sepBy1:U,sepBy:function(a,b){return G(U(a,b))},token:H,anyToken:F,character:function(a,b){return V(b||N,a)},string:function(a,b){return da.call(a,m(V,b||N)).reduceRight(ia,s(a))},backtrack:function(a){return function(b,c,e,f,d,h){return k(a,[b,c,function(a,b){return e(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return d(a,b,c)},function(a,b){return h(a,b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,e,f,d,h,g){var j=n.lookup(e,
b,c);return j?k(j,[c,e,f,d,h,g]):k(a,[c,e,function(a,e,d){return f(a,e,n.update(d,b,function(b,c,d){return d(a,e,c)},c))},function(a,e,f){return d(a,e,n.update(f,b,function(b,c,d,f){return f(a,e,c)},c))},function(a,e,d){return h(a,e,n.update(d,b,function(b,c,d,f,g){return g(a,e,c)},c))},function(a,d,f){return g(a,d,n.update(e,b,function(b,c,e,g,h,j){return j(a,d,f)},c))}])}},exec:W,runState:I,runStream:Y,run:function(a,b){return Y(a,j.from(b))},runManyState:Z,runManyStream:$,runMany:function(a,b){return $(a,
j.from(b))},testState:aa,testStream:ba,test:function(a,b){return ba(a,j.from(b))}}});
