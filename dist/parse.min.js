define(["nu/stream"],function(i){var ca=Function.prototype.call.bind(Array.prototype.map),I=Function.prototype.call.bind(Array.prototype.reduceRight),Q=function(a){return a.bind.apply(a,arguments)},n=function(a){return function(){return a}},J=function(a){return function(){throw a;}},R=Math.random,l=function(a,b){var c=[a,b];c._next=!0;return c},r=function(a,b,c,d){this.id=a;this.state=b;this.val=c;this.delegate=d};r.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;
return null};r.update=function(a,b,c,d){return new r(b,c,d,a)};var p=function(a){this.index=a};p.initial=new p(0);p.prototype.increment=function(){return new p(this.index+1)};p.prototype.toString=function(){return""+this.index};p.prototype.compare=function(a){return this.index-a.index};var k=function(a,b,c){this.input=a;this.position=b;this.userState=c};k.prototype.next=function(a){this._next||(this._next=new k(i.rest(this.input),this.position.increment(a),this.userState));return this._next};k.prototype.eq=
function(a){return 0===this.position.compare(a.position)};k.prototype.setInput=function(a){return new k(a,this.position,this.userState)};k.prototype.setPosition=function(a){return new k(this.input,a,this.userState)};k.prototype.setUserState=function(a){return new k(this.input,this.position,a)};var t=function(a){this.message=a};t.prototype=Error();t.prototype.constructor=t;t.prototype.name="ParserError";var h=function(a,b){this.position=a;this._msg=b};h.prototype=Error();h.prototype.constructor=h;
h.prototype.name="ParseError";Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var q=function(a,b){h.call(this,a);this.errors=b||[]};q.prototype=new h;q.prototype.constructor=q;q.prototype.name="MultipleError";Object.defineProperty(q.prototype,"errorMessage",{get:function(){return"["+ca(this.errors,function(a){return a.message}).join(", ")+
"]"}});var x=function(a,b,c){h.call(this,a);this._pErr=b;this._qErr=c};x.prototype=new q;x.prototype.constructor=q;x.prototype.name="ChoiceError";Object.defineProperty(x.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var u=function(a){h.call(this,a)};u.prototype=new h;u.prototype.constructor=u;u.prototype.name="UnknownError";Object.defineProperty(u.prototype,"errorMessage",{value:"unknown error"});var v=function(a,b){h.call(this,a);this.unexpected=b};v.prototype=
new h;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var s=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};s.prototype=new h;s.prototype.constructor=s;s.prototype.name="ExpectError";Object.defineProperty(s.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var K=function(a){var b=a(function(){return b.apply(this,
arguments)});return b},A=function(a,b){return b.hasOwnProperty("parserId")?A(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:R(),writable:!1}})},w=function(a){return function(b,c,d,f,e){return e(a,b,c)}},B=function(a){return function(b,c,d,f,e,g){return g(a,b,c)}},m=function(a,b){return function(c,d,f,e,g,j){return l(a,[c,d,function(a,c,d){return l(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return l(b(a,c,d),[c,d,f,e,g,j])},
j])}},y=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},fa=y(function(a){return a}),C=function(a){return function(b,c,d,f,e){b=a(b);return e(b,b,c)}},ga=y(function(a){return a.userState}),L=function(a){return C(function(b){return b.setUserState(a(b.userState))})},D=y(function(a){return a.position}),S=y(function(a){return a.input}),T,ha=w(i.end);T=m(S,function(a){return i.isEmpty(a)?ha:m(D,function(b){return B(new s(b,"end of input",i.first(a)))})});var U=function(a,b){return m(a,n(b))},
ia=function(a,b){return U(b,a)},z=function(a){return function(b,c){return function(d,f,e,g,j,da){var ea=d.position;return l(b,[d,f,e,g,j,function(b,f,h){return l(c,[d,h,e,g,j,function(c,e,f){return da(a(ea,b,c),d,f)}])}])}}},V=z(function(a,b,c){return new q(a,[b,c])}),ja=z(function(a,b,c){return new x(a,b,c)}),ka=function(a,b){return ja(b,a)},la=m(D,function(a){return B(new q(a,[]))}),z=function(a,b){return V(b,w(a))},ma=w(i.end),W=Q(z,i.end),E=function(a){return function(b,c){return m(b,function(b){return m(c,
function(c){return w(a(b,c))})})}},M,na=function(a){return w(i.toArray(a))};M=function(a){return m(a,na)};var F=E(i.cons),E=E(i.append),oa=function(a,b){return F(b,a)},N,pa=J(new t("Many parser applied to a parser that accepts an empty string"));N=function(a){var b=function(b,d,f,e,g,j){return l(a,[b,d,f,e,pa,j])};return K(function(a){return W(F(b,a))})};var O,qa=function(a,b){return new v(a,null===b?"end of input":b)};O=function(a,b){var c=b||qa;return function(b,f,e,g,j,h){g=b.position;return(j=
b.input)?(j=i.first(j),a(j)?e(j,b.next(j),f):h(c(g,j),b,f)):h(c(g,null),b,f)}};var ra=A("Any Token",O(n(!0))),G=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},H=function(a,b){return G(a,b,null,n,J,n,J)},X=function(a,b,c){return H(a,new k(b,p.initial,c))},Y=function(a,b){var c=W(m(a,function(a,b,e){return w(i.memoStream(a,Q(H,c,b,e)))}));return H(c,b)},Z=function(a,b,c){return Y(a,new k(b,p.initial,c))},P,$=n(n(!0)),aa=n(n(!1));P=function(a,b){return G(a,
b,null,$,aa,$,aa)};var ba=function(a,b,c){return P(a,new k(b,p.initial,c))};return{ParserError:t,ParseError:h,MultipleError:q,UnknownError:u,UnexpectError:v,ExpectError:s,ParserState:k,Position:p,rec:K,Parser:A,RecParser:function(a,b){return A(a,K(b))},always:w,never:B,bind:m,eof:T,extract:y,getParserState:fa,setParserState:function(a){return C(n(a))},modifyParserState:C,getState:ga,setState:function(a){return L(n(a))},modifyState:L,getInput:S,setInput:function(a){return L(function(b){return b.setInput(a)})},
getPosition:D,setPosition:function(a){return C(function(b){return b.setPosition(a)})},fail:function(a){var b=a?h:u;return m(D,function(c){return B(new b(c,a))})},attempt:function(a){return function(b,c,d,f,e,g){return l(a,[b,c,d,g,e,g])}},lookahead:function(a){return function(b,c,d,f,e,g){return l(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:U,sequence:function(){return I(arguments,ia)},either:V,choice:function(){if(!arguments.length)throw new t("choice called with no arguments");return I(arguments,
ka,la)},optional:z,expected:function(a,b){return function(c,d,f,e,g,j){return b(c,d,f,e,g,function(b,c,d){return j(new s(c.position,a),c,d)})}},eager:M,binds:function(a,b){return m(M(a),function(a){return b.apply(void 0,a)})},cons:F,append:E,enumeration:function(){return I(arguments,oa,ma)},many:N,many1:function(a){return F(a,N(a))},token:O,anyToken:ra,backtrack:function(a){return function(b,c,d,f,e,g){return l(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,
b,c)},function(a,b){return g(a,b,c)}])}},memo:function(a){var b=a.parserId||R();return function(c,d,f,e,g,h){var i=r.lookup(d,b,c);return i?l(i,[c,d,f,e,g,h]):l(a,[c,d,function(a,d,e){return f(a,d,r.update(e,b,c,function(b,c,e){return e(a,d,c)}))},function(a,d,f){return e(a,d,r.update(f,b,c,function(b,c,e,f){return f(a,d,c)}))},function(a,d,e){return g(a,d,r.update(e,b,c,function(b,c,e,f,g){return g(a,d,c)}))},function(a,e,f){return h(a,e,r.update(d,b,c,function(b,c,d,g,h,i){return i(a,e,f)}))}])}},
exec:G,perform:function(a,b,c,d){var f=function(a){return function(){return c(a)}},e=function(a){return function(){return d(a)}};return G(a,b,null,f,e,f,e)},runState:H,runStream:X,run:function(a,b,c){return X(a,i.from(b),c)},runManyState:Y,runManyStream:Z,runMany:function(a,b,c){return Z(a,i.from(b),c)},testState:P,testStream:ba,test:function(a,b,c){return ba(a,i.from(b),c)}}});
