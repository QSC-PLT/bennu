define(["nu/stream","seshat"],function(j,B){var ha=Function.prototype.call.bind(Array.prototype.map),H=Function.prototype.call.bind(Array.prototype.reduceRight),T=function(a){return a.bind.apply(a,arguments)},k=function(a){return function(){return a}},I=function(a){return function(){throw a;}},U=Math.random,m=function(a,b){var c=[a,b];c._next=!0;return c},g=function(a,b){this.memoer=a;this.frames=b};g.empty=new g(B.create(function(a,b){return a.compare(b)},function(a,b){return a.id===b.id&&(a.state===
b.state||a.state&&a.state.eq(b.state))}),[]);g.pushWindow=function(a,b){return new g(a.memoer,[b].concat(a.frames))};g.popWindow=function(a){return new g(1===a.frames.length?B.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};g.lookup=function(a,b,c){return B.lookup(a.memoer,b,c)};g.update=function(a,b,c,d){return new g(B.update(a.memoer,b,c,d),a.frames)};var l=function(a){this.index=a};l.initial=new l(0);l.prototype.toString=function(){return""+this.index};l.prototype.increment=function(){return new l(this.index+
1)};l.prototype.compare=function(a){return this.index-a.index};var i=function(a,b,c){this.input=a;this.position=b;this.userState=c};i.prototype.eq=function(a){return a&&this.input===a.input&&this.userState===a.userState};i.prototype.isEmpty=function(){return j.isEmpty(this.input)};i.prototype.first=function(){return j.first(this.input)};i.prototype.next=function(a){if(!this._next){var b=new i(j.rest(this.input),this.position.increment(a),this.userState);this._next=function(c,d,f){return f(a,b,d)}}return this._next};
i.prototype.setInput=function(a){return new i(a,this.position,this.userState)};i.prototype.setPosition=function(a){return new i(this.input,a,this.userState)};i.prototype.setUserState=function(a){return new i(this.input,this.position,a)};var u=function(a){this.message=a};u.prototype=Error();u.prototype.constructor=u;u.prototype.name="ParserError";var h=function(a,b){this.position=a;this._msg=b};h.prototype=Error();h.prototype.constructor=h;h.prototype.name="ParseError";h.prototype.toString=function(){return this.name+
": "+this.message};Object.defineProperties(h.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var n=function(a,b){h.call(this,a);this.errors=b||[]};n.prototype=new h;n.prototype.constructor=n;n.prototype.name="MultipleError";Object.defineProperty(n.prototype,"errorMessage",{get:function(){return"["+ha(this.errors,function(a){return a.message}).join(", ")+
"]"}});var z=function(a,b,c){h.call(this,a);this._pErr=b;this._qErr=c};z.prototype=new n;z.prototype.constructor=n;z.prototype.name="ChoiceError";Object.defineProperty(z.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});var v=function(a){h.call(this,a)};v.prototype=new h;v.prototype.constructor=v;v.prototype.name="UnknownError";Object.defineProperty(v.prototype,"errorMessage",{value:"unknown error"});var w=function(a,b){h.call(this,a);this.unexpected=b};w.prototype=
new h;w.prototype.constructor=w;w.prototype.name="UnexpectError";Object.defineProperty(w.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});var t=function(a,b,c){h.call(this,a);this.expected=b;this.found=c};t.prototype=new h;t.prototype.constructor=t;t.prototype.name="ExpectError";Object.defineProperty(t.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var J=function(a){var b=a(function(){return b.apply(this,
arguments)});return b},q=function(a,b){return b.hasOwnProperty("parserId")?q(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:U(),writable:!1}})},x=function(a){return function(b,c,d,f,e){return e(a,b,c)}},K=function(a){return function(b,c,d,f,e,r){return r(a,b,c)}},p=function(a,b){return function(c,d,f,e,r,s){return m(a,[c,d,function(a,c,d){return m(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return m(b(a,c,d),[c,d,f,e,r,s])},
s])}},y=function(a){return function(b,c,d,f,e){b=a(b);return e(b,b,c)}},V=q("Get Parser State",y(function(a){return a})),C=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},W=function(a){return y(function(b){return b.setUserState(a(b.userState))})},ja=q("Get State",C(function(a){return a.userState})),L=q("Get Position",C(function(a){return a.position})),ka=q("Get Input",C(function(a){return a.input})),X=function(a){return p(L,function(b){return K(a(b))})},Y,la=x(j.end);Y=q("EOF",p(V,function(a){return a.isEmpty()?
la:X(function(b){return new t(b,"end of input",a.first())})}));var Z=function(a,b){return p(a,k(b))},M,ma=function(a,b){return Z(b,a)};M=function(a){return H(a,ma)};var A=function(a){return function(b,c){return function(d,f,e,r,s,ia){var g=d.position;return m(b,[d,f,e,r,s,function(b,f,h){return m(c,[d,h,e,r,s,function(c,f,e){return ia(a(g,b,c),d,e)}])}])}}},$=A(function(a,b,c){return new n(a,[b,c])}),N,na=A(function(a,b,c){return new z(a,b,c)}),oa=function(a,b){return na(b,a)},pa=p(L,function(a){return K(new n(a,
[]))});N=function(a){if(!a.length)throw new u("choice called no parsers");return H(a,oa,pa)};var A=function(a,b){return $(b,x(a))},qa=x(j.end),aa=T(A,j.end),D=function(a){return function(b,c){return p(b,function(b){return p(c,function(c){return x(a(b,c))})})}},O,ra=function(a){return x(j.toArray(a))};O=function(a){return p(a,ra)};var E=D(j.cons),D=D(j.append),P,sa=function(a,b){return E(b,a)};P=function(a){return H(a,sa,qa)};var Q,ta=I(new u("Many parser applied to a parser that accepts an empty string"));
Q=function(a){var b=function(b,d,f,e,r,s){return m(a,[b,d,f,e,ta,s])};return J(function(a){return aa(E(b,a))})};var R,ua=function(a,b){return new w(a,null===b?"end of input":b)};R=function(a,b){var c=b||ua;return function(b,f,e,r,s,g){var h=b.position;if(b.isEmpty())return g(c(h,null),b,f);var i=b.first();return a(i)?b.next(i)(b,f,e,r,s,g):g(c(h,i),b,f)}};var va=q("Any Token",R(k(!0))),F=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},G=function(a,b){return F(a,
b,g.empty,k,I,k,I)},ba=function(a,b,c){return G(a,new i(b,l.initial,c))},ca=function(a,b){var c=aa(p(a,function(a,b,e){return x(j.memoStream(a,T(G,c,b,e)))}));return G(c,b)},da=function(a,b,c){return ca(a,new i(b,l.initial,c))},S,ea=k(k(!0)),fa=k(k(!1));S=function(a,b){return F(a,b,g.empty,ea,fa,ea,fa)};var ga=function(a,b,c){return S(a,new i(b,l.initial,c))};return{ParserError:u,ParseError:h,MultipleError:n,UnknownError:v,UnexpectError:w,ExpectError:t,ParserState:i,Position:l,rec:J,Parser:q,RecParser:function(a,
b){return q(a,J(b))},always:x,never:K,bind:p,eof:Y,extract:C,getParserState:V,setParserState:function(a){return y(k(a))},modifyParserState:y,getState:ja,setState:function(a){return W(k(a))},modifyState:W,getInput:ka,setInput:function(a){return y(function(b){return b.setInput(a)})},getPosition:L,setPosition:function(a){return y(function(b){return b.setPosition(a)})},fail:function(a){var b=a?h:v;return X(function(c){return new b(c,a)})},attempt:function(a){return function(b,c,d,f,e,h){f=function(a,
b,c){return h(a,b,g.popWindow(c))};return m(a,[b,g.pushWindow(c,b.position),function(a,b,c){return d(a,b,g.popWindow(c))},f,function(a,b,c){return e(a,b,g.popWindow(c))},f])}},lookahead:function(a){return function(b,c,d,f,e,g){return m(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:Z,sequencea:M,sequence:function(){return M(arguments)},either:$,choicea:N,choice:function(){return N(arguments)},optional:A,expected:function(a,b){return function(c,d,f,e,g,h){return b(c,d,f,e,g,function(b,c,d){return h(new t(c.position,
a),c,d)})}},eager:O,binds:function(a,b){return p(O(a),function(a){return b.apply(void 0,a)})},cons:E,append:D,enumerationa:P,enumeration:function(){return P(arguments)},many:Q,many1:function(a){return E(a,Q(a))},token:R,anyToken:va,memo:function(a){var b=a.parserId||U();return function(c,d,f,e,h,i){var j=c.position,k={id:b,state:c},l=g.lookup(d,j,k);return l?m(l,[c,d,f,e,h,i]):m(a,[c,d,function(a,b,c){return f(a,b,g.update(c,j,k,function(c,d,e){return e(a,b,d)}))},function(a,b,c){return e(a,b,g.update(c,
j,k,function(c,d,e,f){return f(a,b,d)}))},function(a,b,c){return h(a,b,g.update(c,j,k,function(c,d,e,f,g){return g(a,b,d)}))},function(a,b,c){return i(a,b,g.update(c,j,k,function(c,d,e,f,g,h){return h(a,b,d)}))}])}},exec:F,perform:function(a,b,c,d){var f=function(a,b,d){return function(){return c(a,b,d)}},e=function(a,b,c){return function(){return d(a,b,c)}};return F(a,b,g.empty,f,e,f,e)},runState:G,runStream:ba,run:function(a,b,c){return ba(a,j.from(b),c)},runManyState:ca,runManyStream:da,runMany:function(a,
b,c){return da(a,j.from(b),c)},testState:S,testStream:ga,test:function(a,b,c){return ga(a,j.from(b),c)}}});
