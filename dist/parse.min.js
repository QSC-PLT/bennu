define(function(aa,c){var v,g,j,w,x,t,i,k,G,q,y,H,l,ba,B,K,z,ca,L,da,I,M,N,O,P,A,Q,C,u,R,S,T,ea,D,E,U,V,W,X,Y,p=aa("nu/stream");u=p.end;var la=p.first,ma=p.isEmpty,na=p.rest,J=aa("seshat"),oa=Function.prototype.call.bind(Array.prototype.map),Z=Function.prototype.call.bind(Array.prototype.reduceRight),fa=function(a){return a.bind.apply(a,arguments)},r=function(a){return function(){return a}},$=function(a){return function(){throw a;}},ga=Math.random,s=function(a,b){var d=[a,b];d._next=!0;return d},
h=function(a,b){this.memoer=a;this.frames=b};h.empty=new h(J.create(function(a,b){return a.compare(b)},function(a,b){return a.id===b.id&&(a.state===b.state||a.state&&a.state.eq(b.state))}),[]);h.pushWindow=function(a,b){return new h(a.memoer,[b].concat(a.frames))};h.popWindow=function(a){return new h(1===a.frames.length?J.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};h.lookup=function(a,b,d){return J.lookup(a.memoer,b,d)};h.update=function(a,b,d,c){return new h(J.update(a.memoer,b,d,c),
a.frames)};k=function(a){this.index=a};k.initial=new k(0);k.prototype.toString=function(){return""+this.index};k.prototype.increment=function(){return new k(this.index+1)};k.prototype.compare=function(a){return this.index-a.index};i=function(a,b,d){this.input=a;this.position=b;this.userState=d};i.prototype.eq=function(a){return a&&this.input===a.input&&this.userState===a.userState};i.prototype.isEmpty=function(){return ma(this.input)};i.prototype.first=function(){return la(this.input)};i.prototype.next=
function(a){if(!this._next){var b=new i(na(this.input),this.position.increment(a),this.userState);this._next=function(d,c,f){return f(a,b,c)}}return this._next};i.prototype.setInput=function(a){return new i(a,this.position,this.userState)};i.prototype.setPosition=function(a){return new i(this.input,a,this.userState)};i.prototype.setUserState=function(a){return new i(this.input,this.position,a)};v=function(a){this.message=a};v.prototype=Error();v.prototype.constructor=v;v.prototype.name="ParserError";
g=function(a,b){this.position=a;this._msg=b};g.prototype=Error();g.prototype.constructor=g;g.prototype.name="ParseError";g.prototype.toString=function(){return this.name+": "+this.message};Object.defineProperties(g.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});j=function(a,b){g.call(this,a);this.errors=b||[]};j.prototype=new g;j.prototype.constructor=
j;j.prototype.name="MultipleError";Object.defineProperty(j.prototype,"errorMessage",{get:function(){return"["+oa(this.errors,function(a){return a.message}).join(", ")+"]"}});var F=function(a,b,d){g.call(this,a);this._pErr=b;this._qErr=d};F.prototype=new j;F.prototype.constructor=j;F.prototype.name="ChoiceError";Object.defineProperty(F.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});w=function(a){g.call(this,a)};w.prototype=new g;w.prototype.constructor=w;w.prototype.name=
"UnknownError";Object.defineProperty(w.prototype,"errorMessage",{value:"unknown error"});x=function(a,b){g.call(this,a);this.unexpected=b};x.prototype=new g;x.prototype.constructor=x;x.prototype.name="UnexpectError";Object.defineProperty(x.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});t=function(a,b,d){g.call(this,a);this.expected=b;this.found=d};t.prototype=new g;t.prototype.constructor=t;t.prototype.name="ExpectError";Object.defineProperty(t.prototype,"errorMessage",
{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});G=function(a){var b=a(function(){return b.apply(this,arguments)});return b};q=function(a,b){return b.hasOwnProperty("parserId")?q(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:ga(),writable:!1}})};y=function(a){return function(b,d,c,f,e){return e(a,b,d)}};H=function(a){return function(b,d,c,f,e,m){return m(a,b,d)}};l=function(a,b){return function(d,
c,f,e,m,n){return s(a,[d,c,function(a,d,c){return s(b(a,d,c),[d,c,f,e,f,e])},e,function(a,d,c){return s(b(a,d,c),[d,c,f,e,m,n])},n])}};z=function(a){return function(b,d,c,f,e){b=a(b);return e(b,b,d)}};K=q("Get Parser State",z(function(a){return a}));B=function(a){return function(b,d,c,f,e){return e(a(b),b,d)}};L=function(a){return z(function(b){return b.setUserState(a(b.userState))})};ca=q("Get State",B(function(a){return a.userState}));I=q("Get Position",B(function(a){return a.position}));da=q("Get Input",
B(function(a){return a.input}));var ha=function(a){return l(I,function(b){return H(a(b))})},qa=y(u);ba=q("EOF",l(K,function(a){return a.isEmpty()?qa:ha(function(b){return new t(b,"end of input",a.first())})}));M=function(a,b){return l(a,r(b))};var ra=function(a,b){return M(b,a)};N=function(a){return Z(a,ra)};A=function(a){return function(b,d){return function(c,f,e,m,n,pa){var h=c.position;return s(b,[c,f,e,m,n,function(b,f,g){return s(d,[c,g,e,m,n,function(d,f,e){return pa(a(h,b,d),c,e)}])}])}}};
O=A(function(a,b,c){return new j(a,[b,c])});var sa=A(function(a,b,c){return new F(a,b,c)}),ta=function(a,b){return sa(b,a)},ua=l(I,function(a){return H(new j(a,[]))});P=function(a){if(!a.length)throw new v("choice called no parsers");return Z(a,ta,ua)};A=function(a,b){return O(b,y(a))};var va=y(u),ia=fa(A,u);u=function(a){return function(b,c){return l(b,function(b){return l(c,function(c){return y(a(b,c))})})}};var wa=function(a){return y(p.toArray(a))};Q=function(a){return l(a,wa)};C=u(p.cons);u=
u(p.append);var xa=function(a,b){return C(b,a)};R=function(a){return Z(a,xa,va)};var ya=$(new v("Many parser applied to a parser that accepts an empty string"));S=function(a){var b=function(b,c,f,e,m,n){return s(a,[b,c,f,e,ya,n])};return G(function(a){return ia(C(b,a))})};var za=function(a,b){return new x(a,null===b?"end of input":b)};T=function(a,b){var c=b||za;return function(b,f,e,m,n,h){var g=b.position;if(b.isEmpty())return h(c(g,null),b,f);var i=b.first();return a(i)?b.next(i)(b,f,e,m,n,h):
h(c(g,i),b,f)}};ea=q("Any Token",T(r(!0)));D=function(a,b,c,h,f,e,m){for(a=a(b,c,h,f,e,m);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()};E=function(a,b){return D(a,b,h.empty,r,$,r,$)};U=function(a,b,c){return E(a,new i(b,k.initial,c))};V=function(a,b){var c=ia(l(a,function(a,b,e){return y(p.memoStream(a,fa(E,c,b,e)))}));return E(c,b)};W=function(a,b,c){return V(a,new i(b,k.initial,c))};var ja=r(r(!0)),ka=r(r(!1));X=function(a,b){return D(a,b,h.empty,ja,ka,ja,ka)};Y=function(a,b,c){return X(a,new i(b,
k.initial,c))};c.ParserError=v;c.ParseError=g;c.MultipleError=j;c.UnknownError=w;c.UnexpectError=x;c.ExpectError=t;c.ParserState=i;c.Position=k;c.rec=G;c.Parser=q;c.RecParser=function(a,b){return q(a,G(b))};c.always=y;c.never=H;c.bind=l;c.eof=ba;c.extract=B;c.getParserState=K;c.setParserState=function(a){return z(r(a))};c.modifyParserState=z;c.getState=ca;c.setState=function(a){return L(r(a))};c.modifyState=L;c.getInput=da;c.setInput=function(a){return z(function(b){return b.setInput(a)})};c.getPosition=
I;c.setPosition=function(a){return z(function(b){return b.setPosition(a)})};c.fail=function(a){var b=a?g:w;return ha(function(c){return new b(c,a)})};c.attempt=function(a){return function(b,c,g,f,e,m){f=function(a,b,c){return m(a,b,h.popWindow(c))};return s(a,[b,h.pushWindow(c,b.position),function(a,b,c){return g(a,b,h.popWindow(c))},f,function(a,b,c){return e(a,b,h.popWindow(c))},f])}};c.lookahead=function(a){return function(b,c,h,f,e,g){return s(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}};
c.next=M;c.sequencea=N;c.sequence=function(){return N(arguments)};c.either=O;c.choicea=P;c.choice=function(){return P(arguments)};c.optional=A;c.expected=function(a,b){return function(c,h,f,e,g,i){return b(c,h,f,e,g,function(b,c,d){return i(new t(c.position,a),c,d)})}};c.eager=Q;c.binds=function(a,b){return l(Q(a),function(a){return b.apply(void 0,a)})};c.cons=C;c.append=u;c.enumerationa=R;c.enumeration=function(){return R(arguments)};c.many=S;c.many1=function(a){return C(a,S(a))};c.token=T;c.anyToken=
ea;c.memo=function(a){var b=a.parserId||ga();return function(c,g,f,e,i,n){var j=c.position,k={id:b,state:c},l=h.lookup(g,j,k);return l?s(l,[c,g,f,e,i,n]):s(a,[c,g,function(a,b,c){return f(a,b,h.update(c,j,k,function(c,d,e){return e(a,b,d)}))},function(a,b,c){return e(a,b,h.update(c,j,k,function(c,d,e,f){return f(a,b,d)}))},function(a,b,c){return i(a,b,h.update(c,j,k,function(c,d,e,f,g){return g(a,b,d)}))},function(a,b,c){return n(a,b,h.update(c,j,k,function(c,d,e,f,g,h){return h(a,b,d)}))}])}};c.exec=
D;c.perform=function(a,b,c,g){var f=function(a,b,e){return function(){return c(a,b,e)}},e=function(a,b,c){return function(){return g(a,b,c)}};return D(a,b,h.empty,f,e,f,e)};c.runState=E;c.runStream=U;c.run=function(a,b,c){return U(a,p.from(b),c)};c.runManyState=V;c.runManyStream=W;c.runMany=function(a,b,c){return W(a,p.from(b),c)};c.testState=X;c.testStream=Y;c.test=function(a,b,c){return Y(a,p.from(b),c)}});
