define(["stream"],function(h){var da=Array.prototype.join,ea=Array.prototype.map,M=Array.prototype.reduceRight,m=function(a){return 1===arguments.length?a:a.bind.apply(a,arguments)},x=function(a){return a},j=m(m,x),N=function(a,b){return a===b},k=function(a,b){var c=[a,b];c._next=!0;return c},O=function(a){for(;a&&a._next;)a=a[0].apply(void 0,a[1]);return a},y=function(a,b,c){this.val=a;this.state=b;this.rest=c};y.prototype.get=function(a){return this.state&&this.state.pos.line===a.pos.line&&this.state.pos.column===
a.pos.column?this.val:this.rest?this.rest.get(a):null};y.prototype.cons=function(a,b){return new y(a,b,this)};var l,fa=function(){return"{line: "+this.line+" col: "+this.column+"}"};l=function(a,b){return Object.freeze({line:a,column:b,toString:fa})};l.increment=function(a,b){return"\n"===b?l(a.line+1,1):l(a.line,a.column+1)};var r=function(a,b){this.input=a;this.pos=b};r.prototype.next=function(a){return this._next||(this._next=new r(h.rest(this.input),l.increment(this.pos,a)))};var g=function(a,
b){this._messages=b;this.pos=a};g.prototype=Error();g.prototype.constructor=g;g.prototype.name="ParseError";Object.defineProperties(g.prototype,{message:{get:function(){var a=this.messages;return"At position:"+this.pos+" ["+(a?da.call(a,", "):"")+"]"}},messages:{get:function(){return this._messages}}});var s=function(a,b){this.e1=a;this.e2=b;g.call(this,a.pos)};s.prototype=new g;s.prototype.constructor=s;s.prototype.name="MultipleError";Object.defineProperty(s.prototype,"messages",{get:function(){return[this.e1.messsage,
this.e2.message]}});var t=function(a){g.call(this,a,["Error"])};t.prototype=new g;t.prototype.constructor=t;t.prototype.name="UnknownError";var n=function(a,b){g.call(this,a,b?["Unexpected "+b]:b)};n.prototype=new g;n.prototype.constructor=n;n.prototype.name="UnexpectError";var u=function(a,b){g.call(this,a,["Expected "+(b||"")])};u.prototype=new g;u.prototype.constructor=u;u.prototype.name="ExpectError";var P=function(a,b){return Object.defineProperty(b,"displayName",{value:a,writable:!1})},F=function(a){var b;
return b=a(function(){return b.apply(this,arguments)})},p=function(a){return function(b,c,d,f,e){return e(a,b,c)}},G=j(function(a,b,c,d,f,e){return e(new t(a.pos),a,b)}),v=function(a,b){return function(c,d,f,e,i,z){return k(a,[c,d,function(a,c,d){return k(b(a,c),[c,d,f,e,f,e])},e,function(a,c,d){return k(b(a,c),[c,d,f,e,i,z])},z])}},Q=function(a,b){return v(a,function(a){return b.apply(void 0,h.toArray(a))})},ga=j(function(a,b,c,d,f,e){return!a.input?f(null,a,b):e(new u(a.pos,"end of input"),a,b)}),
R=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},x=m(R,x),H=function(a,b){return v(a,j(b))},I=function(a,b){return function(c,d,f,e,i,z){return k(a,[c,d,f,e,i,function(a,d,g){return k(b,[c,g,f,e,i,function(b,e,d){return z(new s(a,b),c,d)}])}])}},ha=function(a,b){return I(b,a)},S=function(a,b){return I(a,p(b))},J=p(h.end),A=function(a,b,c){return v(b,function(b){return v(c,function(c){return p(a(b,c))})})},B=function(a){return S(a,h.end)},q=m(A,h.cons),T=m(A,h.concat),K,ia=function(a,
b){return q(b,a)};K=function(){return M.call(arguments,ia,J)};var C,ja=function(){throw Error("Many parser applied to a parser that accepts an empty string");};C=function(a){var b=function(b,d,f,e,i,g){return k(a,[b,d,f,e,ja,g])};return F(function(a){return B(q(b,a))})};var L=function(a,b){return 0>=a?J:q(b,L(a-1,b))},U=function(a,b){return 0>=a?J:B(q(b,U(a-1,b)))},ka=function(a,b){return p(b)},V=function(a,b){return q(b,C(H(a,b)))},D,w=function(a,b){g.call(this,a);this.tok=b};w.prototype=new n;w.prototype.constructor=
w;Object.defineProperty(w.prototype,"message",{get:function(){return"Unexpected "+this.tok}});D=function(a){return function(b,c,d,f,e,i){f=b.pos;return(e=b.input)?(e=h.first(e),a(e)?d(e,b.next(e),c):i(new w(f,e),b,c)):i(new n(f,"end of input"),b,c)}};var A=D(j(!0)),W=function(a,b){return D(m(a,b))},la=function(a,b){return H(b,a)},ma=function(a,b){return function(c,d,f){return f(a,b,d)}},na=function(a,b){return function(c,d,f,e){return e(a,b,d)}},oa=function(a,b){return function(c,d,f,e,i){return i(a,
b,d)}},pa=function(a,b){return function(c,d,f,e,i,g){return g(a,b,d)}},X=function(a,b,c,d,f,e){return O(a(b,new y,c,d,f,e))()},Y=function(a,b){return function(c,d){return X(c,d,a,b,a,b)}},E=Y(j,function(a){return function(){throw a;}}),Z=function(a,b){return E(a,new r(b,l(1,0)))},$=function(a,b){var c=B(v(a,function(a,b){return p(h.stream(a,m(E,c,b)))}));return E(c,b)},aa=function(a,b){return $(a,new r(b,l(1,0)))},ba=Y(j(j(!0)),j(j(!1))),ca=function(a,b){return ba(a,new r(b,l(1,0)))};return{ParseError:g,
UnknownError:t,UnexpectError:n,ExpectError:u,InputState:r,Position:l,Parser:P,RecParser:F,NamedRecParser:function(a,b){return P(a,F(b))},always:p,never:G,bind:v,binda:Q,eof:ga,extract:R,examine:x,attempt:function(a){return function(b,c,d,f,e,i){return k(a,[b,c,d,i,e,i])}},lookahead:function(a){return function(b,c,d,f,e,i){return k(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,i])}},next:H,either:I,choice:function(){return 0===arguments.length?G:M.call(arguments,ha)},optional:S,consParser:q,concatParser:T,
sequence:K,many:C,many1:function(a){return q(a,C(a))},times:L,betweenTimes:function(a,b,c){return b<a?G:T(L(a,c),U(b-a,c))},between:function(a,b,c){return Q(K(a,c,b),ka)},sepBy1:V,sepBy:function(a,b){return B(V(a,b))},token:D,anyToken:A,character:function(a,b){return W(b||N,a)},string:function(a,b){return ea.call(a,m(W,b||N)).reduceRight(la,p(a))},backtracing:function(a){return function(b,c,d,f){return k(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return pok(a,
b,c)},function(a,b){return f(a,b,c)}])}},memo:function(a){return function(b,c,d,f,e,g){var h;if(h=c.get(b))return h(b,c,d,f,e,g);h=O(a(b,c,ma,na,oa,pa));return h(b,c.cons(h,b),d,f,e,g)}},exec:X,runState:E,runStream:Z,run:function(a,b){return Z(a,h.from(b))},runManyState:$,runManyStream:aa,runMany:function(a,b){return aa(a,h.from(b))},testState:ba,testStream:ca,test:function(a,b){return ca(a,h.from(b))}}});
