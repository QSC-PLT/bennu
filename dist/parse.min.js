define(["nu/stream"],function(h){var L=Array.prototype.map,M=Array.prototype.reduceRight,y=function(a){return a.bind.apply(a,arguments)},q=function(a){return function(){return a}},N=function(a,b){return a===b},k=function(a,b){var c=[a,b];c._next=!0;return c},l=function(a,b,c,d){this.id=a;this.val=b;this.state=c;this.delegate=d};l.lookup=function(a,b,c){for(;a;a=a.delegate)if(a.id===b&&a.state.eq(c))return a.val;return null};l.update=function(a,b,c,d){return new l(b,c,d,a)};var m=function(a){this.index=
a};m.prototype.increment=function(){return new m(this.index+1)};m.prototype.toString=function(){return""+this.index};m.prototype.compare=function(a){return this.index-a.index};var r=function(a,b){this.input=a;this.pos=b};r.prototype.next=function(a){return this._next||(this._next=new r(h.rest(this.input),this.pos.increment(a)))};r.prototype.eq=function(a){return 0===this.pos.compare(a.pos)};var z=function(a){this.message=a};z.prototype=Error();z.prototype.constructor=z;z.prototype.name="ParserError";
var i=function(a,b){this.pos=a;this._msg=b};i.prototype=Error();i.prototype.constructor=i;i.prototype.name="ParseError";Object.defineProperties(i.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.pos+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});var n=function(a,b){i.call(this,a);this.errors=b||[]};n.prototype=new i;n.prototype.constructor=n;n.prototype.name="MultipleError";Object.defineProperties(n.prototype,
{errorMessage:{get:function(){return"["+L.call(this.errors,function(a){return a.message}).join(", ")+"]"}}});var s=function(a){i.call(this,a)};s.prototype=new i;s.prototype.constructor=s;s.prototype.name="UnknownError";Object.defineProperty(s.prototype,"errorMessage",{value:"unknown error"});var p=function(a,b){i.call(this,a);this.unexpected=b};p.prototype=new i;p.prototype.constructor=p;p.prototype.name="UnexpectError";Object.defineProperty(p.prototype,"errorMessage",{get:function(){return"Unexpected:"+
this.unexpected}});var t=function(a,b,c){i.call(this,a);this.expected=b;this.found=c};t.prototype=new i;t.prototype.constructor=t;t.prototype.name="ExpectError";Object.defineProperty(t.prototype,"errorMessage",{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});var B=function(a){var b;return b=a(function(){return b.apply(this,arguments)})},G=function(a,b){return b.hasOwnProperty("parserId")?G(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,
{displayName:{value:a,writable:!1},parserId:{value:Math.random(),writable:!1}})},u=function(a){return function(b,c,d,f,e){return e(a,b,c)}},H=function(a){var b=void 0===a?s:i;return function(c,d,f,e,g,j){return j(new b(c.pos,a),c,d)}},v=function(a,b){return function(c,d,f,e,g,j){return k(a,[c,d,function(a,c,d){return k(b(a,c,d),[c,d,f,e,f,e])},e,function(a,c,d){return k(b(a,c,d),[c,d,f,e,g,j])},j])}},O=function(a){return function(b,c,d,f,e){return e(a(b),b,c)}},ca=y(O,function(a){return a}),P=function(a){return function(b,
c,d,f,e,g){return k(a,[b,c,d,g,e,g])}},A=function(a,b){return v(a,q(b))},w=function(a){return function(b,c){return function(d,f,e,g,j,i){var ba=d.pos;return k(b,[d,f,e,g,j,function(b,f,h){return k(c,[d,h,e,g,j,function(c,e,f){return i(a(ba,b,c),d,f)}])}])}}},I=w(function(a,b,c){return new n(a,[b,c])}),da=w(function(a,b,c){return new n(a,[b].concat(c.errors))}),ea=function(a,b){return da(b,a)},fa=function(a,b,c,d,f,e){return e(new n(a.pos,[]),a,b)},Q=function(a,b){return I(a,u(b))},C=u(h.end),w=function(a,
b,c){return v(b,function(b){return v(c,function(c){return u(a(b,c))})})},D=function(a){return Q(a,h.end)},x=y(w,h.cons),R=y(w,h.append),ga=function(a,b){return x(b,a)},J,ha=function(){throw new z("Many parser applied to a parser that accepts an empty string");};J=function(a){var b=function(b,d,f,e,g,j){return k(a,[b,d,f,e,ha,j])};return B(function(a){return D(x(b,a))})};var K=function(a,b){return 0>=a?C:x(b,K(a-1,b))},S=function(a,b){return 0>=a?C:D(x(b,S(a-1,b)))},T=function(a,b){return B(function(c){return x(b,
I(P(A(a,c)),C))})},E,ia=function(a,b){return new p(a,b)};E=function(a,b){b=b||ia;return function(c,d,f,e,g,j){e=c.pos;return(g=c.input)?(g=h.first(g),a(g)?f(g,c.next(g),d):j(b(e,g),c,d)):j(new p(e,"end of input"),c,d)}};var w=E(q(!0)),U=function(a,b){return E(y(a,b))},ja=function(a,b){return A(b,a)},V=function(a,b,c,d,f,e,g){for(a=a(b,c,d,f,e,g);a&&a._next;)a=a[0].apply(void 0,a[1]);return a()},W=function(a,b){return function(c,d,f){return V(c,d,f||null,a,b,a,b)}},F=W(q,function(a){return function(){throw a;
}}),X=function(a,b){return F(a,new r(b,new m(0)))},Y=function(a,b){var c=D(v(a,function(a,b,e){return u(h.memoStream(a,y(F,c,b,e)))}));return F(c,b)},Z=function(a,b){return Y(a,new r(b,new m(0)))},$=W(q(q(!0)),q(q(!1))),aa=function(a,b){return $(a,new r(b,new m(0)))};return{ParseError:i,UnknownError:s,UnexpectError:p,ExpectError:t,InputState:r,Position:m,rec:B,Parser:G,RecParser:function(a,b){return G(a,B(b))},always:u,never:H,bind:v,binda:function(a,b){return v(a,function(a){return b.apply(void 0,
h.toArray(a))})},eof:function(){return function(a,b,c,d,f,e){return h.isEmpty(a.input)?f(h.end,a,b):e(new t(a.pos,"end of input, found:"+h.first(a.input)),a,b)}},extract:O,examine:ca,attempt:P,lookahead:function(a){return function(b,c,d,f,e,g){return k(a,[b,c,function(a,c,d){return e(a,b,d)},f,e,g])}},next:A,either:I,choice:function(){return 0===arguments.length?H():M.call(arguments,ea,fa)},optional:Q,cons:x,append:R,sequence:function(){return M.call(arguments,ga,C)},many:J,many1:function(a){return x(a,
J(a))},times:K,betweenTimes:function(a,b,c){return b<a?H:R(K(a,c),S(b-a,c))},between:function(a,b,c){return A(a,v(c,function(a){return A(b,u(a))}))},sepBy1:T,sepBy:function(a,b){return D(T(a,b))},token:E,anyToken:w,character:function(a,b){return U(b||N,a)},string:function(a,b){return L.call(a,y(U,b||N)).reduceRight(ja,u(a))},backtrack:function(a){return function(b,c,d,f,e,g){return k(a,[b,c,function(a,b){return d(a,b,c)},function(a,b){return f(a,b,c)},function(a,b){return e(a,b,c)},function(a,b){return g(a,
b,c)}])}},memo:function(a){var b=a.parserId||Math.random();return function(c,d,f,e,g,i){var h=l.lookup(d,b,c);return h?k(h,[c,d,f,e,g,i]):k(a,[c,d,function(a,d,e){return f(a,d,l.update(e,b,function(b,c,e){return e(a,d,c)},c))},function(a,d,f){return e(a,d,l.update(f,b,function(b,c,e,f){return f(a,d,c)},c))},function(a,d,e){return g(a,d,l.update(e,b,function(b,c,e,f,g){return g(a,d,c)},c))},function(a,e,f){return i(a,e,l.update(d,b,function(b,c,d,g,i,h){return h(a,e,f)},c))}])}},exec:V,runState:F,
runStream:X,run:function(a,b){return X(a,h.from(b))},runManyState:Y,runManyStream:Z,runMany:function(a,b){return Z(a,h.from(b))},testState:$,testStream:aa,test:function(a,b){return aa(a,h.from(b))}}});
