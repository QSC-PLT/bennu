define(["require","exports","nu/stream","seshat"],function(ca,c,k,F){var p,K,t,d,l,u,v,r,h,j,G,n,x,H,q,A,L,y,da,M,ea,I,N,O,P,Q,z,R,B,s,S,T,U,fa,e,V,C,W,X,Y,Z,$;s=k.end;var ja=k.first,ka=k.isEmpty,la=k.rest,ma=Function.prototype.call.bind(Array.prototype.map),aa=Function.prototype.call.bind(Array.prototype.reduceRight),ba=function(){return arguments},w=function(a){return function(){return a}},ga=Math.random;p=function(a,b){var g=[a,b];g._next=!0;return g};K=function(a){for(;a&&a._next;)a=a[0].apply(void 0,
a[1]);return a};e=function(a,b){this.memoer=a;this.frames=b};e.empty=new e(F.create(function(a,b){return a.compare(b)},function(a,b){return a.id===b.id&&(a.state===b.state||a.state&&a.state.eq(b.state))}),[]);e.pushWindow=function(a,b){return new e(a.memoer,[b].concat(a.frames))};e.popWindow=function(a){return new e(1===a.frames.length?F.prune(a.memoer,a.frames[0]):a.memoer,a.frames.slice(1))};e.lookup=function(a,b,g){return F.lookup(a.memoer,b,g)};e.update=function(a,b,g,c){return new e(F.update(a.memoer,
b,g,c),a.frames)};j=function(a){this.index=a};j.initial=new j(0);j.prototype.toString=function(){return""+this.index};j.prototype.increment=function(){return new j(this.index+1)};j.prototype.compare=function(a){return this.index-a.index};h=function(a,b,g){this.input=a;this.position=b;this.userState=g};h.prototype.eq=function(a){return a&&this.input===a.input&&this.userState===a.userState};h.prototype.isEmpty=function(){return ka(this.input)};h.prototype.first=function(){return ja(this.input)};h.prototype.next=
function(a){if(!this._next){var b=new h(la(this.input),this.position.increment(a),this.userState);this._next=function(g,c,f){return f(a,b,c)}}return this._next};h.prototype.setInput=function(a){return new h(a,this.position,this.userState)};h.prototype.setPosition=function(a){return new h(this.input,a,this.userState)};h.prototype.setUserState=function(a){return new h(this.input,this.position,a)};t=function(a){this.message=a};t.prototype=Error();t.prototype.constructor=t;t.prototype.name="ParserError";
d=function(a,b){this.position=a;this._msg=b};d.prototype=Error();d.prototype.constructor=d;d.prototype.name="ParseError";d.prototype.toString=function(){return this.name+": "+this.message};Object.defineProperties(d.prototype,{message:{configurable:!0,get:function(){return"At position:"+this.position+" "+this.errorMessage}},errorMessage:{configurable:!0,get:function(){return void 0===this._msg?"":this._msg}}});l=function(a,b){d.call(this,a);this.errors=b||[]};l.prototype=new d;l.prototype.constructor=
l;l.prototype.name="MultipleError";Object.defineProperty(l.prototype,"errorMessage",{get:function(){return"["+ma(this.errors,function(a){return a.message}).join(", ")+"]"}});var E=function(a,b,g){d.call(this,a);this._pErr=b;this._qErr=g};E.prototype=new l;E.prototype.constructor=l;E.prototype.name="ChoiceError";Object.defineProperty(E.prototype,"errors",{get:function(){return[this._pErr].concat(this._qErr.errors)}});u=function(a){d.call(this,a)};u.prototype=new d;u.prototype.constructor=u;u.prototype.name=
"UnknownError";Object.defineProperty(u.prototype,"errorMessage",{value:"unknown error"});v=function(a,b){d.call(this,a);this.unexpected=b};v.prototype=new d;v.prototype.constructor=v;v.prototype.name="UnexpectError";Object.defineProperty(v.prototype,"errorMessage",{get:function(){return"Unexpected:"+this.unexpected}});r=function(a,b,g){d.call(this,a);this.expected=b;this.found=g};r.prototype=new d;r.prototype.constructor=r;r.prototype.name="ExpectError";Object.defineProperty(r.prototype,"errorMessage",
{get:function(){return"Expected:"+this.expected+(this.found?" Found:"+this.found:"")}});G=function(a){var b=a(function(){return b.apply(this,arguments)});return b};n=function(a,b){return b.hasOwnProperty("parserId")?n(a,function(){return b.apply(this,arguments)}):Object.defineProperties(b,{displayName:{value:a,writable:!1},parserId:{value:ga(),writable:!1}})};x=function(a){return function(b,g,c,f,i){return i(a,b,g)}};H=function(a){return function(b,g,c,f,i,e){return e(a,b,g)}};q=function(a,b){return function(g,
c,f,i,e,m){return p(a,[g,c,function(a,g,c){return p(b(a,g,c),[g,c,f,i,f,i])},i,function(a,g,c){return p(b(a,g,c),[g,c,f,i,e,m])},m])}};y=function(a){return function(b,g,c,f,i){b=a(b);return i(b,b,g)}};L=n("Get Parser State",y(function(a){return a}));A=function(a){return function(b,c,D,f,i){return i(a(b),b,c)}};M=function(a){return y(function(b){return b.setUserState(a(b.userState))})};da=n("Get State",A(function(a){return a.userState}));I=n("Get Position",A(function(a){return a.position}));ea=n("Get Input",
A(function(a){return a.input}));var ha=function(a){return q(I,function(b){return H(a(b))})};var oa=x(s),ca=n("EOF",q(L,function(a){return a.isEmpty()?oa:ha(function(b){return new r(b,"end of input",a.first())})}));N=function(a,b){return q(a,w(b))};var pa=function(a,b){return N(b,a)};O=function(a){return aa(a,pa)};z=function(a){return function(b,c){return function(D,f,i,e,m,na){var J=D.position;return p(b,[D,f,i,e,m,function(b,f,d){return p(c,[D,d,i,e,m,function(c,g,f){return na(a(J,b,c),D,f)}])}])}}};
P=z(function(a,b,c){return new l(a,[b,c])});var qa=z(function(a,b,c){return new E(a,b,c)}),ra=function(a,b){return qa(b,a)},sa=q(I,function(a){return H(new l(a,[]))});Q=function(a){if(!a.length)throw new t("choice called no parsers");return aa(a,ra,sa)};z=function(a,b){return P(b,x(a))};var ta=x(s),ua=z.bind(null,s);s=function(a){return function(b,c){return q(b,function(b){return q(c,function(c){return x(a(b,c))})})}};var va=function(a){return x(k.toArray(a))};R=function(a){return q(a,va)};B=s(k.cons);
s=s(k.append);var wa=function(a,b){return B(b,a)};S=function(a){return aa(a,wa,ta)};var ia,xa=new t("Many parser applied to a parser that accepts an empty string");ia=function(){throw xa;};T=function(a){var b=function(b,c,f,i,e,m){return p(a,[b,c,f,i,ia,m])};return G(function(a){return ua(B(b,a))})};var ya=function(a,b){return new v(a,null===b?"end of input":b)};U=function(a,b){var c=b||ya;return function(b,f,i,e,m,d){var J=b.position;if(b.isEmpty())return d(c(J,null),b,f);var h=b.first();return a(h)?
b.next(h)(b,f,i,e,m,d):d(c(J,h),b,f)}};fa=n("Any Token",U(w(!0)));V=function(a,b,c,e,f,i,d){return K(a(b,c,e,f,i,d))};C=function(a,b,c,d){return V(a,b,e.empty,c,d,c,d)};W=function(a,b,c,e,f){return C(a,new h(b,j.initial,c),e,f)};var za=function(a){return a},Aa=function(a){throw a;};X=function(a,b){return C(a,b,za,Aa)};Y=function(a,b,c){return X(a,new h(b,j.initial,c))};var Ba=w(w(!0)),Ca=w(w(!1));Z=function(a,b){return C(a,b,Ba,Ca)};$=function(a,b,c){return Z(a,new h(b,j.initial,c))};c.tail=p;c.trampoline=
K;c.ParserError=t;c.ParseError=d;c.MultipleError=l;c.UnknownError=u;c.UnexpectError=v;c.ExpectError=r;c.ParserState=h;c.Position=j;c.rec=G;c.Parser=n;c.RecParser=function(a,b){return n(a,G(b))};c.always=x;c.never=H;c.bind=q;c.eof=ca;c.extract=A;c.getParserState=L;c.setParserState=function(a){return y(w(a))};c.modifyParserState=y;c.getState=da;c.setState=function(a){return M(w(a))};c.modifyState=M;c.getInput=ea;c.setInput=function(a){return y(function(b){return b.setInput(a)})};c.getPosition=I;c.setPosition=
function(a){return y(function(b){return b.setPosition(a)})};c.fail=function(a){var b;var c=a?d:u;b=ha(function(b){return new c(b,a)});return b};c.attempt=function(a){return function(b,c,d,f,i,h){f=function(a,b,c){return h(a,b,e.popWindow(c))};return p(a,[b,e.pushWindow(c,b.position),function(a,b,c){return d(a,b,e.popWindow(c))},f,function(a,b,c){return i(a,b,e.popWindow(c))},f])}};c.lookahead=function(a){return function(b,c,e,f,d,h){return p(a,[b,c,function(a,c,g){return d(a,b,g)},f,d,h])}};c.next=
N;c.sequencea=O;c.sequence=function(){return O(ba.apply(null,arguments))};c.either=P;c.choicea=Q;c.choice=function(){return Q(ba.apply(null,arguments))};c.optional=z;c.expected=function(a,b){return function(c,e,f,d,h,m){return b(c,e,f,d,h,function(b,c,g){return m(new r(c.position,a),c,g)})}};c.eager=R;c.binds=function(a,b){return q(R(a),function(a){return b.apply(void 0,a)})};c.cons=B;c.append=s;c.enumerationa=S;c.enumeration=function(){return S(ba.apply(null,arguments))};c.many=T;c.many1=function(a){return B(a,
T(a))};c.token=U;c.anyToken=fa;c.memo=function(a){var b=a.parserId||ga();return function(c,d,f,h,l,m){var j=c.position,k={id:b,state:c},n=e.lookup(d,j,k);return n?p(n,[c,d,f,h,l,m]):p(a,[c,d,function(a,b,c){return f(a,b,e.update(c,j,k,function(c,d,e){return e(a,b,d)}))},function(a,b,c){return h(a,b,e.update(c,j,k,function(c,d,e,g){return g(a,b,d)}))},function(a,b,c){return l(a,b,e.update(c,j,k,function(c,d,e,g,f){return f(a,b,d)}))},function(a,b,c){return m(a,b,e.update(c,j,k,function(c,d,e,g,f,h){return h(a,
b,d)}))}])}};c.Memoer=e;c.exec=V;c.parseState=C;c.parseStream=W;c.parse=function(a,b,c,d,e){return W(a,k.from(b),c,d,e)};c.runState=X;c.runStream=Y;c.run=function(a,b,c){return Y(a,k.from(b),c)};c.testState=Z;c.testStream=$;c.test=function(a,b,c){return $(a,k.from(b),c)}});
