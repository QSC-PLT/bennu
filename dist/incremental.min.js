define(["require","exports","parse/parse","nu/stream"],function(F,g,f,i){var j,k,l,m,n,y=f.always,p=f.bind,r=f.getParserState,z=f.exec,A=f.Memoer,s=f.next,B=f.optional,t=f.ParserState,u=f.Position,v=f.runState,q=f.trampoline,w=i.end,C=i.isEmpty,D=i.rest,x=function(a,b,c){this.chunk=a;this.state=b;this.k=c},h=function(a,b,c,d){this.done=a;this.state=b;this.k=c;this.chunks=d};h.prototype.addChunk=function(a){return new h(this.done,this.state,this.k,this.chunks.concat(a))};h.prototype.hasChunk=function(a){return a<
this.chunks.length};h.prototype.getChunk=function(a){return this.chunks[a]};var e=function(a,b){this.chunk=a;this.state=b};Object.defineProperties(e,{input:{get:function(){return this.state.input}},position:{get:function(){return this.state.position}},userState:{get:function(){return this.state.userState}}});e.prototype.eq=function(a){return a&&a.chunk===this.chunk&&a.state.eq(a.state)};e.prototype.isEmpty=function(){return this.state.isEmpty()};e.prototype.first=function(){return this.state.first()};
e.prototype.next=function(a){if(!this._next){var b=this.chunk;if(C(D(this.state.input)))return p(s(this.state.next(a),r),function(c){return function(d,f,E){return new x(b+1,c,function(d){return E(a,new e(b+1,c.setInput(d)),f)})}});this._next=s(this.state.next(a),p(r,function(c){var d=new e(b,c);return function(c,b,e){return e(a,d,b)}}))}return this._next};e.prototype.setInput=function(a){return new e(this.chunk,this.state.setInput(a))};e.prototype.setPosition=function(a){return new e(this.chunk,this.state.setPosition(a))};
e.prototype.setUserState=function(a){return new e(this.chunk,this.state.setUserState(a))};j=function(a,b){if(a.done)return a;for(var c=a.addChunk(b),d=q(c.k(c.state.setInput(b)));d instanceof x;){if(!c.hasChunk(d.chunk))return new h(!1,d.state,function(a){return d.k(a.input)},c.chunks);d=q(d.k(c.getChunk(d.chunk)))}return d};k=function(a){return!a.done?k(q(a.k(a.state))):a.k(a.state)};l=function(a,b){return new h(!1,new e(0,b),function(b){var d=function(a,b){return new h(!0,b,function(){return a})},
e=function(a,b){return new h(!0,b,function(){throw a;})},b=z(a,b,A.empty,d,e,d,e);return b},[])};m=function(a,b){var c;var d=B(w,p(a,function(a,b,c){return y(i.memoStream(a,v.bind(null,d,b,c)))}));c=v(d,b);return c};n=function(a,b,c){return m(a,new t(b,u.initial,c))};g.provide=j;g.provideString=function(a,b){return j(a,i.from(b))};g.finish=k;g.parseState=l;g.parse=function(a,b){return l(a,new t(w,u.initial,b))};g.runManyState=m;g.runManyStream=n;g.runMany=function(a,b,c){return n(a,i.from(b),c)}});
