define(["require","exports","parse/parse","nu/stream"],function(H,e,f,i){var l,m,j,n,p,q,y=f.always,v=f.bind,z=f.getParserState,A=f.next,B=f.optional,C=f.parseState,r=f.ParserState,s=f.Position,w=f.runState,t=f.trampoline,k=i.end,x=i.from,D=i.isEmpty,E=i.memoStream,u=function(a,b){this.chunk=a;this.k=b},h=function(a,b,d){this.done=a;this.k=b;this.chunks=d};h.prototype.addChunk=function(a){return new h(this.done,this.k,this.chunks.concat(a))};h.prototype.hasChunk=function(a){return a<this.chunks.length};
h.prototype.getChunk=function(a){return this.chunks[a]};var g=function(a,b){this.chunk=a;this.state=b};Object.defineProperties(g.prototype,{input:{get:function(){return this.state.input}},position:{get:function(){return this.state.position}},userState:{get:function(){return this.state.userState}}});g.prototype.eq=function(a){return a&&a.chunk===this.chunk&&a.state.eq(a.state)};g.prototype.isEmpty=function(){return this.state.isEmpty()};g.prototype.first=function(){return this.state.first()};g.prototype.next=
function(a){if(!this._next){var b=this.chunk;this._next=A(this.state.next(a),v(z,function(d){var c;if(d.isEmpty())c=function(c,e,f){return new u(b+1,function(c){return f(a,new g(b+1,d.setInput(c)),e)})};else{var e=new g(b,d);c=function(b,c,d){return d(a,e,c)}}return c}))}return this._next};g.prototype.setInput=function(a){return new g(this.chunk,this.state.setInput(a))};g.prototype.setPosition=function(a){return new g(this.chunk,this.state.setPosition(a))};g.prototype.setUserState=function(a){return new g(this.chunk,
this.state.setUserState(a))};l=function(a,b){if(a.done||D(b))return a;for(var d=a.addChunk(b),c=t(d.k(b));c instanceof u&&d.hasChunk(c.chunk);)c=t(c.k(d.getChunk(c.chunk)));return c instanceof u?new h(!1,c.k,d.chunks):c};m=function(a){return m(t(a.done?a.k():a.k(k)))};j=function(a,b,d,c){var e;var f=function(a,b){return new h(!0,d.bind(null,a,b))},i=function(a,b){return new h(!0,c.bind(null,a,b))};e=b.isEmpty()?new h(!1,function(c){return C(a,new g(0,b.setInput(c)),f,i)},[]):l(j(a,b.setInput(k),d,
c),b.input);return e};var F=function(a){return a},G=function(a){throw a;};n=function(a,b){return j(a,b,F,G)};p=function(a,b){var d;var c=B(k,v(a,function(a,b,d){return y(E(a,w.bind(null,c,b,d)))}));d=w(c,b);return d};q=function(a,b,d){return p(a,new r(b,s.initial,d))};e.provide=l;e.provideString=function(a,b){return l(a,x(b))};e.finish=m;e.parseIncState=j;e.parseInc=function(a,b,d,c){return j(a,new r(k,s.initial,b),d,c)};e.runIncState=n;e.runInc=function(a,b){return n(a,new r(k,s.initial,b))};e.runManyState=
p;e.runManyStream=q;e.runMany=function(a,b,d){return q(a,x(b),d)}});
