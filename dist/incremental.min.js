define(["require","exports","parse/parse","nu/stream"],function(G,f,g,h){var l,m,j,n,p,q,z=g.always,r=g.bind,v=g.getParserState,w=g.next,A=g.optional,B=g.parseState,s=g.ParserState,t=g.Position,x=g.runState,u=g.trampoline,k=h.end,C=h.isEmpty,D=h.rest,y=function(a,b,c){this.chunk=a;this.state=b;this.k=c},i=function(a,b,c){this.done=a;this.k=b;this.chunks=c};i.prototype.addChunk=function(a){return new i(this.done,this.k,this.chunks.concat(a))};i.prototype.hasChunk=function(a){return a<this.chunks.length};
i.prototype.getChunk=function(a){return this.chunks[a]};var e=function(a,b){this.chunk=a;this.state=b};Object.defineProperties(e,{input:{get:function(){return this.state.input}},position:{get:function(){return this.state.position}},userState:{get:function(){return this.state.userState}}});e.prototype.eq=function(a){return a&&a.chunk===this.chunk&&a.state.eq(a.state)};e.prototype.isEmpty=function(){return this.state.isEmpty()};e.prototype.first=function(){return this.state.first()};e.prototype.next=
function(a){if(!this._next){var b=this.chunk;this._next=C(D(this.state.input))?w(this.state.next(a),r(v,function(c){return function(d,f,g){return new y(b+1,c,function(d){return g(a,new e(b+1,c.setInput(d)),f)})}})):w(this.state.next(a),r(v,function(c){var d=new e(b,c);return function(b,c,e){return e(a,d,c)}}))}return this._next};e.prototype.setInput=function(a){return new e(this.chunk,this.state.setInput(a))};e.prototype.setPosition=function(a){return new e(this.chunk,this.state.setPosition(a))};
e.prototype.setUserState=function(a){return new e(this.chunk,this.state.setUserState(a))};l=function(a,b){if(a.done)return a;for(var c=a.addChunk(b),d=u(c.k(b));d instanceof y;){if(!c.hasChunk(d.chunk))return new i(!1,function(a){return d.k(a)},c.chunks);d=u(d.k(c.getChunk(d.chunk)))}return d};m=function(a){return a.done?a.k():m(u(a.k(k)))};j=function(a,b,c,d){var f;var g=function(a,b){return new i(!0,c.bind(null,a,b))},h=function(a,b){return new i(!0,d.bind(null,a,b))};f=b.isEmpty()?new i(!1,function(c){return B(a,
new e(0,b.setInput(c)),g,h)},[]):l(j(a,b.setInput(k),c,d),b.input);return f};var E=function(a){return a},F=function(a){throw a;};n=function(a,b){return j(a,b,E,F)};p=function(a,b){var c;var d=A(k,r(a,function(a,b,c){return z(h.memoStream(a,x.bind(null,d,b,c)))}));c=x(d,b);return c};q=function(a,b,c){return p(a,new s(b,t.initial,c))};f.provide=l;f.provideString=function(a,b){return l(a,h.from(b))};f.finish=m;f.parseIncState=j;f.parseInc=function(a,b,c,d){return j(a,new s(k,t.initial,b),c,d)};f.runIncState=
n;f.runInc=function(a,b){return n(a,new s(k,t.initial,b))};f.runManyState=p;f.runManyStream=q;f.runMany=function(a,b,c){return q(a,h.from(b),c)}});
