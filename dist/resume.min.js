define(["require","exports","parse/parse","nu/stream"],function(x,g,i,h){var j,k,l,r=i.exec,s=i.Memoer,t=i.Position,u=h.end,p=h.isEmpty,v=h.first,m=h.rest,n=function(a){for(;a&&a._next;)a=a[0].apply(void 0,a[1]);return a},q=function(a,e,d){this.chunk=a;this.state=e;this.k=d},f=function(a,e,d,c,b){this.done=a;this.chunk=e;this.state=d;this.k=c;this.chunks=b};f.prototype.addChunk=function(a){return new f(this.done,this.chunk+1,this.state,this.k,this.chunks.concat(a))};var b=function(a,e,d,c){this.input=
a;this.chunk=e;this.position=d;this.userState=c};b.prototype.eq=function(a){return a&&this.input===a.input&&this.userState===a.userState};b.prototype.isEmpty=function(){return p(this.input)};b.prototype.first=function(){return v(this.input)};b.prototype.next=function(a){if(!this._next){var e=this.chunk,d=new b(m(this.input),e,this.position.increment(a),this.userState);if(p(m(this.input))){var c=new b(m(this.input),e+1,this.position.increment(a),this.userState);return function(d,b,w){return new q(e+
1,c,function(d){return w(a,d,b)})}}this._next=function(e,c,b){return b(a,d,c)}}return this._next};b.prototype.setInput=function(a){return new b(a,this.chunk,this.position,this.userState)};b.prototype.setPosition=function(a){return new b(this.input,this.chunk,a,this.userState)};b.prototype.setUserState=function(a){return new b(this.input,this.chunk,this.position,a)};j=function(a,b){if(a.done)return a;for(var d=a.addChunk(b),c=n(d.k(d.state.setInput(b)));c instanceof q;){if(c.chunk>=d.chunks.length)return new f(!1,
d.chunk,c.state,c.k,d.chunks);c=n(c.k(c.state.setInput(d.chunks[c.chunk])))}return c};k=function(a){return!a.done?k(n(a.k(a.state))):a.k(a.state)};l=function(a,b){return new f(!1,0,b,function(b){var c=function(a,b){return new f(!0,-1,b,function(){return a})},e=function(a,b){return new f(!0,-1,b,function(){throw a;})},b=r(a,b,s.empty,c,e,c,e);return b},[])};g.provide=j;g.provideString=function(a,b){return j(a,h.from(b))};g.finish=k;g.parseState=l;g.parse=function(a,e){return l(a,new b(u,0,t.initial,
e))}});
