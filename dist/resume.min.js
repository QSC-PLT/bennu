define(["require","exports","parse/parse","nu/stream"],function(A,h,f,i){var j,k,l,n=f.bind,p=f.getParserState,s=f.exec,t=f.Memoer,q=f.next,u=f.ParserState,v=f.Position,w=i.end,x=i.isEmpty,y=i.rest,m=function(a){for(;a&&a._next;)a=a[0].apply(void 0,a[1]);return a},r=function(a,b,c){this.chunk=a;this.state=b;this.k=c},g=function(a,b,c,e,d){this.done=a;this.chunk=b;this.state=c;this.k=e;this.chunks=d};g.prototype.addChunk=function(a){return new g(this.done,this.chunk+1,this.state,this.k,this.chunks.concat(a))};
var d=function(a,b){this.chunk=a;this.state=b};Object.defineProperties(d,{input:{get:function(){return this.state.input}},position:{get:function(){return this.state.position}},userState:{get:function(){return this.state.userState}}});d.prototype.eq=function(a){return a&&a.chunk===this.chunk&&a.state.eq(a.state)};d.prototype.isEmpty=function(){return this.state.isEmpty()};d.prototype.first=function(){return this.state.first()};d.prototype.next=function(a){if(!this._next){var b=this.chunk;if(x(y(this.state.input)))return n(q(this.state.next(a),
p),function(c){return function(e,z,f){return new r(b+1,c,function(e){return f(a,new d(b+1,c.setInput(e)),z)})}});this._next=n(q(this.state.next(a),p),function(c){return function(e,f,g){return g(a,new d(b,c),f)}})}return this._next};d.prototype.setInput=function(a){return new d(this.chunk,this.state.setInput(a))};d.prototype.setPosition=function(a){return new d(this.chunk,this.state.setPosition(a))};d.prototype.setUserState=function(a){return new d(this.chunk,this.state.setUserState(a))};j=function(a,
b){if(a.done)return a;for(var c=a.addChunk(b),e=m(c.k(c.state.setInput(b)));e instanceof r;){if(e.chunk>=c.chunks.length)return new g(!1,c.chunk,e.state,function(a){return e.k(a.input)},c.chunks);e=m(e.k(c.chunks[e.chunk]))}return e};k=function(a){return!a.done?k(m(a.k(a.state))):a.k(a.state)};l=function(a,b){return new g(!1,0,new d(0,b),function(c){var b=function(a,b){return new g(!0,-1,b,function(){return a})},d=function(a,b){return new g(!0,-1,b,function(){throw a;})},c=s(a,c,t.empty,b,d,b,d);
return c},[])};h.provide=j;h.provideString=function(a,b){return j(a,i.from(b))};h.finish=k;h.parseState=l;h.parse=function(a,b){return l(a,new u(w,v.initial,b))}});
