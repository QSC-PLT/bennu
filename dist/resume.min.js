define(["require","exports","parse/parse","nu/stream"],function(A,h,e,i){var j,k,l,n=e.bind,p=e.getParserState,s=e.exec,t=e.Memoer,q=e.next,u=e.ParserState,v=e.Position,w=i.end,x=i.isEmpty,y=i.rest,m=function(a){for(;a&&a._next;)a=a[0].apply(void 0,a[1]);return a},r=function(a,c,d){this.chunk=a;this.state=c;this.k=d},g=function(a,c,d,f,b){this.done=a;this.chunk=c;this.state=d;this.k=f;this.chunks=b};g.prototype.addChunk=function(a){return new g(this.done,this.chunk+1,this.state,this.k,this.chunks.concat(a))};
var b=function(a,c){this.chunk=a;this.state=c};Object.defineProperties(b,{input:{get:function(){return this.state.input}},position:{get:function(){return this.state.position}},userState:{get:function(){return this.state.userState}}});b.prototype.eq=function(a){return a&&a.chunk===this.chunk&&a.state.eq(a.state)};b.prototype.isEmpty=function(){return this.state.isEmpty()};b.prototype.first=function(){return this.state.first()};b.prototype.next=function(a){if(!this._next){var c=this.chunk;if(x(y(this.state.input)))return n(q(this.state.next(a),
p),function(d){return function(f,e,z){return new r(c+1,d,function(f){return z(a,new b(c+1,d.setInput(f)),e)})}});this._next=q(this.state.next(a),n(p,function(d){var f=new b(c,d);return function(d,c,b){return b(a,f,c)}}))}return this._next};b.prototype.setInput=function(a){return new b(this.chunk,this.state.setInput(a))};b.prototype.setPosition=function(a){return new b(this.chunk,this.state.setPosition(a))};b.prototype.setUserState=function(a){return new b(this.chunk,this.state.setUserState(a))};j=
function(a,c){if(a.done)return a;for(var d=a.addChunk(c),b=m(d.k(d.state.setInput(c)));b instanceof r;){if(b.chunk>=d.chunks.length)return new g(!1,d.chunk,b.state,function(a){return b.k(a.input)},d.chunks);b=m(b.k(d.chunks[b.chunk]))}return b};k=function(a){return!a.done?k(m(a.k(a.state))):a.k(a.state)};l=function(a,c){return new g(!1,0,new b(0,c),function(b){var c=function(a,b){return new g(!0,-1,b,function(){return a})},e=function(a,b){return new g(!0,-1,b,function(){throw a;})},b=s(a,b,t.empty,
c,e,c,e);return b},[])};h.provide=j;h.provideString=function(a,b){return j(a,i.from(b))};h.finish=k;h.parseState=l;h.parse=function(a,b){return l(a,new u(w,v.initial,b))}});
